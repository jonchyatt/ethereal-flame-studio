# Plan 03-12: Local Render CLI Tool

**Phase:** 3 - Rendering Pipeline
**Created:** 2026-01-30
**Status:** MOSTLY COMPLETE

---

## Goal

Create a portable CLI tool for local video rendering that bypasses Redis/queue overhead, works directly with files on disk, and can optionally run from a thumb drive on any Windows PC with a GPU.

---

## Problem Statement

The current rendering pipeline (Phase 3/4) was designed for scale:
- API → Redis Queue → Worker Process → Puppeteer → FFmpeg
- Requires Redis running, worker process, status polling
- Job state stored in memory (resets on restart)
- Complex for simple local use case

Users need a simpler option:
- Preview in browser, export settings, render locally
- No Redis, no queue, no API calls
- Direct file paths, instant feedback
- Portable enough to run from thumb drive

---

## Architecture

```
┌─────────────────────────────────────┐
│  Web UI (localhost:3000)            │
│  - Load audio, tweak settings       │
│  - Live preview                     │
│  - Click "Export Config"            │
└──────────────┬──────────────────────┘
               │ (saves render-config.json)
               ▼
┌─────────────────────────────────────┐
│  CLI Tool (render-cli.ts)           │
│  - Reads config file                │
│  - Direct Puppeteer render          │
│  - FFmpeg encode                    │
│  - Progress in terminal             │
└─────────────────────────────────────┘
               │
               ▼
           output.mp4
```

---

## Config File Schema

```typescript
interface RenderConfig {
  version: "1.0";

  audio: {
    path: string;  // Absolute or relative to config file
  };

  output: {
    path: string;
    format: "flat-1080p-landscape" | "flat-1080p-portrait" | "flat-4k-landscape" | ...;
    fps: 30 | 60;
  };

  visual: {
    mode: "flame" | "mist";
    skyboxPreset: string;
    skyboxRotationSpeed: number;
    waterEnabled: boolean;
    waterColor: string;
    waterReflectivity: number;
    layers: ParticleLayerConfig[];
  };

  options?: {
    quality?: "fast" | "balanced" | "quality";
    startFrame?: number;  // Resume support
    endFrame?: number;    // Partial render
  };
}
```

---

## Implementation Tasks

### Task 1: Config Types and Validation
- [x] Create `src/lib/render/renderConfig.ts`
- [x] Define RenderConfig TypeScript interface
- [x] Add Zod validation schema
- [x] Add helper functions (createConfigFromState, getResolution)

### Task 2: CLI Entry Point
- [x] Create `scripts/render-cli.ts`
- [x] Parse command line arguments (--config, --audio, --output)
- [x] Load and validate config file
- [x] Display progress in terminal
- [x] Handle Ctrl+C gracefully (save checkpoint)

### Task 3: LocalRenderer Class
- [x] Create `src/lib/render/LocalRenderer.ts` - Not needed - renderVideo.ts serves this purpose
- [x] Simplified render flow (no queue)
- [x] Direct Puppeteer + FFmpeg calls
- [x] Progress callbacks for terminal display
- [x] Checkpoint/resume support

### Task 4: Export Config Button (UI)
- [x] Add "Export Config" button to RenderDialog
- [x] Serialize visualStore to config JSON
- [x] Save as file or copy to clipboard
- [x] Show CLI command to run

### Task 5: Auto-Launch (Optional)
- [x] Detect local environment
- [x] Spawn CLI as child process
- [ ] Pipe progress back to UI

### Task 6: Portable Package (Future)
- [ ] Bundle with pkg/nexe
- [ ] Include portable Chrome (~300MB)
- [ ] Include FFmpeg static (~80MB)
- [ ] Create Windows installer/zip

---

## CLI Usage

```bash
# Basic usage with config file
npx tsx scripts/render-cli.ts --config render-job.json

# Override audio/output paths
npx tsx scripts/render-cli.ts --config render-job.json \
  --audio "C:/music/song.mp3" \
  --output "C:/renders/output.mp4"

# npm script shortcut
npm run render:local -- --config render-job.json

# Future portable version
./ethereal-render.exe --config render-job.json
```

---

## Progress Display

```
╔══════════════════════════════════════════════════════╗
║  Ethereal Flame Renderer v1.0                        ║
╚══════════════════════════════════════════════════════╝

Audio:   PhonkShia.mp3 (3:24)
Output:  C:/renders/PhonkShia_1080p.mp4
Format:  1080p Landscape @ 30fps
Mode:    Ethereal Flame

[1/4] Converting audio to WAV...     ✓ (2.1s)
[2/4] Analyzing audio...             ✓ (1.3s)
[3/4] Rendering frames...            ████████░░░░░░░░ 52%
      Frame 2700/5100 | 45 fps | ETA: 53s
[4/4] Encoding video...              waiting

Press Ctrl+C to pause (progress saved for resume)
```

---

## Portability Requirements

For thumb drive deployment:

| Component | Size | Bundled? |
|-----------|------|----------|
| Node.js portable | ~50MB | Yes |
| Chromium portable | ~300MB | Yes |
| FFmpeg static | ~80MB | Yes |
| App code + deps | ~200MB | Yes |
| **Total** | **~630MB** | Fits any USB |

Environment variables for portable mode:
```bash
PUPPETEER_EXECUTABLE_PATH=./chrome-portable/chrome.exe
FFMPEG_PATH=./ffmpeg/ffmpeg.exe
```

---

## Success Criteria

1. User exports config from web UI, runs CLI, gets video matching preview
2. No Redis or worker process required
3. Progress displays clearly in terminal
4. Ctrl+C saves checkpoint, can resume later
5. Works on any Windows PC with GPU (portable version)

---

## Dependencies

- Phase 3 rendering pipeline (PuppeteerRenderer, FFmpegEncoder)
- Existing PreAnalyzer for audio analysis
- Zod for config validation

---

## Files Created/Modified

**New Files:**
- `src/lib/render/renderConfig.ts` ✓
- `scripts/render-cli.ts`
- `src/lib/render/LocalRenderer.ts`

**Modified Files:**
- `src/components/ui/RenderDialog.tsx` (add Export Config button)
- `package.json` (add render:local script)

---

## Notes

This plan addresses the gap between "works in browser preview" and "actual video file" without the complexity of the full queue-based pipeline. It's designed for:

1. **Solo developers** who just want to render locally
2. **Testing** the render pipeline without infrastructure
3. **Portable rendering** on any machine with GPU
4. **Foundation** for future distributed rendering (each worker runs this CLI)

**2026-02-06 Update:** CLI, config export, and dev server auto-start implemented. Visual config injection added to pass full settings from config file to browser via Puppeteer. This enables the render CLI to perfectly replicate the preview state seen in the web UI, including all skybox, camera, particle, and audio reactivity settings.
