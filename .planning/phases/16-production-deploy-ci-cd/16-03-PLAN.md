---
phase: 16-production-deploy-ci-cd
plan: 03
type: execute
wave: 2
depends_on:
  - 16-01
files_modified:
  - .github/workflows/deploy.yml
autonomous: true
requirements:
  - DEPLOY-04

must_haves:
  truths:
    - "Pushing to main branch triggers a GitHub Actions workflow that deploys the web app to Vercel"
    - "The same workflow triggers a Render.com worker deploy via deploy hook"
    - "The workflow runs only on pushes to main (not on PRs or other branches)"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline for Vercel + Render deployment"
      contains: "vercel"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "Vercel"
      via: "vercel CLI deploy --prod"
      pattern: "vercel.*--prod"
    - from: ".github/workflows/deploy.yml"
      to: "Render.com"
      via: "deploy hook curl"
      pattern: "RENDER_DEPLOY_HOOK_URL"
---

<objective>
Create a GitHub Actions workflow that auto-deploys the web app to Vercel and triggers a Render.com worker deploy on push to main.

Purpose: DEPLOY-04 requires automated deployment on push. This eliminates manual `vercel --prod` and manual Render deploys.

Output: .github/workflows/deploy.yml
</objective>

<execution_context>
@C:/Users/jonch/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jonch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@worker/Dockerfile
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` with two jobs running in parallel:

**Trigger:** `push` to `main` branch only.

**Job 1: deploy-web** (Vercel)
- Runs on: `ubuntu-latest`
- Steps:
  1. Checkout code
  2. Install Node.js 20
  3. Install Vercel CLI: `npm install -g vercel`
  4. Pull Vercel env: `vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}`
  5. Build: `vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}`
  6. Deploy: `vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}`
- Environment variables needed as GitHub secrets:
  - `VERCEL_TOKEN` — Personal access token from Vercel dashboard
  - `VERCEL_ORG_ID` — From `.vercel/project.json` or Vercel dashboard
  - `VERCEL_PROJECT_ID` — From `.vercel/project.json` or Vercel dashboard
- Set VERCEL_ORG_ID and VERCEL_PROJECT_ID as env vars in the job (not secrets for the CLI):
  ```yaml
  env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  ```

**Job 2: deploy-worker** (Render.com)
- Runs on: `ubuntu-latest`
- Steps:
  1. Trigger Render deploy hook via curl:
     ```yaml
     - name: Trigger Render deploy
       run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
     ```
- Environment variable needed as GitHub secret:
  - `RENDER_DEPLOY_HOOK_URL` — Deploy hook URL from Render dashboard (Settings > Deploy Hook)

Both jobs run in parallel (no `needs` dependency between them). Both jobs should have `concurrency` set to prevent overlapping deploys:
```yaml
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false
```

The workflow should NOT include test/lint steps (keep it deployment-focused; testing is separate).

Also create the `.github/workflows/` directory structure.
  </action>
  <verify>
Validate the YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` or similar. Confirm the file references the correct secrets names and has both jobs defined.
  </verify>
  <done>
.github/workflows/deploy.yml exists with two parallel jobs: deploy-web (Vercel CLI) and deploy-worker (Render deploy hook). Triggered only on push to main.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document required GitHub secrets in deploy checklist</name>
  <files>docs/DEPLOY_PROD_CHECKLIST.md</files>
  <action>
Add a new section "## 8. GitHub Actions CI/CD" to the end of docs/DEPLOY_PROD_CHECKLIST.md (before Troubleshooting if it exists, or as a new final section). This section must cover:

1. **Required GitHub Secrets** — Add these in GitHub repo > Settings > Secrets and variables > Actions:
   - `VERCEL_TOKEN` — Create at vercel.com/account/tokens (full access scope)
   - `VERCEL_ORG_ID` — Find in `.vercel/project.json` after running `vercel link`, or in Vercel dashboard under team settings
   - `VERCEL_PROJECT_ID` — Find in `.vercel/project.json` after running `vercel link`
   - `RENDER_DEPLOY_HOOK_URL` — Create in Render dashboard > Worker service > Settings > Deploy Hook

2. **How it works:**
   - Push to `main` triggers both deploys in parallel
   - Vercel: builds and deploys the Next.js web app
   - Render: triggers Docker rebuild of the worker from `worker/Dockerfile`

3. **Verify:**
   - Push a commit to main
   - Check GitHub Actions tab for green workflow run
   - Verify Vercel deployment in Vercel dashboard
   - Verify Render deployment in Render dashboard

Also add a note to the Render.com section (section 5) mentioning that after initial manual setup, subsequent deploys are automated via GitHub Actions (section 8).
  </action>
  <verify>
Read docs/DEPLOY_PROD_CHECKLIST.md and confirm: (1) Section 8 exists with GitHub Actions instructions. (2) All 4 GitHub secrets are documented with where to find them. (3) Cross-reference to section 5 (Render) is present.
  </verify>
  <done>
Deploy checklist includes GitHub Actions CI/CD setup instructions with all required secrets documented and verification steps.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists and is valid YAML
2. Workflow triggers only on push to main
3. Two parallel jobs: deploy-web (Vercel) and deploy-worker (Render)
4. All required GitHub secrets are documented in the checklist
5. No hardcoded secrets in the workflow file
</verification>

<success_criteria>
- DEPLOY-04 satisfied: Pushing to main triggers GitHub Actions that deploy web to Vercel and worker to Render automatically
- Workflow uses only GitHub Secrets for credentials (no hardcoded values)
- Deploy checklist documents how to set up the required GitHub secrets
</success_criteria>

<output>
After completion, create `.planning/phases/16-production-deploy-ci-cd/16-03-SUMMARY.md`
</output>
