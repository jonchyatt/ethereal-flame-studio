---
phase: 16-production-deploy-ci-cd
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/DEPLOY_PROD_CHECKLIST.md
autonomous: true
requirements:
  - DEPLOY-03

must_haves:
  truths:
    - "A new operator can provision the full stack (R2, Turso, Render, Modal, Vercel) from scratch using only the checklist"
    - "The checklist lists every required environment variable per service"
    - "The checklist covers verification steps (not just setup) for each service"
  artifacts:
    - path: "docs/DEPLOY_PROD_CHECKLIST.md"
      provides: "Step-by-step production deployment guide"
      contains: "Cloudflare R2"
  key_links:
    - from: "docs/DEPLOY_PROD_CHECKLIST.md"
      to: ".env.example"
      via: "variable name references"
      pattern: "STORAGE_BACKEND|TURSO_DATABASE_URL|MODAL_ENDPOINT_URL"
---

<objective>
Create a comprehensive production deployment checklist at docs/DEPLOY_PROD_CHECKLIST.md that walks through provisioning every cloud service from scratch.

Purpose: DEPLOY-03 requires a checklist covering R2, Turso, Render, Modal, and Vercel provisioning. This is the single document an operator follows to go from zero to running production.

Output: docs/DEPLOY_PROD_CHECKLIST.md
</objective>

<execution_context>
@C:/Users/jonch/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jonch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.env.example
@worker/Dockerfile
@src/lib/storage/index.ts
@src/lib/jobs/index.ts
@src/lib/render/modalClient.ts
@worker/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production deployment checklist</name>
  <files>docs/DEPLOY_PROD_CHECKLIST.md</files>
  <action>
Create `docs/DEPLOY_PROD_CHECKLIST.md` with the following structure. Each section must have: prerequisites, step-by-step commands/UI instructions, env vars produced, and a verification step.

**Document structure:**

# Production Deployment Checklist

Brief intro: This checklist provisions the full Ethereal Flame Studio cloud stack. Follow sections in order. Each section produces environment variables needed by subsequent sections.

**Architecture overview** (brief text):
- Vercel: Web app + API routes (Next.js)
- Render.com: Background CPU worker (Node.js + ffmpeg + yt-dlp)
- Turso: Job state database (SQLite-compatible cloud)
- Cloudflare R2: Asset and video storage (S3-compatible)
- Modal: GPU render compute

## Prerequisites
- Node.js 20+
- GitHub account with repo access
- Accounts on: Cloudflare, Turso, Render.com, Modal, Vercel
- CLI tools: `turso`, `vercel`, `modal` (install commands provided)

## 1. Cloudflare R2 Bucket
- Log into Cloudflare Dashboard > R2
- Create bucket named `ethereal-flame-studio`
- Go to R2 > Manage R2 API Tokens > Create API token
- Scope: Object Read & Write, specific bucket
- Record: R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME
- CORS: Not needed (signed URLs, no browser-direct access)
- Verify: `aws s3 ls s3://ethereal-flame-studio --endpoint-url https://<account-id>.r2.cloudflarestorage.com` (using AWS CLI with R2 credentials)

## 2. Turso Database
- `turso auth login`
- `turso db create ethereal-flame-studio`
- `turso db show ethereal-flame-studio --url` -> TURSO_DATABASE_URL
- `turso db tokens create ethereal-flame-studio` -> TURSO_AUTH_TOKEN
- Schema is auto-created by the app on first connection (Drizzle migrations)
- Verify: `turso db shell ethereal-flame-studio "SELECT 1"`

## 3. Modal GPU Endpoint
- `modal setup` (authenticate)
- Deploy the Modal app (reference existing modal_app/ directory if it exists, or note it's deployed separately)
- Record: MODAL_ENDPOINT_URL, MODAL_AUTH_TOKEN
- MODAL_STATUS_URL is optional (auto-derived from endpoint URL)
- Verify: `curl -X POST $MODAL_ENDPOINT_URL -H "Content-Type: application/json" -d '{"auth_token":"...","config":{},"job_id":"test"}'` returns a response (even if error, confirms endpoint is reachable)

## 4. Vercel Project
- `vercel link` (link to existing project or create new)
- Add environment variables via `vercel env add` or Vercel Dashboard > Settings > Environment Variables:
  - DEPLOY_ENV=production
  - STORAGE_BACKEND=r2 (optional, DEPLOY_ENV handles this)
  - R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME
  - JOB_STORE_BACKEND=turso (optional, DEPLOY_ENV handles this)
  - TURSO_DATABASE_URL, TURSO_AUTH_TOKEN
  - MODAL_ENDPOINT_URL, MODAL_AUTH_TOKEN
  - INTERNAL_WEBHOOK_SECRET (generate: `openssl rand -hex 32`)
  - NEXT_PUBLIC_APP_URL (set after first deploy, or use Vercel's auto-assigned URL)
- Deploy: `vercel --prod`
- Verify: Visit the production URL, confirm app loads

## 5. Render.com Worker
- Create new Background Worker service
- Connect GitHub repo
- Settings:
  - Build Command: (use Dockerfile at `worker/Dockerfile`)
  - Docker context: root directory
  - Dockerfile path: `worker/Dockerfile`
  - Instance type: Starter ($7/mo)
- Environment variables:
  - TURSO_DATABASE_URL (same as Vercel)
  - TURSO_AUTH_TOKEN (same as Vercel)
  - STORAGE_BACKEND=r2
  - R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME (same as Vercel)
  - INTERNAL_WEBHOOK_SECRET (same as Vercel)
  - NEXT_PUBLIC_APP_URL (Vercel production URL)
  - MODAL_ENDPOINT_URL, MODAL_AUTH_TOKEN (same as Vercel)
- Deploy: Trigger manual deploy or push to branch
- Verify: Check Render logs for "[Worker] Started, polling every 3000ms"

## 6. Generate Webhook Secret
- `openssl rand -hex 32`
- Set INTERNAL_WEBHOOK_SECRET in BOTH Vercel and Render env vars (must match)
- This secret authenticates worker->app and Modal->app webhook callbacks

## 7. End-to-End Verification
Step-by-step smoke test:
1. Open production URL
2. Upload a short audio file (< 1MB)
3. Verify upload completes (stored in R2)
4. Check Render worker logs for job pickup
5. Verify job completes and audio is playable
6. (Optional) Trigger a render job and verify Modal dispatch

## Troubleshooting
Common issues and fixes:
- Worker not picking up jobs -> Check TURSO_DATABASE_URL matches between Vercel and Render
- 401 on webhook -> INTERNAL_WEBHOOK_SECRET mismatch between services
- Storage errors -> Verify R2 credentials and bucket name
- Modal dispatch fails -> Check MODAL_ENDPOINT_URL and MODAL_AUTH_TOKEN
  </action>
  <verify>
Read the file and confirm: (1) All 5 services (R2, Turso, Modal, Vercel, Render) have dedicated sections. (2) Each section lists the env vars it produces. (3) Each section has a verification step. (4) The end-to-end verification section exists.
  </verify>
  <done>
docs/DEPLOY_PROD_CHECKLIST.md exists and covers provisioning all 5 cloud services with step-by-step instructions, env var lists, and verification steps.
  </done>
</task>

</tasks>

<verification>
1. docs/DEPLOY_PROD_CHECKLIST.md exists and is well-structured
2. Every cloud service (R2, Turso, Render, Modal, Vercel) has a dedicated section
3. Every env var from .env.example's v2.0 sections is referenced somewhere in the checklist
4. Verification steps are actionable (CLI commands or observable behaviors)
</verification>

<success_criteria>
- DEPLOY-03 satisfied: Checklist covers provisioning R2, Turso, Render, Modal, and Vercel from scratch
- An operator with no prior knowledge of the stack can follow the checklist to deploy
</success_criteria>

<output>
After completion, create `.planning/phases/16-production-deploy-ci-cd/16-02-SUMMARY.md`
</output>
