---
phase: 04-automation
plan: 06
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/lib/services/googleDrive.ts
  - src/lib/queue/postProcessor.ts
autonomous: true
user_setup:
  - service: rclone
    why: "Google Drive sync for render output"
    env_vars:
      - name: GDRIVE_REMOTE
        source: "Name of rclone remote (e.g., 'gdrive')"
      - name: GDRIVE_OUTPUT_FOLDER
        source: "Path in Google Drive (e.g., 'EtherealFlame/Renders')"
    dashboard_config:
      - task: "Run 'rclone config' to set up Google Drive remote"
        location: "Follow prompts for OAuth authentication"
      - task: "Create service account for unattended operation (optional)"
        location: "Google Cloud Console > IAM > Service Accounts"

must_haves:
  truths:
    - "Completed renders sync to Google Drive automatically"
    - "Google Drive URL stored in metadata database"
    - "Sync happens after render complete, doesn't block queue"
  artifacts:
    - path: "src/lib/services/googleDrive.ts"
      provides: "rclone-based Google Drive sync"
      exports: ["syncToGoogleDrive", "getGoogleDriveUrl"]
  key_links:
    - from: "src/lib/services/googleDrive.ts"
      to: "rclone CLI"
      via: "spawn process"
      pattern: "spawn.*rclone"
    - from: "src/lib/queue/postProcessor.ts"
      to: "src/lib/services/googleDrive.ts"
      via: "sync call"
      pattern: "syncToGoogleDrive"
---

<objective>
Implement Google Drive integration for automatic render output delivery.

Purpose: Completed renders automatically sync to Google Drive so users can access their videos from anywhere. Uses rclone for reliable, resumable uploads.

Output: Google Drive sync service, integrated into post-processing pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-automation/04-RESEARCH.md
@.planning/phases/04-automation/04-03-SUMMARY.md (when exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rclone-based Google Drive sync service</name>
  <files>src/lib/services/googleDrive.ts</files>
  <action>
Create `src/lib/services/googleDrive.ts`:

```typescript
import { spawn } from 'child_process';
import { basename } from 'path';

const GDRIVE_REMOTE = process.env.GDRIVE_REMOTE || 'gdrive';
const GDRIVE_OUTPUT_FOLDER = process.env.GDRIVE_OUTPUT_FOLDER || 'EtherealFlame/Renders';

export interface SyncResult {
  success: boolean;
  remotePath: string;
  bytesTransferred?: number;
  error?: string;
}

export async function checkRcloneInstalled(): Promise<boolean> {
  return new Promise((resolve) => {
    const proc = spawn('rclone', ['version']);
    proc.on('close', (code) => resolve(code === 0));
    proc.on('error', () => resolve(false));
  });
}

export async function checkRemoteConfigured(): Promise<boolean> {
  return new Promise((resolve) => {
    const proc = spawn('rclone', ['listremotes']);
    let output = '';

    proc.stdout.on('data', (data) => {
      output += data.toString();
    });

    proc.on('close', (code) => {
      if (code !== 0) {
        resolve(false);
        return;
      }
      // Check if our remote is in the list
      const remotes = output.split('\n').map(r => r.trim().replace(':', ''));
      resolve(remotes.includes(GDRIVE_REMOTE));
    });

    proc.on('error', () => resolve(false));
  });
}

export async function syncToGoogleDrive(
  localPath: string,
  subFolder?: string
): Promise<SyncResult> {
  const fileName = basename(localPath);
  const remotePath = subFolder
    ? `${GDRIVE_REMOTE}:${GDRIVE_OUTPUT_FOLDER}/${subFolder}/${fileName}`
    : `${GDRIVE_REMOTE}:${GDRIVE_OUTPUT_FOLDER}/${fileName}`;

  return new Promise((resolve) => {
    const args = [
      'copyto',           // Copy single file to specific destination
      localPath,
      remotePath,
      '--progress',
      '--stats', '5s',
      '--retries', '3',
      '--low-level-retries', '10',
      '-v',               // Verbose for logging
    ];

    console.log(`[GDrive] Syncing: ${fileName} -> ${remotePath}`);

    const proc = spawn('rclone', args);
    let stderr = '';
    let bytesTransferred = 0;

    proc.stdout.on('data', (data) => {
      const output = data.toString();
      // Parse progress output for bytes
      const match = output.match(/Transferred:\s+([\d.]+\s*\w+)/);
      if (match) {
        console.log(`[GDrive] ${match[0]}`);
      }
    });

    proc.stderr.on('data', (data) => {
      stderr += data.toString();
    });

    proc.on('close', (code) => {
      if (code === 0) {
        console.log(`[GDrive] Complete: ${fileName}`);
        resolve({
          success: true,
          remotePath,
          bytesTransferred,
        });
      } else {
        console.error(`[GDrive] Failed: ${fileName} - ${stderr}`);
        resolve({
          success: false,
          remotePath,
          error: stderr || `rclone exited with code ${code}`,
        });
      }
    });

    proc.on('error', (err) => {
      console.error(`[GDrive] Error: ${err.message}`);
      resolve({
        success: false,
        remotePath,
        error: err.message,
      });
    });
  });
}

export function getGoogleDriveUrl(remotePath: string): string {
  // Generate a web link for the file
  // Note: This is a best-effort URL - actual URL depends on file ID
  // For proper URLs, would need to use Google Drive API
  const pathParts = remotePath.replace(`${GDRIVE_REMOTE}:`, '').split('/');
  const encoded = encodeURIComponent(pathParts.join('/'));
  return `https://drive.google.com/drive/search?q=${encoded}`;
}

export async function syncBatchFolder(
  localFolder: string,
  batchId: string
): Promise<SyncResult> {
  const remotePath = `${GDRIVE_REMOTE}:${GDRIVE_OUTPUT_FOLDER}/${batchId}`;

  return new Promise((resolve) => {
    const args = [
      'sync',             // Sync entire folder
      localFolder,
      remotePath,
      '--progress',
      '--stats', '5s',
      '--retries', '3',
      '-v',
    ];

    console.log(`[GDrive] Syncing batch folder: ${batchId}`);

    const proc = spawn('rclone', args);
    let stderr = '';

    proc.stderr.on('data', (data) => {
      stderr += data.toString();
    });

    proc.on('close', (code) => {
      if (code === 0) {
        console.log(`[GDrive] Batch sync complete: ${batchId}`);
        resolve({
          success: true,
          remotePath,
        });
      } else {
        resolve({
          success: false,
          remotePath,
          error: stderr || `rclone exited with code ${code}`,
        });
      }
    });

    proc.on('error', (err) => {
      resolve({
        success: false,
        remotePath,
        error: err.message,
      });
    });
  });
}
```

Add to `.env.example`:
```
GDRIVE_REMOTE=gdrive
GDRIVE_OUTPUT_FOLDER=EtherealFlame/Renders
```
  </action>
  <verify>
Test script (requires rclone configured):
```typescript
import { checkRcloneInstalled, checkRemoteConfigured, syncToGoogleDrive } from './googleDrive';

async function test() {
  console.log('rclone installed:', await checkRcloneInstalled());
  console.log('remote configured:', await checkRemoteConfigured());

  // Test with a small file
  const result = await syncToGoogleDrive('./test-file.txt');
  console.log('Sync result:', result);
}

test();
```
  </verify>
  <done>
rclone-based Google Drive sync with progress logging, retry logic, and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Google Drive sync into post-processor</name>
  <files>src/lib/queue/postProcessor.ts</files>
  <action>
Update `src/lib/queue/postProcessor.ts` to sync to Google Drive after file rename:

Add imports:
```typescript
import { syncToGoogleDrive, getGoogleDriveUrl, checkRcloneInstalled } from '@/lib/services/googleDrive';
```

Update `PostProcessResult` interface:
```typescript
export interface PostProcessResult {
  finalPath: string;
  fileName: string;
  fileSizeBytes: number;
  gdriveUrl?: string;
  gdriveSyncError?: string;
}
```

Update `postProcessRender` function to add sync after renaming:

```typescript
export async function postProcessRender(
  renderDbId: string,
  tempOutputPath: string
): Promise<PostProcessResult> {
  // ... existing code for rename and database update ...

  // After the database update with output_path, add Google Drive sync:

  let gdriveUrl: string | undefined;
  let gdriveSyncError: string | undefined;

  // Check if rclone is available
  const rcloneReady = await checkRcloneInstalled();

  if (rcloneReady && process.env.GDRIVE_REMOTE) {
    // Sync to Google Drive
    const syncResult = await syncToGoogleDrive(
      finalPath,
      render.batch_id || undefined // Use batch ID as subfolder if present
    );

    if (syncResult.success) {
      gdriveUrl = getGoogleDriveUrl(syncResult.remotePath);

      // Update database with Google Drive URL
      updateRender(renderDbId, {
        gdrive_url: gdriveUrl,
      });
    } else {
      gdriveSyncError = syncResult.error;
      console.warn(`[PostProcess] Google Drive sync failed: ${syncResult.error}`);
      // Don't fail the job - local file is still valid
    }
  }

  return {
    finalPath,
    fileName,
    fileSizeBytes: stats.size,
    gdriveUrl,
    gdriveSyncError,
  };
}
```

This ensures:
- Google Drive sync is optional (only runs if GDRIVE_REMOTE is set)
- Sync failure doesn't fail the render job
- URL stored in database for reference
  </action>
  <verify>
End-to-end test:
1. Set GDRIVE_REMOTE and GDRIVE_OUTPUT_FOLDER env vars
2. Run a render job
3. Check that file appears in Google Drive
4. Check database has gdrive_url populated
  </verify>
  <done>
Post-processor syncs completed renders to Google Drive, URL stored in database.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add rclone setup documentation</name>
  <files>docs/google-drive-setup.md</files>
  <action>
Create `docs/google-drive-setup.md`:

```markdown
# Google Drive Setup for Ethereal Flame Studio

## Prerequisites

1. Install rclone: https://rclone.org/install/
2. Google account with Google Drive access

## Quick Setup (Interactive)

1. Run rclone config:
   ```bash
   rclone config
   ```

2. Follow the prompts:
   - `n` for new remote
   - Name: `gdrive` (or your preferred name)
   - Storage type: `drive` (Google Drive)
   - Leave client_id and client_secret blank (uses rclone's)
   - Scope: `1` (full access)
   - Leave root_folder_id blank
   - Leave service_account_file blank
   - `n` for advanced config
   - `y` for auto config (opens browser)

3. Authorize in browser

4. `n` for team drive (unless you use one)

5. Confirm with `y`

## Environment Variables

Add to your `.env`:

```
GDRIVE_REMOTE=gdrive
GDRIVE_OUTPUT_FOLDER=EtherealFlame/Renders
```

## Verify Setup

```bash
# List files in root
rclone ls gdrive:

# Test upload
echo "test" > /tmp/test.txt
rclone copy /tmp/test.txt gdrive:EtherealFlame/
rclone ls gdrive:EtherealFlame/

# Clean up
rclone delete gdrive:EtherealFlame/test.txt
```

## Unattended Operation (Service Account)

For running without interactive auth (server deployment):

1. Create a service account in Google Cloud Console
2. Download the JSON key file
3. Share your Google Drive folder with the service account email
4. Configure rclone:
   ```bash
   rclone config
   # When prompted for service_account_file, provide path to JSON key
   ```

## Troubleshooting

**Token expired:**
```bash
rclone config reconnect gdrive:
```

**Check connection:**
```bash
rclone about gdrive:
```

**Debug upload issues:**
```bash
rclone -vv copy /path/to/file gdrive:folder/
```
```
  </action>
  <verify>
- Documentation is clear and follows standard rclone setup flow
- Includes both interactive and service account setup paths
- Provides verification commands
  </verify>
  <done>
Google Drive setup documentation complete with interactive and service account options.
  </done>
</task>

</tasks>

<verification>
1. `rclone config` creates working Google Drive remote
2. `syncToGoogleDrive()` uploads files successfully
3. Post-processor syncs renders after completion
4. `gdrive_url` populated in database
5. Sync failure doesn't crash render job
6. Documentation covers setup process
</verification>

<success_criteria>
- Renders sync to Google Drive automatically after completion
- Sync uses rclone with retry logic and progress logging
- Google Drive URL stored in metadata database
- Sync is optional (requires GDRIVE_REMOTE env var)
- Sync failure is graceful (logs warning, doesn't fail job)
- Setup documentation provided
</success_criteria>

<output>
After completion, create `.planning/phases/04-automation/04-06-SUMMARY.md`
</output>
