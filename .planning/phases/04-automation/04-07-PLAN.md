---
phase: 04-automation
plan: 07
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - src/lib/services/notifications.ts
  - src/lib/queue/notificationWorker.ts
  - src/lib/queue/renderWorker.ts
autonomous: true
user_setup:
  - service: ntfy
    why: "Push notifications for job completion"
    env_vars:
      - name: NTFY_URL
        source: "https://ntfy.sh (default) or self-hosted URL"
      - name: NTFY_TOPIC
        source: "Your private topic name (e.g., ethereal-renders-yourname)"
    dashboard_config:
      - task: "Install ntfy app on phone"
        location: "iOS App Store or Google Play"
      - task: "Subscribe to your topic in the app"
        location: "ntfy app > + > Enter topic name"

must_haves:
  truths:
    - "User receives notification when batch completes"
    - "Notification includes video count and status"
    - "Failed jobs include error info in notification"
  artifacts:
    - path: "src/lib/services/notifications.ts"
      provides: "ntfy notification service"
      exports: ["sendNotification", "notifyBatchComplete", "notifyJobFailed"]
  key_links:
    - from: "src/lib/services/notifications.ts"
      to: "ntfy.sh API"
      via: "HTTP POST"
      pattern: "fetch.*ntfy"
    - from: "src/lib/queue/renderWorker.ts"
      to: "src/lib/services/notifications.ts"
      via: "batch completion check"
      pattern: "notifyBatchComplete"
---

<objective>
Implement job status notifications using ntfy for push alerts.

Purpose: Users receive instant notifications on their phone when renders complete or fail, enabling the phone-first workflow where they can monitor batch progress remotely.

Output: ntfy notification service with batch completion alerts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-automation/04-RESEARCH.md
@.planning/phases/04-automation/04-03-SUMMARY.md (when exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ntfy notification service</name>
  <files>src/lib/services/notifications.ts</files>
  <action>
Create `src/lib/services/notifications.ts`:

```typescript
const NTFY_URL = process.env.NTFY_URL || 'https://ntfy.sh';
const NTFY_TOPIC = process.env.NTFY_TOPIC || 'ethereal-renders';

type Priority = 'min' | 'low' | 'default' | 'high' | 'urgent';

interface NotificationOptions {
  title: string;
  message: string;
  priority?: Priority;
  tags?: string[];
  click?: string;  // URL to open on click
  actions?: Array<{
    action: 'view' | 'http';
    label: string;
    url: string;
  }>;
}

export async function sendNotification(options: NotificationOptions): Promise<boolean> {
  if (!NTFY_TOPIC) {
    console.log('[Notify] Skipped - no topic configured');
    return false;
  }

  try {
    const headers: Record<string, string> = {
      'Title': options.title,
      'Priority': options.priority || 'default',
    };

    if (options.tags?.length) {
      headers['Tags'] = options.tags.join(',');
    }

    if (options.click) {
      headers['Click'] = options.click;
    }

    if (options.actions?.length) {
      headers['Actions'] = options.actions
        .map(a => `${a.action}, ${a.label}, ${a.url}`)
        .join('; ');
    }

    const response = await fetch(`${NTFY_URL}/${NTFY_TOPIC}`, {
      method: 'POST',
      headers,
      body: options.message,
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${await response.text()}`);
    }

    console.log(`[Notify] Sent: ${options.title}`);
    return true;

  } catch (error) {
    console.error('[Notify] Failed:', error);
    return false;
  }
}

export interface BatchStatus {
  batchId: string;
  total: number;
  completed: number;
  failed: number;
}

export async function notifyBatchComplete(status: BatchStatus): Promise<void> {
  const allSucceeded = status.failed === 0;
  const allFailed = status.completed === 0;

  let title: string;
  let priority: Priority;
  let tags: string[];

  if (allSucceeded) {
    title = `Batch Complete: ${status.completed} videos`;
    priority = 'default';
    tags = ['white_check_mark', 'movie_camera'];
  } else if (allFailed) {
    title = `Batch Failed: ${status.total} videos`;
    priority = 'high';
    tags = ['x', 'warning'];
  } else {
    title = `Batch Partial: ${status.completed}/${status.total} succeeded`;
    priority = 'high';
    tags = ['warning', 'movie_camera'];
  }

  const message = [
    `Completed: ${status.completed}`,
    `Failed: ${status.failed}`,
    `Batch ID: ${status.batchId.slice(0, 8)}...`,
  ].join('\n');

  await sendNotification({
    title,
    message,
    priority,
    tags,
  });
}

export async function notifyJobFailed(
  jobId: string,
  audioName: string,
  errorMessage: string
): Promise<void> {
  await sendNotification({
    title: `Render Failed: ${audioName}`,
    message: `Error: ${errorMessage.slice(0, 200)}`,
    priority: 'high',
    tags: ['x', 'movie_camera'],
  });
}

export async function notifyBatchStarted(
  batchId: string,
  fileCount: number,
  formatCount: number
): Promise<void> {
  const totalJobs = fileCount * formatCount;

  await sendNotification({
    title: `Batch Started: ${fileCount} files`,
    message: `Rendering ${totalJobs} videos (${formatCount} formats each)\nBatch ID: ${batchId.slice(0, 8)}...`,
    priority: 'low',
    tags: ['hourglass_flowing_sand', 'movie_camera'],
  });
}

// Check if notifications are configured
export function isNotificationsEnabled(): boolean {
  return Boolean(NTFY_TOPIC);
}
```

Add to `.env.example`:
```
NTFY_URL=https://ntfy.sh
NTFY_TOPIC=ethereal-renders-yourname
```
  </action>
  <verify>
Test script:
```typescript
import { sendNotification, notifyBatchComplete } from './notifications';

// Test basic notification
await sendNotification({
  title: 'Test Notification',
  message: 'If you see this, notifications are working!',
  priority: 'default',
  tags: ['test'],
});

// Test batch complete
await notifyBatchComplete({
  batchId: 'test-batch-123',
  total: 5,
  completed: 4,
  failed: 1,
});
```

Check phone for notification (requires ntfy app installed and subscribed to topic).
  </verify>
  <done>
ntfy notification service sends push alerts with emoji tags and priority levels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create batch completion detection</name>
  <files>src/lib/queue/batchTracker.ts</files>
  <action>
Create `src/lib/queue/batchTracker.ts`:

```typescript
import { getRendersByBatch } from '@/lib/db';
import { notifyBatchComplete, notifyBatchStarted, BatchStatus } from '@/lib/services/notifications';

// Track which batches we've already notified about
const notifiedBatches = new Set<string>();

export async function checkBatchCompletion(batchId: string): Promise<BatchStatus | null> {
  // Skip if already notified
  if (notifiedBatches.has(batchId)) {
    return null;
  }

  const renders = getRendersByBatch(batchId);

  if (renders.length === 0) {
    return null;
  }

  const completed = renders.filter(r => r.status === 'completed').length;
  const failed = renders.filter(r => r.status === 'failed').length;
  const pending = renders.filter(r => r.status === 'pending' || r.status === 'processing').length;

  // Batch is complete when no jobs are pending/processing
  if (pending > 0) {
    return null;
  }

  const status: BatchStatus = {
    batchId,
    total: renders.length,
    completed,
    failed,
  };

  // Mark as notified and send notification
  notifiedBatches.add(batchId);
  await notifyBatchComplete(status);

  // Clean up old batch IDs (keep last 1000)
  if (notifiedBatches.size > 1000) {
    const toRemove = Array.from(notifiedBatches).slice(0, 100);
    toRemove.forEach(id => notifiedBatches.delete(id));
  }

  return status;
}

export async function onBatchCreated(
  batchId: string,
  fileCount: number,
  formatCount: number
): Promise<void> {
  await notifyBatchStarted(batchId, fileCount, formatCount);
}

// Clear notification state (useful for testing)
export function clearNotificationState(): void {
  notifiedBatches.clear();
}
```

This provides:
- Batch completion detection by checking database state
- Deduplication to prevent multiple notifications for same batch
- Memory management for long-running workers
  </action>
  <verify>
```typescript
import { checkBatchCompletion, clearNotificationState } from './batchTracker';

// Clear state for testing
clearNotificationState();

// After a batch completes, check completion
const status = await checkBatchCompletion('batch-id-here');
console.log('Batch status:', status);
// Should send notification if batch is complete

// Calling again should return null (already notified)
const status2 = await checkBatchCompletion('batch-id-here');
console.log('Second check:', status2); // null
```
  </verify>
  <done>
Batch tracker detects completion and prevents duplicate notifications.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate notifications into render worker</name>
  <files>src/lib/queue/renderWorker.ts, src/lib/queue/renderQueue.ts</files>
  <action>
Update `src/lib/queue/renderWorker.ts` to check batch completion after each job:

Add imports:
```typescript
import { checkBatchCompletion } from './batchTracker';
import { notifyJobFailed } from '@/lib/services/notifications';
```

In `processRenderJob`, after the try/catch block (at the very end of the function), add:

```typescript
// Check if batch is complete and send notification
if (job.data.batchId) {
  await checkBatchCompletion(job.data.batchId);
}
```

In the catch block, after `markRenderFailed`, add individual failure notification:

```typescript
// Send individual failure notification for immediate awareness
await notifyJobFailed(
  job.id || 'unknown',
  audioFile.originalName,
  message
);
```

Update `src/lib/queue/renderQueue.ts` to notify on batch creation:

Add import:
```typescript
import { onBatchCreated } from './batchTracker';
```

In `addBatchJob`, after creating all jobs, add:

```typescript
// Notify that batch has started
await onBatchCreated(batchId, audioFiles.length, outputFormats.length);
```
  </action>
  <verify>
End-to-end test:
1. Set NTFY_TOPIC env var
2. Subscribe to topic on phone
3. Create a batch job with multiple files
4. Watch for:
   - "Batch Started" notification when job created
   - "Batch Complete" notification when all jobs finish
   - "Render Failed" notification if any job fails
  </verify>
  <done>
Render worker sends notifications on batch start, job failure, and batch completion.
  </done>
</task>

</tasks>

<verification>
1. `sendNotification()` delivers to ntfy.sh
2. Notifications appear on phone with correct emojis
3. Batch start notification includes file and format count
4. Batch complete notification shows success/fail counts
5. Failed jobs trigger immediate notification
6. No duplicate notifications for same batch
</verification>

<success_criteria>
- Push notifications work via ntfy
- Batch start notifies with job count
- Batch completion notifies with success/fail summary
- Individual failures notified immediately
- Notifications configurable via env vars
- Works with ntfy.sh or self-hosted ntfy
</success_criteria>

<output>
After completion, create `.planning/phases/04-automation/04-07-SUMMARY.md`
</output>
