---
phase: 13-job-state-worker-infra
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/app/api/audio/jobs/[jobId]/route.ts
  - src/app/api/audio/jobs/[jobId]/cancel/route.ts
autonomous: true
requirements: [JOB-03, JOB-04]

must_haves:
  truths:
    - "User can see job progress (percentage and stage name) by polling GET /api/audio/jobs/[jobId]"
    - "User can see their position in the queue when a job is pending"
    - "User can cancel a running job via POST /api/audio/jobs/[jobId]/cancel and the worker stops within one poll cycle"
  artifacts:
    - path: "src/app/api/audio/jobs/[jobId]/route.ts"
      provides: "GET endpoint returning job status, progress, stage, queue position, and result"
      exports: ["GET"]
    - path: "src/app/api/audio/jobs/[jobId]/cancel/route.ts"
      provides: "POST endpoint to cancel a job"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/audio/jobs/[jobId]/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() for reading job state"
      pattern: "getJobStore"
    - from: "src/app/api/audio/jobs/[jobId]/cancel/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() for cancelling job"
      pattern: "getJobStore.*cancel"
---

<objective>
Create the poll and cancel API endpoints so users can monitor job progress and cancel running jobs.

Purpose: Users need visibility into what's happening with their submitted jobs (JOB-03) and the ability to stop jobs they no longer want (JOB-04). These endpoints are consumed by the frontend polling hook and will work identically in local and cloud modes.

Output: Two Next.js API routes under `/api/audio/jobs/[jobId]/`.
</objective>

<execution_context>
@C:/Users/jonch/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jonch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-job-state-worker-infra/13-CONTEXT.md
@.planning/phases/13-job-state-worker-infra/13-01-SUMMARY.md
@src/lib/jobs/types.ts
@src/lib/jobs/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Job poll endpoint (GET /api/audio/jobs/[jobId])</name>
  <files>src/app/api/audio/jobs/[jobId]/route.ts</files>
  <action>
Create `src/app/api/audio/jobs/[jobId]/route.ts` with a GET handler:

1. Extract `jobId` from route params
2. Call `getJobStore().get(jobId)`
3. If job not found, return 404 `{ error: "Job not found" }`
4. Build response shape per user decision (stage + percentage):

```typescript
interface JobPollResponse {
  jobId: string;
  type: 'ingest' | 'preview' | 'save';
  status: 'pending' | 'processing' | 'complete' | 'failed' | 'cancelled';
  progress: number;        // 0-100 within current stage
  stage: string | null;    // descriptive name: "downloading", "normalizing", etc.
  queuePosition: number | null;  // only set when status='pending'
  result?: Record<string, unknown>;  // only set when status='complete'
  error?: string;          // only set when status='failed'
  createdAt: string;
  updatedAt: string;
}
```

5. If status is `'pending'`, call `getJobStore().getQueuePosition(jobId)` to populate `queuePosition`. Otherwise set to null.
6. Per user decision: "No fake progress bars — if a stage can't report granular progress, show stage name with indeterminate state." When `stage` is set but `progress` is 0, the frontend should interpret this as indeterminate. The API just returns the raw values.
7. Return 200 with the response JSON.

Use `NextResponse.json()` for responses. Export only `GET`.
  </action>
  <verify>
- `npx tsc --noEmit src/app/api/audio/jobs/[jobId]/route.ts` compiles
- Manual curl test (after server start): `curl http://localhost:3000/api/audio/jobs/nonexistent` returns 404
- Response shape includes `stage`, `progress`, and `queuePosition` fields
  </verify>
  <done>
GET /api/audio/jobs/[jobId] returns job status with stage name, progress percentage, queue position for pending jobs, and result/error for terminal states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Job cancel endpoint (POST /api/audio/jobs/[jobId]/cancel)</name>
  <files>src/app/api/audio/jobs/[jobId]/cancel/route.ts</files>
  <action>
Create `src/app/api/audio/jobs/[jobId]/cancel/route.ts` with a POST handler:

1. Extract `jobId` from route params
2. Call `getJobStore().get(jobId)` — if not found, return 404
3. Check if job is in a terminal state (`complete`, `failed`, `cancelled`). If so, return 409 Conflict: `{ error: "Job already in terminal state", status: job.status }`
4. Call `getJobStore().cancel(jobId)` — this updates the database status to 'cancelled'
5. Return 200 `{ jobId, status: 'cancelled', message: 'Job cancellation requested' }`

Note: The actual SIGTERM to child process happens in the worker (Plan 13-03), not here. The API route only sets the database status. The worker checks for cancellation on each poll cycle and sends SIGTERM to the child process (per user decision: "Cancellation sends SIGTERM to child process, confirmed dead before releasing the job").

The worker will detect cancellation by checking `job.status === 'cancelled'` during its processing loop and will handle the SIGTERM/cleanup. This endpoint is purely a state mutation.

Export only `POST`.
  </action>
  <verify>
- `npx tsc --noEmit src/app/api/audio/jobs/[jobId]/cancel/route.ts` compiles
- Attempting to cancel a completed job returns 409
- Cancelling a pending/processing job returns 200 with status='cancelled'
  </verify>
  <done>
POST /api/audio/jobs/[jobId]/cancel sets job status to cancelled in the database. Worker detects this on next poll cycle and kills the child process. Terminal jobs cannot be re-cancelled (409 response).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. GET /api/audio/jobs/[jobId] returns correct shape for pending, processing, complete, failed states
3. POST /api/audio/jobs/[jobId]/cancel transitions pending/processing to cancelled, rejects terminal states
4. Both routes use `getJobStore()` (adapter-agnostic)
</verification>

<success_criteria>
- Poll endpoint returns stage, progress, queuePosition, and result/error based on status
- Cancel endpoint transitions non-terminal jobs to cancelled and returns 409 for terminal jobs
- Both endpoints compile and work with the JobStore adapter from plan 13-01
</success_criteria>

<output>
After completion, create `.planning/phases/13-job-state-worker-infra/13-02-SUMMARY.md`
</output>
