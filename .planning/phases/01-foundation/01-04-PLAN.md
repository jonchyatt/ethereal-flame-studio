---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/shaders/starnest.frag.glsl
  - src/components/canvas/StarNestSkybox.tsx
  - src/lib/stores/visualStore.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Skybox renders as infinite procedural space background"
    - "Skybox rotates slowly during playback"
    - "Multiple presets available (DarkWorld1, Normal, Purple Nebula, etc.)"
  artifacts:
    - path: "src/components/canvas/StarNestSkybox.tsx"
      provides: "Star Nest skybox component with presets"
      exports: ["StarNestSkybox", "STAR_NEST_PRESETS"]
      min_lines: 100
    - path: "src/lib/shaders/starnest.frag.glsl"
      provides: "Star Nest procedural shader"
      min_lines: 60
  key_links:
    - from: "src/components/canvas/StarNestSkybox.tsx"
      to: "src/lib/shaders/starnest.frag.glsl"
      via: "fragmentShader uniform"
      pattern: "fragmentShader.*starnest"
---

<objective>
Port Star Nest skybox shader from reference code with preset system and automatic rotation.

Purpose: Provide the infinite procedural space background that frames the particle visuals. Star Nest is a famous Shadertoy shader by Pablo Roman Andrioli, ported to Unity by the user, now ported to WebGL. The skybox rotation (VIS-07) adds subtle motion. This satisfies VIS-06, VIS-07.

Output: Procedural space skybox visible behind particles, with preset selector.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port Star Nest shader and preset types</name>
  <files>
    - src/lib/shaders/starnest.frag.glsl
    - src/types/index.ts
  </files>
  <action>
Port Star Nest shader from reference code (BreathingOrb.tsx lines 1091-1500+).

1. Update src/types/index.ts with StarNestPreset type:
   ```typescript
   export type StarNestPreset = {
     key: string;
     label: string;
     iterations: number;
     volsteps: number;
     formuparam: number;
     stepSize: number;
     tile: number;
     brightness: number;
     darkmatter: number;
     distfading: number;
     saturation: number;
     color: [number, number, number];
     center: [number, number, number, number];
     scroll: [number, number, number, number];
     rotation: [number, number, number, number];
     // HSV extensions (optional)
     hueShift?: number;
     hueSpeed?: number;
     postSaturation?: number;
   };
   ```

2. Create src/lib/shaders/starnest.frag.glsl:
   Port the Star Nest shader. Key uniforms:
   - uTime: float (for animation)
   - uIterations: int
   - uVolsteps: int
   - uFormuparam: float
   - uStepSize: float
   - uTile: float
   - uBrightness: float
   - uDarkmatter: float
   - uDistfading: float
   - uSaturation: float
   - uColor: vec3
   - uCenter: vec4
   - uScroll: vec4
   - uRotation: vec4

   Shader structure (from Shadertoy XlfGRj):
   ```glsl
   varying vec3 vWorldPosition;

   uniform float uTime;
   uniform int uIterations;
   uniform int uVolsteps;
   uniform float uFormuparam;
   uniform float uStepSize;
   uniform float uTile;
   uniform float uBrightness;
   uniform float uDarkmatter;
   uniform float uDistfading;
   uniform float uSaturation;
   uniform vec3 uColor;
   uniform vec4 uCenter;
   uniform vec4 uScroll;
   uniform vec4 uRotation;

   void main() {
     vec3 dir = normalize(vWorldPosition);

     // Apply rotation over time
     float rotSpeed = uRotation.w;
     float angle = uTime * rotSpeed;
     // ... rotation matrix application

     // Apply scroll
     vec3 from = uCenter.xyz + uScroll.xyz * uTime * uScroll.w;

     // Volumetric ray marching
     float s = 0.1, fade = 1.0;
     vec3 v = vec3(0.0);

     for (int r = 0; r < MAX_VOLSTEPS; r++) {
       if (r >= uVolsteps) break;
       vec3 p = from + s * dir * uStepSize / 1000.0;
       p = abs(vec3(uTile / 1000.0) - mod(p, vec3(uTile / 1000.0) * 2.0));

       float pa, a = pa = 0.0;
       for (int i = 0; i < MAX_ITERATIONS; i++) {
         if (i >= uIterations) break;
         p = abs(p) / dot(p, p) - uFormuparam / 1000.0;
         a += abs(length(p) - pa);
         pa = length(p);
       }

       float dm = max(0.0, uDarkmatter / 1000.0 - a * a * 0.001);
       a = pow(a, 2.5);

       if (r > 6) fade *= 1.0 - dm;

       v += fade;
       v += vec3(s, s*s, s*s*s*s) * a * uBrightness / 10000.0 * fade;
       fade *= uDistfading / 100.0;
       s += uStepSize / 1000.0;
     }

     v = mix(vec3(length(v)), v, uSaturation / 100.0);
     gl_FragColor = vec4(v * 0.01 * uColor, 1.0);
   }
   ```

   Note: Use MAX_ITERATIONS = 20 and MAX_VOLSTEPS = 20 as constants (loops need compile-time bounds in GLSL ES).
  </action>
  <verify>
    TypeScript types compile
    Shader file exists and has all uniforms
  </verify>
  <done>
    StarNestPreset type defined
    Star Nest fragment shader ported with all parameters
    Rotation animation included in shader
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StarNestSkybox component with presets</name>
  <files>
    - src/components/canvas/StarNestSkybox.tsx
    - src/lib/stores/visualStore.ts
  </files>
  <action>
1. Create src/components/canvas/StarNestSkybox.tsx:
   - "use client" directive
   - Import shader, types

   Export STAR_NEST_PRESETS array (port from reference, key presets):
   ```typescript
   export const STAR_NEST_PRESETS: StarNestPreset[] = [
     {
       key: 'darkWorld1',
       label: '1DarkWorld1 (THE ONE)',
       iterations: 16,
       volsteps: 15,
       formuparam: 420.2,
       stepSize: 312.2,
       tile: 796.96,
       brightness: 0.63,
       darkmatter: 40,
       distfading: 50,
       saturation: 62,
       color: [1, 1, 1],
       center: [0, 0.3, 0.5, 0],
       scroll: [0.1, 0.1, -0.3, 0],
       rotation: [1, 10, 0, 0.5],
     },
     {
       key: 'normal',
       label: 'Normal (Original)',
       iterations: 15,
       volsteps: 8,
       formuparam: 420,
       stepSize: 355,
       tile: 700,
       brightness: 0.5,
       darkmatter: 555,
       distfading: 55,
       saturation: 77,
       color: [1, 1, 1],
       center: [1, 0.3, 0.5, 0],
       scroll: [0.1, 0.1, -0.3, 0],
       rotation: [0, 0, 0, 0.01],
     },
     {
       key: 'purple',
       label: 'Purple Nebula',
       iterations: 15,
       volsteps: 8,
       formuparam: 483,
       stepSize: 278.6,
       tile: 897.1,
       brightness: 0.5,
       darkmatter: 738.21,
       distfading: 100.3,
       saturation: 88.1,
       color: [0.757, 0.267, 0.602],
       center: [1, 0.3, 0.5, 8.09],
       scroll: [0.1, 0.1, -0.3, 0],
       rotation: [0, 0, 0, 0.01],
     },
     // Add 2-3 more presets (galaxies, hotSuns, etc.)
   ];
   ```

   Component props:
   - preset?: StarNestPreset (or use store)
   - rotationSpeed?: number (override, default from preset)

   Implementation:
   - Use drei's Sphere with large radius (100) as skybox geometry
   - Custom shaderMaterial with:
     - Vertex shader: pass vWorldPosition = position
     - Fragment shader: Star Nest shader
     - side: THREE.BackSide (render inside of sphere)
     - depthWrite: false
   - useFrame to update uTime uniform
   - Read preset from props or visualStore

2. Update src/lib/stores/visualStore.ts:
   Add skybox state:
   ```typescript
   interface VisualState {
     // ... existing
     skyboxPreset: StarNestPreset;
     skyboxRotationSpeed: number;
     setSkyboxPreset: (preset: StarNestPreset) => void;
     setSkyboxRotationSpeed: (speed: number) => void;
   }
   ```
   Initialize with STAR_NEST_PRESETS[0] (darkWorld1).

3. Vertex shader (inline or separate file):
   ```glsl
   varying vec3 vWorldPosition;
   void main() {
     vWorldPosition = position;
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
   }
   ```
  </action>
  <verify>
    npm run dev shows procedural space background
    Skybox slowly rotates over time
    Particles render in front of skybox
  </verify>
  <done>
    StarNestSkybox renders infinite procedural space (VIS-06)
    Automatic rotation during playback (VIS-07)
    Preset system with 4+ presets
    Integration with visual store
  </done>
</task>

</tasks>

<verification>
1. Run npm run dev and observe skybox behind particles
2. Watch skybox - should slowly rotate/animate
3. Verify procedural star/nebula patterns render correctly
4. Confirm skybox is behind particles (depth ordering)
5. Check performance - shader shouldn't drop frames
</verification>

<success_criteria>
- Star Nest skybox renders procedural space background (VIS-06)
- Skybox rotates automatically (VIS-07)
- Multiple presets available (DarkWorld1, Normal, Purple Nebula)
- Shader parameters match Unity reference
- Skybox renders behind particles (correct depth)
- Requirements covered: VIS-06, VIS-07
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
