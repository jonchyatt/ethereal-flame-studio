---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/shaders/particle.vert.glsl
  - src/lib/shaders/particle.frag.glsl
  - src/components/canvas/ParticleLayer.tsx
  - src/components/canvas/ParticleSystem.tsx
  - src/lib/stores/visualStore.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Particles spawn, live, and die over time"
    - "Particle size follows the size-over-lifetime curve (37% birth, 100% at 20% life, 50% death)"
    - "Dual layers render (inner glow + outer halo)"
    - "Particles fade in and fade out smoothly"
  artifacts:
    - path: "src/components/canvas/ParticleLayer.tsx"
      provides: "Single particle layer with CPU lifetime tracking"
      exports: ["ParticleLayer"]
      min_lines: 150
    - path: "src/components/canvas/ParticleSystem.tsx"
      provides: "Dual-layer particle system wrapper"
      exports: ["ParticleSystem"]
    - path: "src/lib/shaders/particle.vert.glsl"
      provides: "Vertex shader for point sprite rendering"
      min_lines: 15
    - path: "src/lib/shaders/particle.frag.glsl"
      provides: "Fragment shader with soft glow falloff"
      min_lines: 15
  key_links:
    - from: "src/components/canvas/ParticleLayer.tsx"
      to: "useFrame"
      via: "R3F animation loop"
      pattern: "useFrame.*clock"
    - from: "src/components/canvas/ParticleSystem.tsx"
      to: "src/components/canvas/ParticleLayer.tsx"
      via: "Renders two ParticleLayer components"
      pattern: "<ParticleLayer"
---

<objective>
Create the core particle system with CPU-based lifetime management, GPU rendering, and the magic size-over-lifetime curve from Unity.

Purpose: Establish the ethereal particle effect that makes the visual quality. The size-over-lifetime curve (VIS-10) is the key - particles bloom at birth, peak at 20% life, then fade. Combined with dual layers (VIS-05), this creates the volumetric nebula effect. This satisfies VIS-01, VIS-04, VIS-05, VIS-05b, VIS-10, VIS-12.

Output: Visible particle system with organic spawn/live/die cycle and dual-layer rendering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create particle shaders and ParticleLayer component</name>
  <files>
    - src/lib/shaders/particle.vert.glsl
    - src/lib/shaders/particle.frag.glsl
    - src/components/canvas/ParticleLayer.tsx
    - src/types/index.ts
  </files>
  <action>
Port UnityParticleLayer from reference code (BreathingOrb.tsx lines 748-1034).

1. Create src/lib/shaders/particle.vert.glsl:
   ```glsl
   attribute float aSize;
   attribute float aAlpha;
   attribute vec3 aColor;

   varying float vAlpha;
   varying vec3 vColor;

   void main() {
     vAlpha = aAlpha;
     vColor = aColor;

     vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
     gl_Position = projectionMatrix * mvPosition;

     // Distance-based size attenuation
     float distanceScale = 100.0 / length(mvPosition.xyz);
     gl_PointSize = aSize * distanceScale;
   }
   ```

2. Create src/lib/shaders/particle.frag.glsl:
   ```glsl
   uniform float uIntensity;

   varying float vAlpha;
   varying vec3 vColor;

   void main() {
     vec2 center = gl_PointCoord - 0.5;
     float dist = length(center);

     // Soft circular gradient with smooth falloff
     float alpha = 1.0 - smoothstep(0.0, 0.5, dist);
     alpha = pow(alpha, 0.8); // Softer falloff for glow

     // Bright core + soft bloom + halo
     float core = exp(-dist * 4.0) * 0.8;
     float bloom = exp(-dist * 1.5) * 0.3;
     float halo = exp(-dist * 8.0) * 0.4;

     vec3 color = vColor * uIntensity * (1.0 + core + bloom);
     float finalAlpha = (alpha + halo) * vAlpha * 0.85;

     gl_FragColor = vec4(color, finalAlpha);
   }
   ```

3. Update src/types/index.ts with ParticleLayerConfig type:
   ```typescript
   export type FrequencyBand = 'bass' | 'mids' | 'treble' | 'all';

   export type ParticleLayerConfig = {
     id: string;
     name: string;
     enabled: boolean;
     particleCount: number;
     baseSize: number;
     spawnRadius: number;
     maxSpeed: number;
     lifetime: number;
     audioReactivity: number;
     frequencyBand: FrequencyBand;
     // Size over lifetime curve (THE MAGIC)
     sizeAtBirth: number;    // 0.37 default (37%)
     sizeAtPeak: number;     // 1.0 default (100%)
     sizeAtDeath: number;    // 0.5 default (50%)
     peakLifetime: number;   // 0.2 default (peak at 20% life)
     // Colors
     colorStart?: [number, number, number];
     colorEnd?: [number, number, number];
   };
   ```

4. Create src/components/canvas/ParticleLayer.tsx:
   - "use client" directive
   - Accept ParticleLayerConfig prop
   - Accept audioLevels (bass, mids, treble, amplitude) props

   State refs (mutable without re-render):
   - birthTimes: Float32Array
   - lifetimes: Float32Array
   - velocities: Float32Array
   - birthPositions: Float32Array
   - baseSizes: Float32Array

   Buffer attributes (useMemo):
   - positions: Float32Array (count * 3)
   - sizes: Float32Array (count)
   - colors: Float32Array (count * 3)
   - alphas: Float32Array (count)

   Initialize particles in useMemo:
   - Random direction on sphere (theta, phi)
   - Spawn radius from config
   - Outward velocity (dir * speed)
   - Stagger birth times: -Math.random() * lifetime
   - Random base size with variation

   useFrame animation loop:
   - For each particle:
     a. Calculate age = time - birthTime
     b. If age > lifetime: respawn (new position, velocity, birthTime = now)
     c. Calculate normAge = age / lifetime
     d. SIZE OVER LIFETIME CURVE (VIS-10):
        ```javascript
        if (normAge < peakLifetime) {
          sizeMult = sizeAtBirth + (sizeAtPeak - sizeAtBirth) * (normAge / peakLifetime);
        } else {
          sizeMult = sizeAtPeak - (sizeAtPeak - sizeAtDeath) * ((normAge - peakLifetime) / (1 - peakLifetime));
        }
        ```
     e. ALPHA: Fade in first 10%, full 10-70%, fade out last 30%
     f. Position = birthPos + velocity * age * scale
   - Mark attributes as needsUpdate = true

   Render:
   - <points> with frustumCulled={false}
   - <bufferGeometry> with position, aSize, aColor, aAlpha attributes
   - <shaderMaterial> with inline shaders (or imported), additive blending, transparent, depthWrite={false}
  </action>
  <verify>
    TypeScript compiles with no errors
    ParticleLayer component exports correctly
    Shader files exist in src/lib/shaders/
  </verify>
  <done>
    ParticleLayer renders point sprites with CPU lifetime tracking
    Size-over-lifetime curve (VIS-10) implemented exactly as Unity reference
    Alpha fade in/out for smooth lifecycle (VIS-04)
    Soft glow shader with core/bloom/halo
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ParticleSystem with dual-layer configuration</name>
  <files>
    - src/components/canvas/ParticleSystem.tsx
    - src/lib/stores/visualStore.ts
    - src/app/page.tsx
  </files>
  <action>
1. Create src/lib/stores/visualStore.ts:
   ```typescript
   import { create } from 'zustand';
   import type { ParticleLayerConfig } from '@/types';

   // Default dual-layer configuration (VIS-05)
   export const DEFAULT_LAYERS: ParticleLayerConfig[] = [
     // Layer 1: Inner Glow - Dense bright center
     {
       id: 'inner-glow',
       name: 'Inner Glow',
       enabled: true,
       particleCount: 1500,
       baseSize: 0.20,
       spawnRadius: 0.05,    // Tight center spawn
       maxSpeed: 0.04,
       lifetime: 2.0,
       audioReactivity: 0.5,
       frequencyBand: 'bass',
       sizeAtBirth: 0.02,    // 2% at birth
       sizeAtPeak: 1.0,      // 100% at peak
       sizeAtDeath: 0.07,    // 7% at death
       peakLifetime: 0.4,    // Peak at 40% life
     },
     // Layer 2: Outer Halo - Soft diffuse cloud
     {
       id: 'outer-halo',
       name: 'Outer Halo',
       enabled: true,
       particleCount: 1000,
       baseSize: 0.20,
       spawnRadius: 0.20,    // Wider spawn
       maxSpeed: 0.01,       // Very slow drift
       lifetime: 2.0,
       audioReactivity: 0.6,
       frequencyBand: 'mids',
       sizeAtBirth: 0.02,    // 2% at birth
       sizeAtPeak: 1.0,      // 100% at peak
       sizeAtDeath: 0.02,    // 2% at death
       peakLifetime: 0.7,    // Peak at 70% life
     },
   ];

   interface VisualState {
     layers: ParticleLayerConfig[];
     intensity: number;
     globalHue: number;

     setLayers: (layers: ParticleLayerConfig[]) => void;
     updateLayer: (id: string, updates: Partial<ParticleLayerConfig>) => void;
     setIntensity: (intensity: number) => void;
     setGlobalHue: (hue: number) => void;
   }

   export const useVisualStore = create<VisualState>((set) => ({
     layers: DEFAULT_LAYERS,
     intensity: 1.0,
     globalHue: 0,

     setLayers: (layers) => set({ layers }),
     updateLayer: (id, updates) => set((state) => ({
       layers: state.layers.map(l => l.id === id ? { ...l, ...updates } : l),
     })),
     setIntensity: (intensity) => set({ intensity }),
     setGlobalHue: (globalHue) => set({ globalHue }),
   }));
   ```

2. Create src/components/canvas/ParticleSystem.tsx:
   - "use client" directive
   - Import ParticleLayer
   - Import useVisualStore, useAudioStore

   Read from stores:
   - layers, intensity from visualStore
   - bass, mids, treble, amplitude from audioStore

   Global hue cycling (useFrame):
   - Slowly cycle globalHue (0.003 per frame)
   - Jump faster on audio amplitude
   - Store in ref for particle respawn color

   Render enabled layers:
   ```tsx
   <group>
     {layers.filter(l => l.enabled).map(config => (
       <ParticleLayer
         key={config.id}
         config={config}
         bass={bass}
         mids={mids}
         treble={treble}
         amplitude={amplitude}
         intensity={intensity}
         globalHue={globalHueRef.current}
       />
     ))}
   </group>
   ```

3. Update src/app/page.tsx:
   - Import ParticleSystem
   - Import AudioControls
   - Add ParticleSystem inside Canvas (replace placeholder mesh)
   - Add AudioControls outside Canvas (DOM layer)
  </action>
  <verify>
    npm run dev shows particle system in browser
    Two distinct layers visible (inner dense, outer diffuse)
    Particles spawn, grow, shrink, and die
    Size-over-lifetime curve visible (particles bloom then fade)
  </verify>
  <done>
    ParticleSystem renders dual layers (VIS-05)
    Default particle count ~2500 (VIS-05b)
    Visual store manages layer configuration
    Integration with audio store ready (wiring in next plans)
  </done>
</task>

</tasks>

<verification>
1. Run npm run dev and observe particles
2. Verify two visually distinct layers (dense inner, diffuse outer)
3. Watch individual particles: spawn small, grow to peak, shrink, disappear
4. Confirm smooth alpha fade in/out (no popping)
5. Rotate camera - particles render from all angles
6. Check performance (should be 60fps with 2500 particles)
</verification>

<success_criteria>
- Particle lifetime system works (VIS-04)
- Size-over-lifetime curve matches Unity (VIS-10): 37% birth, 100% at 20%, 50% death
- Dual-layer system renders (VIS-05): inner glow + outer halo
- Default ~2500 particles, architecture supports up to 50K (VIS-05b)
- Smooth lerp transitions (VIS-12) in size and alpha
- Real-time WebGL preview working (VIS-01)
- Requirements covered: VIS-01, VIS-04, VIS-05, VIS-05b, VIS-10, VIS-12
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
