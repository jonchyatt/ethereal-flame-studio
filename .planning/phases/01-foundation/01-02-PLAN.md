---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/audio/AudioAnalyzer.ts
  - src/lib/stores/audioStore.ts
  - src/components/ui/AudioControls.tsx
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "User can upload an audio file and hear it play"
    - "FFT analysis produces bass, mids, treble values"
    - "Beat detection fires on strong bass transients"
    - "Audio levels update in real-time (60fps)"
  artifacts:
    - path: "src/lib/audio/AudioAnalyzer.ts"
      provides: "Singleton audio analyzer with FFT and beat detection"
      exports: ["AudioAnalyzer", "audioAnalyzer"]
      min_lines: 150
    - path: "src/lib/stores/audioStore.ts"
      provides: "Zustand store for audio state"
      exports: ["useAudioStore"]
    - path: "src/components/ui/AudioControls.tsx"
      provides: "File upload and playback UI"
      exports: ["AudioControls"]
  key_links:
    - from: "src/lib/audio/AudioAnalyzer.ts"
      to: "Web Audio API"
      via: "AudioContext and AnalyserNode"
      pattern: "new AudioContext"
    - from: "src/components/ui/AudioControls.tsx"
      to: "src/lib/audio/AudioAnalyzer.ts"
      via: "connect() method"
      pattern: "audioAnalyzer\\.connect"
---

<objective>
Port AudioAnalyzerSingleton from reference code with FFT analysis, frequency band separation, and beat detection.

Purpose: Provide the audio reactive foundation that drives all visual effects. The analyzer extracts bass/mids/treble from audio in real-time and detects beats using threshold crossing algorithm. This satisfies AUD-01, AUD-02, AUD-04, VIS-08, VIS-09, VIS-11.

Output: Working audio upload with real-time FFT analysis visible in debug overlay.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioAnalyzer singleton with FFT and beat detection</name>
  <files>
    - src/lib/audio/AudioAnalyzer.ts
    - src/types/index.ts
  </files>
  <action>
Port AudioAnalyzerSingleton from reference code (BreathingOrb.tsx lines 99-271).

1. Create src/lib/audio/AudioAnalyzer.ts with singleton class:

   Private state:
   - audioContext: AudioContext | null
   - analyser: AnalyserNode | null
   - source: MediaElementAudioSourceNode | null
   - dataArray: Uint8Array | null
   - connectedElement: HTMLAudioElement | null

   Public audio levels (0-1 range):
   - amplitude: number (overall level)
   - bass: number (0-250Hz)
   - mid: number (250Hz-4kHz)
   - high: number (4kHz+)

   Beat detection parameters (from reference):
   - bias: 0.5 (threshold multiplier)
   - timeStep: 0.08 (min cooldown between beats)
   - timeToBeat: 0.08 (beat registration time)
   - restSmoothTime: 0.5 (return to rest time)
   - beatScale: 1.8 (scale on beat)
   - restScale: 1.0 (normal scale)

   Beat state:
   - previousBass: number
   - lastBeatTime: number
   - isBeat: boolean
   - currentScale: number
   - timeSinceLastBeat: number

   Methods:
   - static getInstance(): AudioAnalyzerSingleton
   - async connect(audioElement: HTMLAudioElement): Promise<void>
   - update(deltaTime: number): void
   - disconnect(): void

2. In connect():
   - Guard against reconnecting to same element
   - Create AudioContext with 512 FFT size
   - Set smoothingTimeConstant to 0.7
   - Connect source -> analyser -> destination
   - Store dataArray

3. In update():
   - Get frequency data from analyser
   - Calculate frequency bands:
     - subBassEnd = len * 0.025 (~60Hz)
     - bassEnd = len * 0.1 (~250Hz)
     - midEnd = len * 0.5 (~4kHz)
   - Normalize each band to 0-1
   - Beat detection using threshold crossing:
     - beatSignal = max(subBass, bass * 0.7)
     - threshold = 0.05 (low threshold)
     - Detect rising edge + cooldown check
     - Set isBeat = true, update lastBeatTime, currentScale
   - Smooth currentScale with amplitude-based lerp

4. Export singleton instance: export const audioAnalyzer = AudioAnalyzerSingleton.getInstance()

5. Update src/types/index.ts with AudioLevels type:
   ```typescript
   export type AudioLevels = {
     amplitude: number;
     bass: number;
     mid: number;
     high: number;
     isBeat: boolean;
     currentScale: number;
   };
   ```
  </action>
  <verify>
    TypeScript compiles with no errors
    AudioAnalyzer class exports correctly
  </verify>
  <done>
    AudioAnalyzer singleton created with FFT analysis
    Frequency band separation (bass, mids, treble) implemented
    Beat detection with threshold crossing and cooldown
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand audio store and AudioControls UI</name>
  <files>
    - src/lib/stores/audioStore.ts
    - src/components/ui/AudioControls.tsx
  </files>
  <action>
1. Create src/lib/stores/audioStore.ts:
   ```typescript
   import { create } from 'zustand';

   interface AudioState {
     isPlaying: boolean;
     amplitude: number;
     bass: number;
     mids: number;
     treble: number;
     isBeat: boolean;
     currentScale: number;
     audioFile: File | null;

     setPlaying: (playing: boolean) => void;
     setLevels: (levels: { amplitude: number; bass: number; mids: number; treble: number }) => void;
     setBeat: (isBeat: boolean, scale: number) => void;
     setAudioFile: (file: File | null) => void;
   }

   export const useAudioStore = create<AudioState>((set) => ({
     isPlaying: false,
     amplitude: 0,
     bass: 0,
     mids: 0,
     treble: 0,
     isBeat: false,
     currentScale: 1,
     audioFile: null,

     setPlaying: (isPlaying) => set({ isPlaying }),
     setLevels: (levels) => set({
       amplitude: levels.amplitude,
       bass: levels.bass,
       mids: levels.mids,
       treble: levels.treble,
     }),
     setBeat: (isBeat, currentScale) => set({ isBeat, currentScale }),
     setAudioFile: (audioFile) => set({ audioFile }),
   }));
   ```

2. Create src/components/ui/AudioControls.tsx:
   - "use client" directive
   - File input for audio (accept=".mp3,.wav,.ogg")
   - Hidden <audio> element with ref
   - Play/Pause button
   - Volume slider (optional, nice to have)
   - Debug overlay showing bass/mids/treble/beat values

   On file select:
   - Create object URL from file
   - Set as audio src
   - Call audioAnalyzer.connect(audioRef.current)
   - Update audioStore.setAudioFile

   On play click:
   - Resume AudioContext if suspended (browser autoplay policy)
   - Play/pause audio element
   - Update audioStore.setPlaying

   Animation loop (useEffect with requestAnimationFrame):
   - While playing, call audioAnalyzer.update(deltaTime)
   - Update store: setLevels, setBeat

3. Style with Tailwind:
   - Fixed position at bottom of screen
   - Semi-transparent dark background
   - Upload button, play/pause, level meters
   - Mobile-friendly (touch targets >= 44px)
  </action>
  <verify>
    npm run dev shows AudioControls at bottom of screen
    File upload accepts audio files
    Play button starts audio and shows level changes
    Beat indicator flashes on bass hits
  </verify>
  <done>
    Zustand store manages audio state
    AudioControls allows file upload and playback
    Real-time levels displayed in debug overlay
    Beat detection visible (indicator flashes)
  </done>
</task>

</tasks>

<verification>
1. Upload an audio file (any MP3/WAV with bass)
2. Click play - audio should play through speakers
3. Observe bass/mids/treble values changing in real-time
4. Observe beat indicator firing on bass transients
5. Verify no AudioContext errors in console
6. Test on mobile (if possible) - touch targets work
</verification>

<success_criteria>
- Audio file upload works (AUD-01)
- Real-time FFT analysis with frequency bands (AUD-02, VIS-08, VIS-09)
- Beat detection fires on bass (AUD-04, VIS-11)
- Zustand store provides audio state to R3F components
- Debug overlay shows real-time values
- Requirements covered: AUD-01, AUD-02, AUD-04, VIS-08, VIS-09, VIS-11
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
