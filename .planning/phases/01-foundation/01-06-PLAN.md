---
phase: 01-foundation
plan: 06
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/components/canvas/ParticleLayer.tsx
  - src/lib/stores/visualStore.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Ethereal Flame mode shows organic upward-drifting particles"
    - "Particles have warm colors (orange, red, yellow)"
    - "Flame mode has faster, more energetic movement than mist"
  artifacts:
    - path: "src/lib/stores/visualStore.ts"
      provides: "Ethereal Flame preset configuration"
      contains: "etherealFlame"
  key_links:
    - from: "src/lib/stores/visualStore.ts"
      to: "src/components/canvas/ParticleLayer.tsx"
      via: "Flame configuration passed as layer config"
      pattern: "etherealFlame.*particleCount"
---

<objective>
Create Ethereal Flame visual mode - organic upward-drifting fire-like particle effect with warm colors.

Purpose: Provide the second distinct visual mode. Ethereal Flame is energetic, warm, rising - suitable for energetic music, warmth, and dynamic content. This satisfies VIS-03.

Output: Selectable "Ethereal Flame" mode with visible warm, upward-drifting fire aesthetic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Ethereal Flame mode configuration</name>
  <files>
    - src/lib/stores/visualStore.ts
  </files>
  <action>
Add ETHEREAL_FLAME_CONFIG to visualStore.ts:

```typescript
export const ETHEREAL_FLAME_CONFIG: VisualModeConfig = {
  key: 'etherealFlame',
  label: 'Ethereal Flame',
  description: 'Organic upward-drifting fire particles with warm colors',
  layers: [
    // Layer 1: Flame Core - Bright, fast-rising center
    {
      id: 'flame-core',
      name: 'Flame Core',
      enabled: true,
      particleCount: 1800,
      baseSize: 0.18,          // Medium particles
      spawnRadius: 0.08,       // Tight spawn at base
      maxSpeed: 0.06,          // Fast upward drift
      lifetime: 1.5,           // Short lifetime (fire flickers)
      audioReactivity: 0.7,    // Strong bass response
      frequencyBand: 'bass',
      sizeAtBirth: 0.05,       // Small at birth
      sizeAtPeak: 1.0,         // Full at peak
      sizeAtDeath: 0.1,        // Small at death
      peakLifetime: 0.3,       // Quick bloom, early peak
    },
    // Layer 2: Ember Layer - Orange/red outer particles
    {
      id: 'flame-embers',
      name: 'Embers',
      enabled: true,
      particleCount: 1200,
      baseSize: 0.12,          // Smaller ember particles
      spawnRadius: 0.12,       // Slightly wider
      maxSpeed: 0.04,          // Medium speed
      lifetime: 2.0,
      audioReactivity: 0.5,
      frequencyBand: 'mids',
      sizeAtBirth: 0.08,
      sizeAtPeak: 0.9,
      sizeAtDeath: 0.15,
      peakLifetime: 0.25,
    },
    // Layer 3: Heat Haze - Subtle background warmth
    {
      id: 'flame-haze',
      name: 'Heat Haze',
      enabled: true,
      particleCount: 800,
      baseSize: 0.25,
      spawnRadius: 0.20,
      maxSpeed: 0.02,
      lifetime: 2.5,
      audioReactivity: 0.3,
      frequencyBand: 'treble',
      sizeAtBirth: 0.1,
      sizeAtPeak: 1.0,
      sizeAtDeath: 0.2,
      peakLifetime: 0.4,
    },
  ],
  colorPalette: {
    primary: [1.0, 0.6, 0.1],    // Orange
    secondary: [1.0, 0.3, 0.0],  // Red-orange
    accent: [1.0, 0.9, 0.3],     // Yellow-white
  },
  skyboxPreset: 'darkWorld1',
};
```

Update modeConfigs initialization:
```typescript
modeConfigs: {
  etherealMist: ETHEREAL_MIST_CONFIG,
  etherealFlame: ETHEREAL_FLAME_CONFIG,
},
```
  </action>
  <verify>
    TypeScript compiles with no errors
    ETHEREAL_FLAME_CONFIG exports correctly
    Both mode configs in store
  </verify>
  <done>
    Ethereal Flame configuration defined
    Fast upward drift, short lifetimes
    Warm color palette (orange, red, yellow)
    Three layers for depth
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement flame-specific upward velocity and colors</name>
  <files>
    - src/components/canvas/ParticleLayer.tsx
  </files>
  <action>
Update ParticleLayer to handle flame-specific behavior:

1. Add upward velocity bias for flame mode:
   In the particle initialization (useMemo) and respawn logic:
   ```typescript
   // Check if this is a flame layer
   const isFlame = config.id.includes('flame');

   // For flame: add upward bias to velocity
   if (isFlame) {
     // Y velocity should be predominantly upward
     const upwardBias = 0.7; // 70% of velocity is upward
     velocities[i * 3] = dirX * speed * (1 - upwardBias) + (Math.random() - 0.5) * speed * 0.3;
     velocities[i * 3 + 1] = Math.abs(dirY) * speed * upwardBias + speed * 0.5; // Always positive Y
     velocities[i * 3 + 2] = dirZ * speed * (1 - upwardBias) + (Math.random() - 0.5) * speed * 0.3;
   }
   ```

2. Add horizontal turbulence for organic flame flicker:
   In useFrame, add small random offsets to flame particles:
   ```typescript
   if (isFlame && age > 0) {
     // Add organic flicker/turbulence
     const flicker = Math.sin(age * 15 + i) * 0.005;
     const turbulence = Math.cos(age * 8 + i * 0.5) * 0.003;
     posAttr.setXYZ(
       i,
       (bx + vx * age + flicker) * scale,
       (by + vy * age) * scale,  // No turbulence on Y (pure upward)
       (bz + vz * age + turbulence) * scale
     );
   }
   ```

3. Warm color interpolation for flame:
   ```typescript
   if (colorPalette && isFlame) {
     // Flame color: interpolate from core (yellow-white) to edge (orange-red) based on age
     const colorT = normAge; // Young = bright, old = red
     let color: [number, number, number];
     if (colorT < 0.3) {
       // Young: accent (yellow-white) to primary (orange)
       color = lerpColor(colorPalette.accent, colorPalette.primary, colorT / 0.3);
     } else {
       // Older: primary (orange) to secondary (red)
       color = lerpColor(colorPalette.primary, colorPalette.secondary, (colorT - 0.3) / 0.7);
     }
     colorAttr.setXYZ(i, color[0], color[1], color[2]);
   }
   ```

4. Sharper alpha curve for flame (quick birth, quick death):
   ```typescript
   if (isFlame) {
     // Flame alpha: very quick fade in, quick fade out
     if (normAge < 0.05) {
       alpha = normAge / 0.05;  // 5% fade in
     } else if (normAge < 0.5) {
       alpha = 1.0;
     } else {
       alpha = 1.0 - ((normAge - 0.5) / 0.5);  // 50% fade out
     }
   }
   ```
  </action>
  <verify>
    Switch to flame mode shows upward-moving particles
    Particles have warm orange/red/yellow colors
    Flame flickers organically (subtle turbulence)
    Young particles are brighter/yellower, old ones are redder
  </verify>
  <done>
    Flame mode has organic upward drift (VIS-03)
    Warm color palette with age-based interpolation
    Turbulence creates organic flicker
    Shorter lifetimes create fire-like effect
  </done>
</task>

</tasks>

<verification>
1. Set mode to 'etherealFlame' in store
2. Observe particles: should rise upward organically
3. Colors should be warm (yellow core, orange middle, red tips)
4. Particles should flicker slightly (organic turbulence)
5. Overall effect should resemble ethereal fire
6. Compare to mist mode - should be visibly different (faster, warmer, upward)
</verification>

<success_criteria>
- Ethereal Flame mode creates organic fire-like effect (VIS-03)
- Particles drift predominantly upward
- Warm color palette (orange, red, yellow-white)
- Age-based color: young = bright yellow, old = deep red
- Organic turbulence for realistic flicker
- Short lifetimes (1.5-2.5 seconds)
- Strong audio reactivity (especially to bass)
- Visibly different from mist mode
- Requirement covered: VIS-03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
