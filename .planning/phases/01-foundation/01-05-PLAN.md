---
phase: 01-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/components/canvas/ParticleLayer.tsx
  - src/lib/stores/visualStore.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Ethereal Mist mode shows soft cloud-like particles floating gently"
    - "Particles are pastel/soft colors in mist mode"
    - "Mist mode has very slow drift and longer lifetimes"
  artifacts:
    - path: "src/lib/stores/visualStore.ts"
      provides: "Ethereal Mist preset configuration"
      contains: "etherealMist"
  key_links:
    - from: "src/lib/stores/visualStore.ts"
      to: "src/components/canvas/ParticleLayer.tsx"
      via: "Mist configuration passed as layer config"
      pattern: "etherealMist.*particleCount"
---

<objective>
Create Ethereal Mist visual mode - soft cloud-like particle effect with gentle floating motion.

Purpose: Provide the first of two distinct visual modes. Ethereal Mist is calm, soft, cloud-like - suitable for meditation, ambient backgrounds, and gentle audio. This satisfies VIS-02.

Output: Selectable "Ethereal Mist" mode with visible soft cloud aesthetic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Ethereal Mist mode configuration</name>
  <files>
    - src/types/index.ts
    - src/lib/stores/visualStore.ts
  </files>
  <action>
1. Update src/types/index.ts with VisualMode type:
   ```typescript
   export type VisualMode = 'etherealMist' | 'etherealFlame';

   export type VisualModeConfig = {
     key: VisualMode;
     label: string;
     description: string;
     layers: ParticleLayerConfig[];
     colorPalette: {
       primary: [number, number, number];
       secondary: [number, number, number];
       accent: [number, number, number];
     };
     skyboxPreset: string; // key from STAR_NEST_PRESETS
   };
   ```

2. Update src/lib/stores/visualStore.ts:
   Add ETHEREAL_MIST_CONFIG:
   ```typescript
   export const ETHEREAL_MIST_CONFIG: VisualModeConfig = {
     key: 'etherealMist',
     label: 'Ethereal Mist',
     description: 'Soft cloud-like particles floating gently',
     layers: [
       // Layer 1: Soft Core - Very gentle, pastel
       {
         id: 'mist-core',
         name: 'Mist Core',
         enabled: true,
         particleCount: 2000,
         baseSize: 0.25,          // Larger, softer particles
         spawnRadius: 0.15,       // Medium spread
         maxSpeed: 0.008,         // VERY slow drift
         lifetime: 4.0,           // Long lifetime for cloud effect
         audioReactivity: 0.3,    // Subtle audio response
         frequencyBand: 'all',    // React to overall amplitude
         sizeAtBirth: 0.1,        // 10% at birth
         sizeAtPeak: 1.0,         // 100% at peak
         sizeAtDeath: 0.3,        // 30% at death (soft fade)
         peakLifetime: 0.5,       // Peak at 50% (centered)
       },
       // Layer 2: Ambient Haze - Background fog
       {
         id: 'mist-haze',
         name: 'Ambient Haze',
         enabled: true,
         particleCount: 1500,
         baseSize: 0.35,          // Large, very soft
         spawnRadius: 0.30,       // Wide spread
         maxSpeed: 0.004,         // Almost stationary
         lifetime: 6.0,           // Very long lifetime
         audioReactivity: 0.2,    // Very subtle response
         frequencyBand: 'mids',
         sizeAtBirth: 0.15,
         sizeAtPeak: 1.0,
         sizeAtDeath: 0.4,
         peakLifetime: 0.6,
       },
     ],
     colorPalette: {
       primary: [0.7, 0.85, 1.0],    // Soft cyan
       secondary: [0.9, 0.8, 1.0],   // Soft lavender
       accent: [1.0, 0.95, 0.9],     // Warm white
     },
     skyboxPreset: 'normal',
   };
   ```

   Add to store:
   ```typescript
   interface VisualState {
     // ... existing
     currentMode: VisualMode;
     modeConfigs: Record<VisualMode, VisualModeConfig>;
     setMode: (mode: VisualMode) => void;
   }
   ```

   Initialize:
   ```typescript
   currentMode: 'etherealMist',
   modeConfigs: {
     etherealMist: ETHEREAL_MIST_CONFIG,
     etherealFlame: ETHEREAL_FLAME_CONFIG, // Placeholder for now
   },
   setMode: (mode) => set((state) => ({
     currentMode: mode,
     layers: state.modeConfigs[mode].layers,
     // Could also update skybox preset here
   })),
   ```
  </action>
  <verify>
    TypeScript compiles with no errors
    ETHEREAL_MIST_CONFIG exports correctly
  </verify>
  <done>
    VisualMode type defined
    Ethereal Mist configuration with slow drift, long lifetimes
    Store supports mode switching
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement mist-specific rendering behavior</name>
  <files>
    - src/components/canvas/ParticleLayer.tsx
  </files>
  <action>
Update ParticleLayer to handle mist-specific rendering:

1. Add soft color interpolation:
   The mist mode uses softer colors. In the useFrame loop, when updating colors:
   ```typescript
   // Get mode-specific colors from config or props
   const { colorPalette } = props;

   // For mist: interpolate between pastel colors based on particle position
   if (colorPalette) {
     const t = (Math.sin(age * 0.5) + 1) * 0.5; // Slow oscillation
     const color = lerpColor(colorPalette.primary, colorPalette.secondary, t);
     colorAttr.setXYZ(i, color[0], color[1], color[2]);
   }
   ```

2. Softer alpha curve for mist:
   Mist particles should have even softer edges. Adjust the alpha calculation:
   ```typescript
   // Mist-specific alpha: slower fade in, very gradual fade out
   let alpha: number;
   if (normAge < 0.15) {
     alpha = normAge / 0.15;  // Fade in over 15%
   } else if (normAge < 0.6) {
     alpha = 1.0;             // Full opacity 15-60%
   } else {
     alpha = 1.0 - ((normAge - 0.6) / 0.4);  // Fade out over 40%
   }
   // Apply softness multiplier for mist
   alpha *= config.id.includes('mist') ? 0.7 : 1.0;
   ```

3. Add props for colorPalette:
   ```typescript
   interface ParticleLayerProps {
     config: ParticleLayerConfig;
     bass: number;
     mids: number;
     treble: number;
     amplitude: number;
     intensity: number;
     globalHue: number;
     colorPalette?: {
       primary: [number, number, number];
       secondary: [number, number, number];
       accent: [number, number, number];
     };
   }
   ```

4. Helper function:
   ```typescript
   function lerpColor(
     a: [number, number, number],
     b: [number, number, number],
     t: number
   ): [number, number, number] {
     return [
       a[0] + (b[0] - a[0]) * t,
       a[1] + (b[1] - a[1]) * t,
       a[2] + (b[2] - a[2]) * t,
     ];
   }
   ```
  </action>
  <verify>
    Switch to mist mode shows visibly different particles
    Particles drift very slowly
    Colors are soft pastel tones
    Overall effect is calm and cloud-like
  </verify>
  <done>
    Mist mode has distinct soft cloud aesthetic (VIS-02)
    Very slow particle drift
    Pastel color palette
    Longer lifetimes create persistent clouds
  </done>
</task>

</tasks>

<verification>
1. Set mode to 'etherealMist' in store (or via UI if available)
2. Observe particles: should be soft, slow-moving, cloud-like
3. Colors should be pastel (cyan, lavender, warm white)
4. Particles should persist longer than default
5. Audio reactivity should be subtle, not aggressive
</verification>

<success_criteria>
- Ethereal Mist mode creates soft cloud-like effect (VIS-02)
- Particles drift very slowly (~0.004-0.008 speed)
- Long lifetimes (4-6 seconds)
- Pastel color palette
- Subtle audio reactivity
- Visibly different from default/flame mode
- Requirement covered: VIS-02
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
