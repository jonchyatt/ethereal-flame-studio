---
phase: 01-foundation
plan: 07
type: execute
wave: 4
depends_on: ["01-02", "01-03", "01-04", "01-05", "01-06"]
files_modified:
  - src/components/ui/ControlPanel.tsx
  - src/components/ui/ModeSelector.tsx
  - src/components/ui/PresetSelector.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can switch between Ethereal Mist and Ethereal Flame modes"
    - "User can select different skybox presets"
    - "UI is usable on mobile devices (touch-friendly)"
    - "Controls are semi-transparent and don't obstruct the visuals"
  artifacts:
    - path: "src/components/ui/ControlPanel.tsx"
      provides: "Main control panel container"
      exports: ["ControlPanel"]
    - path: "src/components/ui/ModeSelector.tsx"
      provides: "Visual mode switcher UI"
      exports: ["ModeSelector"]
    - path: "src/components/ui/PresetSelector.tsx"
      provides: "Skybox preset selector UI"
      exports: ["PresetSelector"]
  key_links:
    - from: "src/components/ui/ModeSelector.tsx"
      to: "src/lib/stores/visualStore.ts"
      via: "setMode action"
      pattern: "setMode.*ethereal"
    - from: "src/components/ui/PresetSelector.tsx"
      to: "src/lib/stores/visualStore.ts"
      via: "setSkyboxPreset action"
      pattern: "setSkyboxPreset"
---

<objective>
Create mobile-friendly control UI for mode selection, preset selection, and visual parameters.

Purpose: Provide user interface for controlling the visual experience. The UI must work on phones (primary use case) with touch-friendly controls. This satisfies INF-01.

Output: Touch-friendly control panel with mode selector, preset selector, and audio controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModeSelector and PresetSelector components</name>
  <files>
    - src/components/ui/ModeSelector.tsx
    - src/components/ui/PresetSelector.tsx
  </files>
  <action>
1. Create src/components/ui/ModeSelector.tsx:
   - "use client" directive
   - Import useVisualStore
   - Import VisualMode type

   Component:
   ```tsx
   export function ModeSelector() {
     const { currentMode, modeConfigs, setMode } = useVisualStore();

     return (
       <div className="flex gap-2">
         {Object.values(modeConfigs).map((config) => (
           <button
             key={config.key}
             onClick={() => setMode(config.key)}
             className={`
               px-4 py-3 rounded-lg text-sm font-medium
               transition-all duration-200
               min-w-[100px] min-h-[44px]
               ${currentMode === config.key
                 ? 'bg-white/20 text-white border border-white/40'
                 : 'bg-white/5 text-white/70 border border-white/10 hover:bg-white/10'
               }
             `}
           >
             {config.label}
           </button>
         ))}
       </div>
     );
   }
   ```

   Mobile considerations:
   - min-h-[44px] for touch targets
   - Clear visual feedback for selected state
   - High contrast text

2. Create src/components/ui/PresetSelector.tsx:
   - "use client" directive
   - Import useVisualStore
   - Import STAR_NEST_PRESETS from StarNestSkybox

   Component:
   ```tsx
   export function PresetSelector() {
     const { skyboxPreset, setSkyboxPreset } = useVisualStore();

     return (
       <div className="flex flex-col gap-2">
         <label className="text-xs text-white/60 uppercase tracking-wider">
           Skybox
         </label>
         <select
           value={skyboxPreset.key}
           onChange={(e) => {
             const preset = STAR_NEST_PRESETS.find(p => p.key === e.target.value);
             if (preset) setSkyboxPreset(preset);
           }}
           className="
             bg-white/10 text-white border border-white/20
             rounded-lg px-3 py-2 min-h-[44px]
             text-sm
             focus:outline-none focus:ring-2 focus:ring-white/30
           "
         >
           {STAR_NEST_PRESETS.map((preset) => (
             <option key={preset.key} value={preset.key} className="bg-gray-900">
               {preset.label}
             </option>
           ))}
         </select>
       </div>
     );
   }
   ```
  </action>
  <verify>
    TypeScript compiles with no errors
    Components render buttons/selects
    Mode switching updates store
  </verify>
  <done>
    ModeSelector allows switching between Mist and Flame
    PresetSelector allows choosing skybox preset
    Touch-friendly sizes (44px minimum)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ControlPanel container and integrate into page</name>
  <files>
    - src/components/ui/ControlPanel.tsx
    - src/app/page.tsx
  </files>
  <action>
1. Create src/components/ui/ControlPanel.tsx:
   - "use client" directive
   - Compose ModeSelector, PresetSelector, AudioControls

   Layout:
   ```tsx
   export function ControlPanel() {
     const [isOpen, setIsOpen] = useState(true);
     const [showDebug, setShowDebug] = useState(false);

     return (
       <div className="fixed bottom-0 left-0 right-0 z-50">
         {/* Toggle button for mobile */}
         <button
           onClick={() => setIsOpen(!isOpen)}
           className="
             absolute -top-10 left-1/2 -translate-x-1/2
             bg-black/50 backdrop-blur-sm
             px-4 py-2 rounded-t-lg
             text-white/80 text-sm
             border border-white/10 border-b-0
           "
         >
           {isOpen ? 'Hide Controls' : 'Show Controls'}
         </button>

         {/* Control panel */}
         <div
           className={`
             bg-black/70 backdrop-blur-md
             border-t border-white/10
             transition-transform duration-300
             ${isOpen ? 'translate-y-0' : 'translate-y-full'}
           `}
         >
           <div className="max-w-4xl mx-auto p-4 space-y-4">
             {/* Mode selector row */}
             <div className="flex flex-wrap items-center justify-between gap-4">
               <ModeSelector />
               <PresetSelector />
             </div>

             {/* Audio controls */}
             <AudioControls />

             {/* Debug toggle (optional) */}
             <div className="flex justify-end">
               <button
                 onClick={() => setShowDebug(!showDebug)}
                 className="text-xs text-white/40 hover:text-white/60"
               >
                 {showDebug ? 'Hide Debug' : 'Show Debug'}
               </button>
             </div>

             {/* Debug info */}
             {showDebug && <DebugOverlay />}
           </div>
         </div>
       </div>
     );
   }
   ```

2. Create a simple DebugOverlay component (inline or separate):
   ```tsx
   function DebugOverlay() {
     const audio = useAudioStore();
     const visual = useVisualStore();

     return (
       <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-white/60 font-mono">
         <div>Bass: {audio.bass.toFixed(2)}</div>
         <div>Mids: {audio.mids.toFixed(2)}</div>
         <div>Treble: {audio.treble.toFixed(2)}</div>
         <div>Beat: {audio.isBeat ? 'YES' : '-'}</div>
         <div>Mode: {visual.currentMode}</div>
         <div>Particles: {visual.layers.reduce((sum, l) => sum + l.particleCount, 0)}</div>
       </div>
     );
   }
   ```

3. Update src/app/page.tsx:
   - Remove old AudioControls import
   - Import ControlPanel
   - Place ControlPanel after Canvas (DOM layer)

   ```tsx
   export default function Home() {
     return (
       <main className="w-screen h-screen bg-black">
         <Canvas
           camera={{ position: [0, 0.5, 3], fov: 60 }}
           dpr={[1, 2]}
           gl={{ antialias: true, powerPreference: 'high-performance' }}
         >
           <StarNestSkybox />
           <ParticleSystem />
           <OrbitControls
             enableZoom={true}
             enablePan={false}
             minDistance={1}
             maxDistance={10}
           />
         </Canvas>
         <ControlPanel />
       </main>
     );
   }
   ```

4. Responsive considerations:
   - Stack controls vertically on narrow screens (flex-wrap)
   - Collapsible panel to maximize view area
   - Semi-transparent background to see visuals through
  </action>
  <verify>
    npm run dev shows control panel at bottom
    Mode selector switches between Mist and Flame
    Preset selector changes skybox
    Audio controls work (upload, play)
    Panel can be collapsed/expanded
    Works on mobile viewport (use browser dev tools)
  </verify>
  <done>
    ControlPanel integrates all UI controls (INF-01)
    Mobile-friendly touch targets (44px minimum)
    Collapsible to maximize visual area
    Semi-transparent to not obstruct visuals
    Debug overlay available for development
  </done>
</task>

</tasks>

<verification>
1. Run npm run dev and view in browser
2. Verify control panel appears at bottom
3. Click "Ethereal Mist" - particles should change to soft/slow
4. Click "Ethereal Flame" - particles should change to fast/warm
5. Change skybox preset - background should change
6. Upload audio and play - verify levels shown in debug
7. Test on mobile viewport (Chrome DevTools device mode)
8. Verify all buttons are tappable (44px targets)
9. Collapse panel - verify visuals still render behind
</verification>

<success_criteria>
- Mobile-friendly web UI (INF-01)
- Touch targets >= 44px
- Mode switching works (Mist/Flame)
- Preset switching works (skybox)
- Audio controls integrated
- UI is semi-transparent, doesn't block visuals
- Panel is collapsible for full-screen view
- Responsive layout works on phone/tablet/desktop
- Requirement covered: INF-01
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md`
</output>
