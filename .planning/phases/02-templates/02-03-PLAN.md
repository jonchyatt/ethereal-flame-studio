---
phase: 02-templates
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/ui/TemplateGallery.tsx
  - src/components/ui/TemplateCard.tsx
  - src/components/ui/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can see grid of template thumbnails"
    - "User can click a template to load it immediately"
    - "Active template is visually highlighted"
    - "Built-in and user templates are visually distinguished"
  artifacts:
    - path: "src/components/ui/TemplateGallery.tsx"
      provides: "Grid layout for template cards"
      exports: ["TemplateGallery"]
    - path: "src/components/ui/TemplateCard.tsx"
      provides: "Individual template card with thumbnail"
      exports: ["TemplateCard"]
  key_links:
    - from: "src/components/ui/TemplateGallery.tsx"
      to: "src/lib/stores/templateStore.ts"
      via: "useTemplateStore hook"
      pattern: "useTemplateStore"
    - from: "src/components/ui/TemplateCard.tsx"
      to: "src/lib/stores/visualStore.ts"
      via: "applyTemplateSettings"
      pattern: "applyTemplateSettings"
---

<objective>
Build template gallery UI with thumbnail grid and card components.

Purpose: Allow users to browse and select templates visually. Clicking a template immediately loads its settings into the visual engine (TPL-02, TPL-06).

Output: TemplateGallery and TemplateCard components integrated into ControlPanel, enabling template browsing and one-click loading.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-templates/02-RESEARCH.md
@src/components/ui/ControlPanel.tsx
@src/lib/stores/templateStore.ts
@src/lib/stores/visualStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateCard component</name>
  <files>src/components/ui/TemplateCard.tsx</files>
  <action>
Create `src/components/ui/TemplateCard.tsx`:

```tsx
'use client';

import { VisualTemplate } from '@/lib/templates/types';

interface TemplateCardProps {
  template: VisualTemplate;
  isActive: boolean;
  onSelect: () => void;
  onDelete?: () => void; // undefined for built-in (no delete allowed)
}

export function TemplateCard({
  template,
  isActive,
  onSelect,
  onDelete,
}: TemplateCardProps) {
  return (
    <div
      className={`
        group relative aspect-square rounded-lg overflow-hidden
        border-2 transition-all cursor-pointer
        ${isActive
          ? 'border-blue-500 ring-2 ring-blue-500/50 scale-105'
          : 'border-white/20 hover:border-white/40 hover:scale-102'
        }
      `}
      onClick={onSelect}
    >
      {/* Thumbnail or Gradient Fallback */}
      {template.thumbnail ? (
        <img
          src={template.thumbnail}
          alt={template.name}
          className="w-full h-full object-cover"
        />
      ) : (
        <div className={`
          w-full h-full
          ${template.isBuiltIn
            ? 'bg-gradient-to-br from-indigo-900/60 to-purple-900/60'
            : 'bg-gradient-to-br from-slate-800/60 to-slate-900/60'
          }
        `} />
      )}

      {/* Built-in Badge */}
      {template.isBuiltIn && (
        <div className="absolute top-1 left-1 px-1.5 py-0.5 rounded bg-indigo-500/80 text-white text-[10px] font-medium">
          PRESET
        </div>
      )}

      {/* Active Indicator */}
      {isActive && (
        <div className="absolute top-1 right-1 w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-lg" />
      )}

      {/* Delete Button (user templates only) */}
      {onDelete && !template.isBuiltIn && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onDelete();
          }}
          className="
            absolute top-1 right-1 p-1 rounded
            bg-black/50 hover:bg-red-600/80
            text-white/60 hover:text-white
            opacity-0 group-hover:opacity-100
            transition-all
          "
          title="Delete template"
        >
          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      )}

      {/* Name Overlay */}
      <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-2 pt-6">
        <p className="text-white text-xs font-medium truncate">
          {template.name}
        </p>
        {template.description && (
          <p className="text-white/50 text-[10px] truncate mt-0.5">
            {template.description}
          </p>
        )}
      </div>
    </div>
  );
}
```

Features:
- Thumbnail with gradient fallback
- Built-in badge for presets
- Active indicator (blue dot)
- Delete button (user templates only, appears on hover)
- Name and description overlay
- Touch-friendly (entire card is clickable)
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>TemplateCard component with thumbnail, active state, and delete button for user templates</done>
</task>

<task type="auto">
  <name>Task 2: Create TemplateGallery component</name>
  <files>src/components/ui/TemplateGallery.tsx</files>
  <action>
Create `src/components/ui/TemplateGallery.tsx`:

```tsx
'use client';

import { useEffect } from 'react';
import { TemplateCard } from './TemplateCard';
import { useTemplateStore } from '@/lib/stores/templateStore';
import { useVisualStore } from '@/lib/stores/visualStore';
import { BUILT_IN_PRESETS, initializeBuiltInPresets } from '@/lib/templates/builtInPresets';

interface TemplateGalleryProps {
  onSaveNew?: () => void; // Callback to open save dialog
}

export function TemplateGallery({ onSaveNew }: TemplateGalleryProps) {
  const templates = useTemplateStore((state) => state.templates);
  const activeTemplateId = useTemplateStore((state) => state.activeTemplateId);
  const loadTemplate = useTemplateStore((state) => state.loadTemplate);
  const deleteTemplate = useTemplateStore((state) => state.deleteTemplate);
  const setActiveTemplate = useTemplateStore((state) => state.setActiveTemplate);
  const applyTemplateSettings = useVisualStore((state) => state.applyTemplateSettings);

  // Initialize built-in presets on mount
  useEffect(() => {
    const { templates: current } = useTemplateStore.getState();
    // Only initialize if built-ins not present
    const hasBuiltIns = current.some(t => t.isBuiltIn);
    if (!hasBuiltIns) {
      useTemplateStore.setState((state) => ({
        templates: [...BUILT_IN_PRESETS, ...state.templates.filter(t => !t.isBuiltIn)],
      }));
    }
  }, []);

  const handleSelect = (templateId: string) => {
    const settings = loadTemplate(templateId);
    if (settings) {
      applyTemplateSettings(settings);
    }
  };

  const handleDelete = (templateId: string) => {
    if (confirm('Delete this template?')) {
      deleteTemplate(templateId);
    }
  };

  // Separate built-in and user templates
  const builtInTemplates = templates.filter(t => t.isBuiltIn);
  const userTemplates = templates.filter(t => !t.isBuiltIn);

  return (
    <div className="space-y-4">
      {/* Built-in Presets Section */}
      <div>
        <h3 className="text-white/60 text-xs font-medium uppercase tracking-wider mb-2">
          Presets
        </h3>
        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
          {builtInTemplates.map((template) => (
            <TemplateCard
              key={template.id}
              template={template}
              isActive={template.id === activeTemplateId}
              onSelect={() => handleSelect(template.id)}
            />
          ))}
        </div>
      </div>

      {/* User Templates Section */}
      <div>
        <h3 className="text-white/60 text-xs font-medium uppercase tracking-wider mb-2">
          Your Templates
        </h3>
        <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
          {/* Save New Button */}
          {onSaveNew && (
            <button
              onClick={onSaveNew}
              className="
                aspect-square rounded-lg
                border-2 border-dashed border-white/30
                hover:border-white/50 hover:bg-white/5
                flex flex-col items-center justify-center gap-1
                text-white/50 hover:text-white/70
                transition-all
              "
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
              <span className="text-[10px]">Save Current</span>
            </button>
          )}

          {userTemplates.map((template) => (
            <TemplateCard
              key={template.id}
              template={template}
              isActive={template.id === activeTemplateId}
              onSelect={() => handleSelect(template.id)}
              onDelete={() => handleDelete(template.id)}
            />
          ))}

          {userTemplates.length === 0 && !onSaveNew && (
            <p className="text-white/40 text-xs col-span-full py-2">
              No saved templates yet
            </p>
          )}
        </div>
      </div>
    </div>
  );
}
```

Features:
- Initializes built-in presets on mount
- Separates built-in presets from user templates
- Grid layout responsive to screen size
- "Save Current" button triggers save dialog
- One-click template loading with visual feedback
- Confirm dialog before delete
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>TemplateGallery component with built-in/user separation, grid layout, and one-click loading</done>
</task>

<task type="auto">
  <name>Task 3: Integrate TemplateGallery into ControlPanel</name>
  <files>src/components/ui/ControlPanel.tsx</files>
  <action>
Update `src/components/ui/ControlPanel.tsx` to include TemplateGallery:

1. Add import at top:
```tsx
import { TemplateGallery } from './TemplateGallery';
```

2. Add state for save dialog (will be implemented in plan 02-04):
```tsx
const [showSaveDialog, setShowSaveDialog] = useState(false);
```

3. Add a collapsible Templates section in the control panel, positioned above the existing controls. Add this BEFORE the existing `{/* Controls Grid - Responsive */}` section:

```tsx
{/* Templates Section - Collapsible */}
<div className="mb-4 border-b border-white/10 pb-4">
  <button
    onClick={() => setShowTemplates(!showTemplates)}
    className="
      flex items-center justify-between w-full
      text-white/80 hover:text-white
      text-sm font-medium
      py-2
    "
  >
    <span>Templates</span>
    <svg
      className={`w-4 h-4 transition-transform ${showTemplates ? 'rotate-180' : ''}`}
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  {showTemplates && (
    <div className="mt-3">
      <TemplateGallery onSaveNew={() => setShowSaveDialog(true)} />
    </div>
  )}
</div>
```

4. Add state for templates visibility (defaults to collapsed to save space):
```tsx
const [showTemplates, setShowTemplates] = useState(false);
```

5. The save dialog will be added in plan 02-04. For now, the button triggers setState but nothing happens yet.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Start dev server: `npm run dev`
3. Open http://localhost:3000
4. Click "Show Controls" if collapsed
5. "Templates" section appears and expands when clicked
6. 6 built-in presets visible in grid
7. Clicking a preset changes the visual immediately
  </verify>
  <done>TemplateGallery integrated into ControlPanel as collapsible section, clicking templates loads them immediately</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Dev server runs without errors
3. Template gallery shows 6 built-in presets
4. Clicking a preset:
   - Visually highlights the selected card
   - Immediately applies settings (particles/skybox change)
5. "Save Current" button appears in user templates section
</verification>

<success_criteria>
- TemplateCard displays thumbnail, name, description, active state
- TemplateGallery shows built-in presets and user templates separately
- One-click template loading works (TPL-02)
- Active template visually highlighted
- Built-in templates have "PRESET" badge
- Delete button appears only on user templates (on hover)
</success_criteria>

<output>
After completion, create `.planning/phases/02-templates/02-03-SUMMARY.md`
</output>
