---
phase: 02-templates
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/components/ui/AdvancedEditor.tsx
  - src/components/ui/ParameterGroup.tsx
  - src/components/ui/LayerEditor.tsx
  - src/components/ui/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can access full parameter sliders for all visual settings"
    - "Parameters are organized into collapsible groups"
    - "Changing a parameter updates visuals in real-time"
    - "Individual particle layers can be toggled and configured"
  artifacts:
    - path: "src/components/ui/AdvancedEditor.tsx"
      provides: "Full parameter editor with all visual controls"
      exports: ["AdvancedEditor"]
    - path: "src/components/ui/ParameterGroup.tsx"
      provides: "Collapsible accordion component"
      exports: ["ParameterGroup"]
    - path: "src/components/ui/LayerEditor.tsx"
      provides: "Individual particle layer configuration"
      exports: ["LayerEditor"]
  key_links:
    - from: "src/components/ui/AdvancedEditor.tsx"
      to: "src/lib/stores/visualStore.ts"
      via: "useVisualStore hook"
      pattern: "useVisualStore"
---

<objective>
Build advanced parameter editor with full slider access for all visual settings.

Purpose: Enable power users to fine-tune every aspect of the visual engine (TPL-04). Exposes particle layer settings, skybox parameters, and water configuration.

Output: AdvancedEditor component with collapsible parameter groups, individual layer editors, and real-time preview.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-templates/02-RESEARCH.md
@src/components/ui/ControlPanel.tsx
@src/lib/stores/visualStore.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParameterGroup accordion component</name>
  <files>src/components/ui/ParameterGroup.tsx</files>
  <action>
Create `src/components/ui/ParameterGroup.tsx`:

```tsx
'use client';

import { useState, ReactNode } from 'react';

interface ParameterGroupProps {
  title: string;
  defaultOpen?: boolean;
  children: ReactNode;
}

export function ParameterGroup({
  title,
  defaultOpen = false,
  children,
}: ParameterGroupProps) {
  const [isOpen, setIsOpen] = useState(defaultOpen);

  return (
    <div className="border border-white/10 rounded-lg overflow-hidden">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="
          w-full px-3 py-2.5
          flex justify-between items-center
          bg-white/5 hover:bg-white/10
          transition-colors
        "
      >
        <span className="text-white/80 text-sm font-medium">{title}</span>
        <svg
          className={`w-4 h-4 text-white/60 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="p-3 space-y-3 bg-black/20">
          {children}
        </div>
      )}
    </div>
  );
}
```

Simple accordion pattern - touch-friendly, matches existing UI style.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>ParameterGroup component with collapsible accordion behavior</done>
</task>

<task type="auto">
  <name>Task 2: Create LayerEditor component</name>
  <files>src/components/ui/LayerEditor.tsx</files>
  <action>
Create `src/components/ui/LayerEditor.tsx`:

```tsx
'use client';

import { ParticleLayerConfig, FrequencyBand } from '@/types';
import { useVisualStore } from '@/lib/stores/visualStore';

interface LayerEditorProps {
  layer: ParticleLayerConfig;
}

// Slider helper component
function Slider({
  label,
  value,
  min,
  max,
  step,
  onChange,
  unit = '',
}: {
  label: string;
  value: number;
  min: number;
  max: number;
  step: number;
  onChange: (value: number) => void;
  unit?: string;
}) {
  return (
    <div>
      <label className="flex justify-between text-white/60 text-xs mb-1">
        <span>{label}</span>
        <span className="text-white/40">{value.toFixed(step < 1 ? 2 : 0)}{unit}</span>
      </label>
      <input
        type="range"
        min={min}
        max={max}
        step={step}
        value={value}
        onChange={(e) => onChange(parseFloat(e.target.value))}
        className="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
      />
    </div>
  );
}

export function LayerEditor({ layer }: LayerEditorProps) {
  const updateLayer = useVisualStore((state) => state.updateLayer);
  const toggleLayer = useVisualStore((state) => state.toggleLayer);

  const update = (key: keyof ParticleLayerConfig, value: ParticleLayerConfig[typeof key]) => {
    updateLayer(layer.id, { [key]: value });
  };

  const frequencyBands: FrequencyBand[] = ['bass', 'mids', 'treble', 'all'];

  return (
    <div className="border border-white/10 rounded-lg overflow-hidden">
      {/* Layer Header */}
      <div className="flex items-center justify-between px-3 py-2 bg-white/5">
        <span className="text-white/80 text-sm font-medium">{layer.name}</span>
        <button
          onClick={() => toggleLayer(layer.id)}
          className={`
            px-2 py-0.5 text-xs rounded
            ${layer.enabled
              ? 'bg-green-500/30 text-green-300 border border-green-500/50'
              : 'bg-white/10 text-white/50 border border-white/20'
            }
          `}
        >
          {layer.enabled ? 'ON' : 'OFF'}
        </button>
      </div>

      {/* Layer Parameters */}
      {layer.enabled && (
        <div className="p-3 space-y-3 bg-black/20">
          {/* Core Parameters */}
          <div className="grid grid-cols-2 gap-3">
            <Slider
              label="Particles"
              value={layer.particleCount}
              min={5}
              max={200}
              step={5}
              onChange={(v) => update('particleCount', v)}
            />
            <Slider
              label="Base Size"
              value={layer.baseSize}
              min={1}
              max={20}
              step={0.5}
              onChange={(v) => update('baseSize', v)}
            />
            <Slider
              label="Spawn Radius"
              value={layer.spawnRadius}
              min={0.01}
              max={0.5}
              step={0.01}
              onChange={(v) => update('spawnRadius', v)}
            />
            <Slider
              label="Max Speed"
              value={layer.maxSpeed}
              min={0.001}
              max={0.1}
              step={0.001}
              onChange={(v) => update('maxSpeed', v)}
            />
          </div>

          {/* Lifetime Parameters */}
          <div className="border-t border-white/10 pt-3">
            <p className="text-white/50 text-xs mb-2">Lifetime Curve</p>
            <div className="grid grid-cols-2 gap-3">
              <Slider
                label="Lifetime"
                value={layer.lifetime}
                min={0.5}
                max={10}
                step={0.5}
                unit="s"
                onChange={(v) => update('lifetime', v)}
              />
              <Slider
                label="Peak At"
                value={layer.peakLifetime}
                min={0.1}
                max={0.9}
                step={0.05}
                onChange={(v) => update('peakLifetime', v)}
              />
              <Slider
                label="Size @ Birth"
                value={layer.sizeAtBirth}
                min={0}
                max={1}
                step={0.05}
                onChange={(v) => update('sizeAtBirth', v)}
              />
              <Slider
                label="Size @ Peak"
                value={layer.sizeAtPeak}
                min={0.5}
                max={2}
                step={0.1}
                onChange={(v) => update('sizeAtPeak', v)}
              />
              <Slider
                label="Size @ Death"
                value={layer.sizeAtDeath}
                min={0}
                max={1}
                step={0.05}
                onChange={(v) => update('sizeAtDeath', v)}
              />
            </div>
          </div>

          {/* Audio Reactivity */}
          <div className="border-t border-white/10 pt-3">
            <p className="text-white/50 text-xs mb-2">Audio Reactivity</p>
            <div className="grid grid-cols-2 gap-3 items-end">
              <Slider
                label="Reactivity"
                value={layer.audioReactivity}
                min={0}
                max={5}
                step={0.1}
                onChange={(v) => update('audioReactivity', v)}
              />
              <div>
                <label className="text-white/60 text-xs mb-1 block">Frequency Band</label>
                <select
                  value={layer.frequencyBand}
                  onChange={(e) => update('frequencyBand', e.target.value as FrequencyBand)}
                  className="
                    w-full px-2 py-1.5 rounded
                    bg-white/10 border border-white/20
                    text-white text-sm
                    focus:outline-none focus:border-blue-500
                  "
                >
                  {frequencyBands.map((band) => (
                    <option key={band} value={band} className="bg-slate-800">
                      {band.charAt(0).toUpperCase() + band.slice(1)}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

Exposes all layer parameters:
- Core: particleCount, baseSize, spawnRadius, maxSpeed
- Lifetime: lifetime, peakLifetime, sizeAtBirth/Peak/Death
- Audio: reactivity amount, frequency band selection
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>LayerEditor component with full slider access for all particle layer parameters</done>
</task>

<task type="auto">
  <name>Task 3: Create AdvancedEditor component</name>
  <files>src/components/ui/AdvancedEditor.tsx</files>
  <action>
Create `src/components/ui/AdvancedEditor.tsx`:

```tsx
'use client';

import { ParameterGroup } from './ParameterGroup';
import { LayerEditor } from './LayerEditor';
import { useVisualStore } from '@/lib/stores/visualStore';
import { STAR_NEST_PRESETS } from '@/components/canvas/StarNestSkybox';

export function AdvancedEditor() {
  const layers = useVisualStore((state) => state.layers);
  const intensity = useVisualStore((state) => state.intensity);
  const setIntensity = useVisualStore((state) => state.setIntensity);
  const skyboxPreset = useVisualStore((state) => state.skyboxPreset);
  const setSkyboxPreset = useVisualStore((state) => state.setSkyboxPreset);
  const skyboxRotationSpeed = useVisualStore((state) => state.skyboxRotationSpeed);
  const setSkyboxRotationSpeed = useVisualStore((state) => state.setSkyboxRotationSpeed);
  const waterEnabled = useVisualStore((state) => state.waterEnabled);
  const setWaterEnabled = useVisualStore((state) => state.setWaterEnabled);
  const waterColor = useVisualStore((state) => state.waterColor);
  const setWaterColor = useVisualStore((state) => state.setWaterColor);
  const waterReflectivity = useVisualStore((state) => state.waterReflectivity);
  const setWaterReflectivity = useVisualStore((state) => state.setWaterReflectivity);

  return (
    <div className="space-y-2">
      {/* Global Settings */}
      <ParameterGroup title="Global Settings" defaultOpen={true}>
        <div>
          <label className="flex justify-between text-white/60 text-xs mb-1">
            <span>Intensity</span>
            <span className="text-white/40">{intensity.toFixed(2)}</span>
          </label>
          <input
            type="range"
            min={0.1}
            max={2}
            step={0.1}
            value={intensity}
            onChange={(e) => setIntensity(parseFloat(e.target.value))}
            className="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
          />
        </div>
      </ParameterGroup>

      {/* Particle Layers */}
      <ParameterGroup title={`Particle Layers (${layers.length})`}>
        <div className="space-y-2">
          {layers.map((layer) => (
            <LayerEditor key={layer.id} layer={layer} />
          ))}
        </div>
      </ParameterGroup>

      {/* Skybox Settings */}
      <ParameterGroup title="Skybox">
        <div className="space-y-3">
          {/* Preset Selector */}
          <div>
            <label className="text-white/60 text-xs mb-1 block">Skybox Preset</label>
            <select
              value={skyboxPreset.key}
              onChange={(e) => {
                const preset = STAR_NEST_PRESETS.find((p) => p.key === e.target.value);
                if (preset) setSkyboxPreset(preset);
              }}
              className="
                w-full px-2 py-1.5 rounded
                bg-white/10 border border-white/20
                text-white text-sm
                focus:outline-none focus:border-blue-500
              "
            >
              {STAR_NEST_PRESETS.map((preset) => (
                <option key={preset.key} value={preset.key} className="bg-slate-800">
                  {preset.label}
                </option>
              ))}
            </select>
          </div>

          {/* Rotation Speed */}
          <div>
            <label className="flex justify-between text-white/60 text-xs mb-1">
              <span>Rotation Speed</span>
              <span className="text-white/40">{skyboxRotationSpeed.toFixed(1)}x</span>
            </label>
            <input
              type="range"
              min={0}
              max={2}
              step={0.1}
              value={skyboxRotationSpeed}
              onChange={(e) => setSkyboxRotationSpeed(parseFloat(e.target.value))}
              className="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>
      </ParameterGroup>

      {/* Water Settings */}
      <ParameterGroup title="Water">
        <div className="space-y-3">
          {/* Enable Toggle */}
          <div className="flex items-center justify-between">
            <span className="text-white/60 text-sm">Enable Water</span>
            <button
              onClick={() => setWaterEnabled(!waterEnabled)}
              className={`
                px-3 py-1 rounded text-sm
                ${waterEnabled
                  ? 'bg-blue-500/50 text-white border border-blue-400/50'
                  : 'bg-white/10 text-white/60 border border-white/20'
                }
              `}
            >
              {waterEnabled ? 'ON' : 'OFF'}
            </button>
          </div>

          {waterEnabled && (
            <>
              {/* Color */}
              <div className="flex items-center gap-3">
                <span className="text-white/60 text-xs">Color:</span>
                <input
                  type="color"
                  value={waterColor}
                  onChange={(e) => setWaterColor(e.target.value)}
                  className="w-8 h-8 rounded cursor-pointer border border-white/20"
                />
                <span className="text-white/40 text-xs font-mono">{waterColor}</span>
              </div>

              {/* Reflectivity */}
              <div>
                <label className="flex justify-between text-white/60 text-xs mb-1">
                  <span>Reflectivity</span>
                  <span className="text-white/40">{waterReflectivity.toFixed(2)}</span>
                </label>
                <input
                  type="range"
                  min={0}
                  max={1}
                  step={0.05}
                  value={waterReflectivity}
                  onChange={(e) => setWaterReflectivity(parseFloat(e.target.value))}
                  className="w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer"
                />
              </div>
            </>
          )}
        </div>
      </ParameterGroup>
    </div>
  );
}
```

Organizes all parameters into collapsible groups:
- Global Settings (intensity)
- Particle Layers (with LayerEditor for each)
- Skybox (preset selector, rotation speed)
- Water (enable, color, reflectivity)
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>AdvancedEditor component with all visual parameters organized in collapsible groups</done>
</task>

<task type="auto">
  <name>Task 4: Integrate AdvancedEditor into ControlPanel</name>
  <files>src/components/ui/ControlPanel.tsx</files>
  <action>
Update `src/components/ui/ControlPanel.tsx` to include AdvancedEditor:

1. Add import:
```tsx
import { AdvancedEditor } from './AdvancedEditor';
```

2. Add state for advanced editor visibility:
```tsx
const [showAdvanced, setShowAdvanced] = useState(false);
```

3. Add Advanced Editor section after Templates section (before existing Controls Grid):

```tsx
{/* Advanced Editor - Collapsible */}
<div className="mb-4 border-b border-white/10 pb-4">
  <button
    onClick={() => setShowAdvanced(!showAdvanced)}
    className="
      flex items-center justify-between w-full
      text-white/80 hover:text-white
      text-sm font-medium
      py-2
    "
  >
    <span>Advanced Editor</span>
    <svg
      className={`w-4 h-4 transition-transform ${showAdvanced ? 'rotate-180' : ''}`}
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  {showAdvanced && (
    <div className="mt-3 max-h-[50vh] overflow-y-auto pr-2">
      <AdvancedEditor />
    </div>
  )}
</div>
```

4. Remove duplicate skybox/water controls from the existing Controls Grid since they're now in AdvancedEditor. Keep only the ModeSelector and PresetSelector in the simplified view.

The layout becomes:
- Templates (collapsible)
- Advanced Editor (collapsible)
- Mode & Preset selectors (always visible when panel open)
- Debug/Audio overlay toggle
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Start dev server: `npm run dev`
3. Open http://localhost:3000
4. Expand "Advanced Editor" section
5. All parameter groups appear (Global, Particle Layers, Skybox, Water)
6. Changing a slider updates visuals in real-time
7. Each particle layer can be toggled on/off
  </verify>
  <done>AdvancedEditor integrated into ControlPanel as collapsible section, all parameters accessible with real-time preview</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Dev server runs without errors
3. Advanced Editor section expandable in ControlPanel
4. Parameter groups collapsible (accordion behavior)
5. All particle layer parameters adjustable
6. Changes reflected immediately in visuals
7. Skybox preset can be changed
8. Water can be enabled/disabled and configured
</verification>

<success_criteria>
- ParameterGroup provides accordion UI pattern
- LayerEditor exposes all ParticleLayerConfig fields
- AdvancedEditor organizes parameters into logical groups
- Real-time visual feedback on parameter changes
- Complete TPL-04: Advanced parameter editor with full slider access
</success_criteria>

<output>
After completion, create `.planning/phases/02-templates/02-05-SUMMARY.md`
</output>
