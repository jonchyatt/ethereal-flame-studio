---
phase: 17-integration-wiring-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "src/app/api/audio/ingest/[jobId]/route.ts"
  - "src/app/api/audio/edit/save/[jobId]/route.ts"
  - "src/app/api/audio/edit/preview/[jobId]/route.ts"
autonomous: true
requirements:
  - JOB-01
  - JOB-03
  - JOB-04

must_haves:
  truths:
    - "Polling /api/audio/ingest/<jobId> returns 200 with job status for jobs created by the async POST route"
    - "Polling /api/audio/edit/save/<jobId> returns 200 with job status for jobs created by the async POST route"
    - "Polling /api/audio/edit/preview/<jobId> returns 200 with job status for jobs created by the async POST route"
    - "DELETE on any of the 3 legacy routes transitions the job to cancelled via the shared JobStore"
    - "Polling a non-existent jobId returns 404"
  artifacts:
    - path: "src/app/api/audio/ingest/[jobId]/route.ts"
      provides: "Ingest poll/cancel route using getJobStore()"
      contains: "getJobStore"
    - path: "src/app/api/audio/edit/save/[jobId]/route.ts"
      provides: "Save poll/cancel route using getJobStore()"
      contains: "getJobStore"
    - path: "src/app/api/audio/edit/preview/[jobId]/route.ts"
      provides: "Preview poll/cancel route using getJobStore()"
      contains: "getJobStore"
  key_links:
    - from: "src/app/api/audio/ingest/[jobId]/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() factory import"
      pattern: "import.*getJobStore.*from.*@/lib/jobs"
    - from: "src/app/api/audio/edit/save/[jobId]/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() factory import"
      pattern: "import.*getJobStore.*from.*@/lib/jobs"
    - from: "src/app/api/audio/edit/preview/[jobId]/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() factory import"
      pattern: "import.*getJobStore.*from.*@/lib/jobs"
---

<objective>
Rewire 3 legacy poll/cancel API routes from the deprecated in-memory `audioPrepJobs` (JobManager) to the `getJobStore()` factory so that job state queries hit the same persistent store used by the worker and the newer API routes.

Purpose: Closes CRIT-01 from the v2.0 milestone audit. Without this fix, polling legacy routes returns 404 for jobs that were created by the async POST routes (which already write to JobStore).

Output: Three route files updated to use `getJobStore()` with consistent response shape matching `/api/audio/jobs/[jobId]`.
</objective>

<execution_context>
@C:/Users/jonch/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jonch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-integration-wiring-fixes/17-CONTEXT.md

# Reference pattern (the correct poll route):
@src/app/api/audio/jobs/[jobId]/route.ts

# Reference pattern (the correct cancel route):
@src/app/api/audio/jobs/[jobId]/cancel/route.ts

# The 3 legacy routes to fix:
@src/app/api/audio/ingest/[jobId]/route.ts
@src/app/api/audio/edit/save/[jobId]/route.ts
@src/app/api/audio/edit/preview/[jobId]/route.ts

# Factory:
@src/lib/jobs/index.ts
@src/lib/jobs/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire ingest poll/cancel route to getJobStore()</name>
  <files>src/app/api/audio/ingest/[jobId]/route.ts</files>
  <action>
Replace the entire contents of `src/app/api/audio/ingest/[jobId]/route.ts`:

1. Remove the `import { audioPrepJobs } from '@/lib/audio-prep/JobManager'` import.
2. Add `import { getJobStore } from '@/lib/jobs'` instead.
3. Rewrite the `GET` handler:
   - Call `const store = getJobStore()` then `const job = await store.get(jobId)`.
   - If `!job`, return `NextResponse.json({ error: 'Job not found' }, { status: 404 })`.
   - On success, return `NextResponse.json({ jobId: job.jobId, type: job.type, status: job.status, progress: job.progress, stage: job.stage, result: job.result, error: job.error, createdAt: job.createdAt, updatedAt: job.updatedAt })`.
   - Wrap in try/catch returning 500 on error, matching the pattern in `/api/audio/jobs/[jobId]/route.ts`.
4. Rewrite the `DELETE` handler:
   - Call `const store = getJobStore()` then `const job = await store.get(jobId)`.
   - If `!job`, return 404 with `{ error: 'Job not found' }`.
   - If job is in a terminal state (`complete`, `failed`, `cancelled`), return 409 with `{ error: 'Job already in terminal state', status: job.status }`.
   - Call `await store.cancel(jobId)`.
   - Return `NextResponse.json({ jobId, status: 'cancelled', message: 'Job cancellation requested' })`.
   - Wrap in try/catch returning 500 on error.

The response shape should match `/api/audio/jobs/[jobId]` for the GET handler and `/api/audio/jobs/[jobId]/cancel` for the DELETE handler. Keep the existing HTTP semantics: 404 for missing, 200 for found, 409 for terminal cancel attempt.

Do NOT keep the old `{ success: true/false, data: {...} }` wrapper -- use the flat response shape that the newer routes use.
  </action>
  <verify>
Run `npx tsc --noEmit --project tsconfig.json` (or the project's TS check command) and confirm no type errors in the modified file. Grep the file to confirm no remaining imports from `@/lib/audio-prep/JobManager`.
  </verify>
  <done>
`src/app/api/audio/ingest/[jobId]/route.ts` imports `getJobStore` from `@/lib/jobs`, has no reference to `audioPrepJobs` or `JobManager`, and both GET and DELETE handlers use the persistent JobStore with consistent response shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire edit/save and edit/preview poll/cancel routes to getJobStore()</name>
  <files>
src/app/api/audio/edit/save/[jobId]/route.ts
src/app/api/audio/edit/preview/[jobId]/route.ts
  </files>
  <action>
Apply the exact same transformation to both files as described in Task 1:

For **`src/app/api/audio/edit/save/[jobId]/route.ts`**:
1. Remove `import { audioPrepJobs } from '@/lib/audio-prep/JobManager'`.
2. Add `import { getJobStore } from '@/lib/jobs'`.
3. Rewrite GET: `store.get(jobId)` -> 404 or 200 with flat response shape (jobId, type, status, progress, stage, result, error, createdAt, updatedAt).
4. Rewrite DELETE: `store.get(jobId)` -> 404, terminal check -> 409, `store.cancel(jobId)` -> 200 with `{ jobId, status: 'cancelled', message: 'Job cancellation requested' }`.
5. Both handlers wrapped in try/catch with 500 error response.

For **`src/app/api/audio/edit/preview/[jobId]/route.ts`**:
1. Identical transformation as the save route above.

Both files should end up nearly identical in structure to the rewritten ingest route from Task 1. The only difference is the file path.

Do NOT remove or modify any other files in `src/app/api/audio/edit/` -- only the `[jobId]/route.ts` files. The POST routes (`edit/save/route.ts`, `edit/preview/route.ts`) are separate and should not be touched.
  </action>
  <verify>
Run `npx tsc --noEmit --project tsconfig.json` and confirm no type errors. Grep all 3 modified files to confirm zero remaining imports from `@/lib/audio-prep/JobManager`. Grep for `getJobStore` to confirm all 3 files use the factory.
  </verify>
  <done>
Both `src/app/api/audio/edit/save/[jobId]/route.ts` and `src/app/api/audio/edit/preview/[jobId]/route.ts` import `getJobStore` from `@/lib/jobs`, have no reference to `audioPrepJobs` or `JobManager`, and both GET and DELETE handlers use the persistent JobStore with consistent response shapes.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit` passes with zero errors
2. `grep -r "audioPrepJobs" src/app/api/audio/ingest/[jobId]/ src/app/api/audio/edit/save/[jobId]/ src/app/api/audio/edit/preview/[jobId]/` returns no matches
3. `grep -r "getJobStore" src/app/api/audio/ingest/[jobId]/ src/app/api/audio/edit/save/[jobId]/ src/app/api/audio/edit/preview/[jobId]/` returns 3 matches (one per file)
4. `npm run build` succeeds (Next.js build verifies route exports)
</verification>

<success_criteria>
- All 3 legacy poll routes return job status from the persistent JobStore (not the deprecated in-memory Map)
- All 3 legacy cancel routes transition jobs via `store.cancel()` in the persistent JobStore
- Response shapes are consistent with `/api/audio/jobs/[jobId]` and `/api/audio/jobs/[jobId]/cancel`
- No imports from `@/lib/audio-prep/JobManager` remain in the 3 route files
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-integration-wiring-fixes/17-01-SUMMARY.md`
</output>
