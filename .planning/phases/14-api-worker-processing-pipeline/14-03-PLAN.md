---
phase: 14-api-worker-processing-pipeline
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/webhooks/worker/route.ts
  - src/app/api/audio/assets/[id]/stream/route.ts
autonomous: true
requirements: [API-03, API-04, SEC-01]

must_haves:
  truths:
    - "POST /api/webhooks/worker rejects requests without a valid INTERNAL_WEBHOOK_SECRET header with 401"
    - "POST /api/webhooks/worker accepts valid callbacks and updates job state via JobStore"
    - "Audio streaming endpoint serves from R2 in production (signed URL redirect) and local filesystem in development"
  artifacts:
    - path: "src/app/api/webhooks/worker/route.ts"
      provides: "Webhook endpoint with INTERNAL_WEBHOOK_SECRET validation"
      contains: "INTERNAL_WEBHOOK_SECRET"
    - path: "src/app/api/audio/assets/[id]/stream/route.ts"
      provides: "Audio streaming with transparent local/R2 support"
      contains: "getSignedUrl"
  key_links:
    - from: "src/app/api/webhooks/worker/route.ts"
      to: "src/lib/jobs/index.ts"
      via: "getJobStore() to update job on callback"
      pattern: "getJobStore.*complete"
    - from: "src/app/api/audio/assets/[id]/stream/route.ts"
      to: "src/lib/storage/index.ts"
      via: "getStorageAdapter().getSignedUrl() for R2 redirect"
      pattern: "getSignedUrl"
---

<objective>
Create the webhook endpoint for worker/Modal callbacks with INTERNAL_WEBHOOK_SECRET validation, and verify the audio streaming endpoint is cloud-ready.

Purpose: The webhook endpoint is the inbound channel for the Render.com worker and (later) Modal to report job completion or failure. It must validate the shared secret before processing any callback. The streaming endpoint already exists but needs a minor review to confirm it handles both local and R2 transparently -- this is critical for the frontend to play audio from either environment.

Output: A secure webhook POST endpoint that processes job completion callbacks, and a verified streaming endpoint.
</objective>

<execution_context>
@C:/Users/jonch/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jonch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-job-state-worker-infra/13-02-SUMMARY.md
@src/lib/jobs/types.ts
@src/lib/jobs/index.ts
@src/lib/storage/index.ts
@src/app/api/audio/assets/[id]/stream/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook endpoint with INTERNAL_WEBHOOK_SECRET validation</name>
  <files>
    src/app/api/webhooks/worker/route.ts
  </files>
  <action>
Create `src/app/api/webhooks/worker/route.ts` with a POST handler that:

1. **Secret validation (SEC-01):**
   - Read `INTERNAL_WEBHOOK_SECRET` from `process.env`
   - If the env var is not set, return 500 with `{ error: 'Webhook secret not configured' }`
   - Read the `authorization` header from the request (format: `Bearer {secret}`)
   - If header is missing or the secret does not match, return 401 with `{ error: 'Unauthorized' }`
   - Use constant-time comparison via `crypto.timingSafeEqual()` to prevent timing attacks

2. **Payload processing:**
   - Parse JSON body with Zod schema:
   ```typescript
   const WebhookPayloadSchema = z.object({
     jobId: z.string().uuid(),
     status: z.enum(['complete', 'failed']),
     result: z.record(z.unknown()).optional(),
     error: z.string().optional(),
   });
   ```
   - Validate that the job exists via `getJobStore().get(jobId)`
   - If job not found, return 404
   - If `status === 'complete'` and `result` provided: call `store.complete(jobId, result)`
   - If `status === 'failed'` and `error` provided: call `store.fail(jobId, error)`
   - Return 200 with `{ success: true }`

3. **Logging:**
   - Log webhook receipt: `[Webhook] Received callback for job {jobId}: {status}`
   - Log validation failures: `[Webhook] Unauthorized request from {ip}`

The endpoint lives at `/api/webhooks/worker` -- not under `/api/audio/` since it may serve both audio prep and render webhooks in the future.

Import `z` from `zod`, `crypto` from `crypto`, `getJobStore` from `@/lib/jobs`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the route compiles. Grep for `INTERNAL_WEBHOOK_SECRET` in the file to confirm secret validation. Grep for `timingSafeEqual` to confirm constant-time comparison.
  </verify>
  <done>
Webhook endpoint at `/api/webhooks/worker` validates INTERNAL_WEBHOOK_SECRET before processing callbacks. Invalid/missing secrets return 401. Valid callbacks update job state via JobStore. Timing-safe comparison prevents secret enumeration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and harden audio streaming endpoint for cloud readiness</name>
  <files>
    src/app/api/audio/assets/[id]/stream/route.ts
  </files>
  <action>
The streaming endpoint at `/api/audio/assets/[id]/stream/route.ts` already redirects to the storage adapter's signed URL (implemented in Phase 12-02). Review and make these targeted improvements:

1. **Prepared file support:** Currently the route only looks for `original*` files. For the cloud pipeline, the frontend may also want to stream the prepared (edited) audio. Add optional query parameter `?variant=prepared` (default: `original`):
   - `variant=original` (default): look for files starting with `original` (current behavior)
   - `variant=prepared`: look for files starting with `prepared`
   - This allows the frontend to stream either the raw upload or the edited output

2. **Storage backend-aware response:** The current implementation always does `NextResponse.redirect(signedUrl, 302)`. For R2, this is correct (CDN offload). For local, a redirect to the download route also works. Confirm the behavior is correct for both backends by checking the signed URL format.

3. **Cache headers:** Add `Cache-Control: public, max-age=3600` header to the redirect response. The signed URL itself handles access control, so caching the redirect is safe for short durations.

4. **Error handling:** If the storage key is not found, return a clear 404 with `{ error: 'Audio file not found for this asset' }`. Currently this is handled but could be more descriptive about which variant was requested.

Keep the existing import structure. This is a small enhancement, not a rewrite.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the route compiles. Verify the `variant` query parameter handling exists via grep for `variant`. Verify the route still uses `getSignedUrl` for both local and R2.
  </verify>
  <done>
Audio streaming endpoint serves from R2 in production and local filesystem in development, transparently. Supports both original and prepared audio variants via query parameter. Cache headers set appropriately.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/app/api/webhooks/worker/route.ts` exists and contains `INTERNAL_WEBHOOK_SECRET` validation
3. `grep "timingSafeEqual" src/app/api/webhooks/worker/route.ts` returns a match
4. `grep "variant" src/app/api/audio/assets/\[id\]/stream/route.ts` returns a match
5. Both routes compile and use the correct adapters (JobStore for webhook, StorageAdapter for stream)
</verification>

<success_criteria>
- Webhook endpoint rejects requests without valid INTERNAL_WEBHOOK_SECRET with 401
- Webhook endpoint processes valid callbacks and updates job state
- Audio streaming endpoint works transparently for both local and R2 backends
- Streaming endpoint supports both original and prepared audio variants
- TypeScript compilation passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/14-api-worker-processing-pipeline/14-03-SUMMARY.md`
</output>
