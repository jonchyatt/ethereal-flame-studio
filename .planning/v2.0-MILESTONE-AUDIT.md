---
milestone: v2.0
name: Cloud Production
audited: 2026-02-22T23:30:00Z
status: gaps_found
scores:
  requirements: 24/24
  phases: 7/7
  integration: 22/24
  flows: 3/5
gaps:
  integration:
    - id: "INT-01"
      severity: critical
      route: "GET/DELETE/PATCH /api/render/[id]"
      file: "src/app/api/render/[id]/route.ts"
      description: "Uses ServerJobStore (in-memory silo) instead of getJobStore(). Jobs created via POST /api/render go into the shared Turso/SQLite store; this endpoint reads from a separate in-memory store never written to. Always returns 404 for real render jobs."
      affected_requirements: ["JOB-03", "JOB-04"]
      fix: "Replace ServerJobStore import with getJobStore() factory in all handlers"
    - id: "INT-02"
      severity: high
      route: "POST /api/audio/ingest (JSON path)"
      file: "src/app/api/audio/ingest/route.ts"
      description: "JsonIngestSchema discriminated union only accepts 'youtube' and 'url'. File uploads send { type: 'audio_file', storageKey, ... } but Zod rejects this with 'Invalid discriminator value'. AudioPrepEditor fallback checks for 'storageKey' in the error message — condition never matches. File and video uploads from the UI always fail after storage upload succeeds."
      affected_requirements: ["WORK-02"]
      fix: "Add 'audio_file' and 'video_file' variants to JsonIngestSchema discriminated union"
  flows:
    - id: "FLOW-01-FILE-BREAK"
      flow: "Audio Ingest (File Upload)"
      break_at: "Step 1b — ingest job creation"
      description: "Frontend POSTs { type: 'audio_file', storageKey } to /api/audio/ingest. Zod rejects the discriminant. Fallback multipart condition never triggers. Job never created. YouTube and direct URL ingests unaffected."
    - id: "FLOW-03-RENDER-POLL-BREAK"
      flow: "GPU Render (Status via /api/render/[id])"
      break_at: "Step 5 — status polling via /api/render/[id]"
      description: "GET /api/render/[id] always returns 404. Polling via canonical GET /api/audio/jobs/[jobId] works correctly. Any consumer relying on the render-specific detail endpoint is broken."
tech_debt:
  - phase: 12-cloud-storage-adapter
    items:
      - "(this.storage as any).resolveKey cast in AudioAssetService.ts — transitional, @deprecated getAssetDir documented"
      - "download/route.ts reads STORAGE_BACKEND env directly for response branching — minor adapter abstraction leak, harmless"
  - phase: 13-job-state-worker-infra
    items:
      - "worker/process-job.ts: placeholder dispatch comments — expected, wired in Phase 14"
  - phase: 17-integration-wiring-fixes
    items:
      - "Legacy poll endpoints (/ingest/[jobId], /edit/preview/[jobId], /edit/save/[jobId]) return raw job record but omit downloadUrl computation — current UI tolerates this, future consumers may not"
      - "worker/index.ts comment references TursoJobStore by name — comment only, no import"
  - phase: 18-api-completeness-timeout-accuracy
    items:
      - "render/route.ts design note about JobStore.update metadata limitation — pre-existing"
      - "src/app/api/render/[id]/route.ts: ServerJobStore import — pre-existing, root cause of INT-01"
---

# v2.0 Milestone Audit — Gaps Found

**Milestone:** v2.0 Cloud Production
**Audited:** 2026-02-22
**Status:** gaps_found
**Phases:** 12, 13, 14, 15, 16, 17, 18 (7 phases)

---

## Executive Summary

All 24 v2.0 requirements are satisfied at the code level across all 7 phases. Phase verifications all passed. Cross-phase integration checking identified **2 wiring gaps** that break end-user behavior:

1. **INT-01 (Critical):** `GET /api/render/[id]` reads from `ServerJobStore` (in-memory silo), disconnected from `getJobStore()`. Render job status/cancel via this endpoint always returns 404.
2. **INT-02 (High):** Ingest API JSON schema only accepts `youtube` and `url` discriminants. File uploads (`audio_file`/`video_file`) are rejected; the UI fallback condition never fires. File uploads from the UI always fail.

These two issues were not caught in phase-level verification because each phase verified its own code in isolation — the cross-phase schema contract between the UI and the ingest route, and the disconnected render/[id] silo, only surface as integration gaps.

---

## Requirements Coverage (3-Source Cross-Reference)

| Requirement | Phase | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final Status |
|-------------|-------|-------------|---------|-----------------|--------------|
| STOR-01 | 12 | passed | 12-01, 12-02 | [x] | **satisfied** |
| STOR-02 | 12 | passed | 12-01, 12-02 | [x] | **satisfied** |
| STOR-03 | 12 | passed | 12-01, 12-02 | [x] | **satisfied** |
| STOR-04 | 12 | passed | 12-03 | [x] | **satisfied** |
| JOB-01 | 17 | passed (also 13) | 13-01, 17-01 | [x] | **satisfied** |
| JOB-02 | 13 | passed | 13-03 | [x] | **satisfied** |
| JOB-03 | 17 | passed (also 13) | 13-02, 17-01 | [x] | **satisfied** ⚠ INT-01 affects render-specific poll path |
| JOB-04 | 17 | passed (also 13) | 13-02, 17-01 | [x] | **satisfied** ⚠ INT-01 affects render-specific cancel path |
| JOB-05 | 18 | passed (also 13) | 13-03, 18-02 | [x] | **satisfied** |
| WORK-01 | 13 | passed | 13-03 | [x] | **satisfied** |
| WORK-02 | 14 | passed | 14-02 | [x] | **satisfied** ⚠ INT-02 breaks file upload path from UI |
| WORK-03 | 14 | passed | 14-02 | [x] | **satisfied** |
| WORK-04 | 15 | passed | 15-01 | [x] | **satisfied** |
| WORK-05 | 15 | passed | 15-02 | [x] | **satisfied** |
| API-01 | 14 | passed | 14-01 | [x] | **satisfied** |
| API-02 | 18 | passed (also 14) | 14-01, 18-01 | [x] | **satisfied** ⚠ Legacy poll endpoints omit downloadUrl |
| API-03 | 14 | passed | 14-03 | [x] | **satisfied** |
| API-04 | 14 | passed | 14-03 | [x] | **satisfied** |
| DEPLOY-01 | 17 | passed (also 16) | 16-01, 17-02 | [x] | **satisfied** |
| DEPLOY-02 | 16 | passed | 16-01 | [x] | **satisfied** |
| DEPLOY-03 | 16 | passed | 16-02 | [x] | **satisfied** |
| DEPLOY-04 | 16 | passed | 16-03 | [x] | **satisfied** |
| SEC-01 | 14 | passed | 14-03 | [x] | **satisfied** |
| SEC-02 | 14 | passed | 14-02 | [x] | **satisfied** |

**Score:** 24/24 requirements satisfied at code level

**Orphan detection:** All 24 requirement IDs from the traceability table appear in at least one phase VERIFICATION.md. **No orphaned requirements.**

---

## Phase Verifications Summary

| Phase | Name | Status | Score | Notes |
|-------|------|--------|-------|-------|
| 12 | Cloud Storage Adapter | ✅ passed | 16/16 | 2 human tests (XHR progress, live R2) |
| 13 | Job State + Worker Infra | ✅ passed | 7/7 | No human tests required |
| 14 | API + Worker Processing Pipeline | ✅ passed | 12/12 | 3 human tests (E2E ingest, webhook, stream) |
| 15 | Modal Render Dispatch | ✅ passed | 7/7 | 2 human tests (E2E GPU render, failure handling) |
| 16 | Production Deploy + CI/CD | ✅ passed | 7/7 | No human tests required |
| 17 | Integration Wiring Fixes | ⚠ human_needed | 9/10 | 1 E2E runtime test pending; requirements all SATISFIED |
| 18 | API Completeness + Timeout Accuracy | ✅ passed | 7/7 | No human tests required |

All 7 phases verified. No phase is missing a VERIFICATION.md.

---

## Integration Findings

### INT-01 — Critical: `GET /api/render/[id]` reads from disconnected ServerJobStore

**File:** `src/app/api/render/[id]/route.ts` (line 13: `import { ServerJobStore }`)
**Root cause:** `POST /api/render` creates jobs in the shared `getJobStore()` (Turso/SQLite). `GET/DELETE/PATCH /api/render/[id]` all read/write to `ServerJobStore` — a separate in-memory store that is never populated by the current pipeline. Every call to the render-specific detail/cancel/progress endpoints returns 404 for any real job.

**Safe path exists:** `GET /api/audio/jobs/[jobId]` (canonical endpoint) correctly uses `getJobStore()` and returns render status including `downloadUrl`. Consumers using the canonical endpoint are unaffected.

**Affected requirements:** JOB-03 (render status polling), JOB-04 (render cancel)

**Fix:** In `src/app/api/render/[id]/route.ts`, remove `ServerJobStore` import; replace with `getJobStore()` calls in GET, DELETE, and PATCH handlers. Also remove or update any Modal-polling fallback code that was designed for the in-memory job model.

---

### INT-02 — High: File upload ingest path broken in UI

**Files:** `src/app/api/audio/ingest/route.ts` (lines 13-23), `src/components/ui/AudioPrepEditor.tsx` (lines 267-290)
**Root cause:** The `JsonIngestSchema` uses a `z.discriminatedUnion` on `type` with variants `'youtube'` and `'url'` only. The UI's upload flow sends `{ type: 'audio_file', storageKey, originalFilename, contentType }` after completing the two-step presigned upload. Zod rejects this with "Invalid discriminator value". The UI fallback at `AudioPrepEditor.tsx:281` checks `data.error?.message?.includes('storageKey')` — this string is never in Zod's error output, so the multipart fallback is permanently skipped.

**Net result:** File and video uploads from the UI always fail after storage upload succeeds. YouTube URL and direct URL ingests are entirely unaffected. The worker pipeline code for `audio_file`/`video_file` is correct — the gap is solely in the API route schema.

**Affected requirements:** WORK-02 (file upload source type)

**Fix option A:** Add `'audio_file'` and `'video_file'` variants to `JsonIngestSchema`.
**Fix option B:** Update the fallback condition in `AudioPrepEditor.tsx` to match Zod's actual error string (e.g., check `statusCode === 400` or discriminant value mismatch).

---

### INT-03 — Medium: Legacy poll endpoints omit `downloadUrl` (tolerated)

**Files:** `src/app/api/audio/ingest/[jobId]/route.ts`, `src/app/api/audio/edit/preview/[jobId]/route.ts`, `src/app/api/audio/edit/save/[jobId]/route.ts`

These endpoints return the raw job record without calling `storage.getSignedUrl()` to synthesize a `downloadUrl`. The canonical endpoint `GET /api/audio/jobs/[jobId]` does this correctly. Current `AudioPrepEditor.tsx` reads `data.data.result.assetId` directly and is functionally tolerant. This is a schema inconsistency between poll paths, not a blocker for current UI behavior.

**Affected requirements:** API-02 (partial — legacy endpoints incomplete vs. canonical)

---

## E2E Flow Assessment

| Flow | Status | Notes |
|------|--------|-------|
| FLOW-01a: YouTube/URL Ingest | ✅ Complete | Full pipeline verified |
| FLOW-01b: File Upload Ingest | ❌ Broken | INT-02 breaks at ingest job creation (JSON schema) |
| FLOW-02: Audio Edit + Save | ✅ Complete | Preview + save pipeline fully wired |
| FLOW-03a: GPU Render (canonical poll) | ✅ Complete | Uses /api/audio/jobs/[jobId], works end-to-end |
| FLOW-03b: GPU Render (render detail poll) | ❌ Broken | INT-01 — /api/render/[id] always 404 |

---

## Tech Debt (Non-Critical)

### Phase 12
- `(this.storage as any).resolveKey` cast in AudioAssetService — transitional, `@deprecated getAssetDir()` documented
- `download/route.ts` reads `STORAGE_BACKEND` env directly for response shape — minor adapter abstraction leak, harmless

### Phase 17
- Legacy poll endpoints return raw job record without `downloadUrl` — current UI tolerates; future consumers may need canonical endpoint
- `worker/index.ts` comment references TursoJobStore by name — comment only

### Phase 18
- `render/route.ts` design note about `JobStore.update` metadata limitation — workaround documented, pre-existing
- `src/app/api/render/[id]/route.ts` — pre-existing `ServerJobStore` import (root cause of INT-01)

**Total: 6 non-critical debt items across 3 phases**

---

## Gap Closure Required

Two fixes needed to bring milestone to `passed`:

| Fix | File | Change | Effort |
|-----|------|--------|--------|
| Fix INT-02 (ingest schema) | `src/app/api/audio/ingest/route.ts` | Add `audio_file` + `video_file` variants to JsonIngestSchema | ~30 min |
| Fix INT-01 (render/[id]) | `src/app/api/render/[id]/route.ts` | Replace ServerJobStore with getJobStore() | ~45 min |

---

_Audited: 2026-02-22_
_Auditor: Claude (gsd-audit-milestone)_
_Integration checker: Claude (gsd-integration-checker)_
