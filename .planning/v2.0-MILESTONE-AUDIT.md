---
milestone: v2.0
name: Cloud Production
audited: 2026-02-22T00:00:00Z
status: gaps_found
scores:
  requirements: 20/24
  phases: 5/5
  integration: 16/24
  flows: 0/4
gaps:
  requirements:
    - id: "JOB-01"
      status: "partial"
      phase: "13"
      claimed_by_plans: ["13-01-PLAN.md"]
      completed_by_plans: ["13-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "VERIFICATION passed for phase 13. Integration check found worker/index.ts hardcodes TursoJobStore (bypasses factory) and 3 legacy poll routes use in-memory JobManager instead of getJobStore(). JOB-01 is partially satisfied at the code level but cross-phase integration is broken."
    - id: "JOB-03"
      status: "partial"
      phase: "13"
      claimed_by_plans: ["13-02-PLAN.md"]
      completed_by_plans: ["13-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Canonical /api/audio/jobs/[jobId] works. Legacy per-feature poll routes (/ingest/[jobId], /edit/save/[jobId], /edit/preview/[jobId]) use audioPrepJobs (in-memory) and return 404 for jobs created by the async routes."
    - id: "JOB-04"
      status: "partial"
      phase: "13"
      claimed_by_plans: ["13-02-PLAN.md"]
      completed_by_plans: ["13-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Canonical cancel at /api/audio/jobs/[jobId]/cancel works. Legacy DELETE routes on per-feature paths call audioPrepJobs.cancel() on in-memory store — does not reach worker."
    - id: "JOB-05"
      status: "partial"
      phase: "13"
      claimed_by_plans: ["13-03-PLAN.md"]
      completed_by_plans: ["13-03-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Per-type timeouts (ingest:10m, preview:5m, save:15m) are configured in JOB_TIMEOUTS but worker/reaper.ts line 23 uses only timeouts.default. markStaleJobsFailed() takes a scalar. All job types timeout at 10 min regardless of configuration."
    - id: "API-02"
      status: "partial"
      phase: "14"
      claimed_by_plans: ["14-01-PLAN.md"]
      completed_by_plans: ["14-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Poll endpoint checks result.videoKey/previewKey/preparedKey for downloadUrl. Ingest pipeline stores result.assetId (not a storage key). No downloadUrl surfaced for completed ingest jobs. Asset accessible via /api/audio/assets/[id]/stream but poll response doesn't surface that URL."
    - id: "DEPLOY-01"
      status: "partial"
      phase: "16"
      claimed_by_plans: ["16-01-PLAN.md"]
      completed_by_plans: ["16-01-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Web app routes correctly switch via DEPLOY_ENV. worker/index.ts hardcodes TursoJobStore and calls process.exit(1) if TURSO_DATABASE_URL is missing. DEPLOY_ENV has no effect on the worker. Local worker dev requires Turso credentials even with DEPLOY_ENV unset."
  integration:
    - id: "CRIT-01"
      description: "Legacy job-status poll routes use in-memory JobManager instead of getJobStore()"
      affected_files:
        - "src/app/api/audio/ingest/[jobId]/route.ts"
        - "src/app/api/audio/edit/save/[jobId]/route.ts"
        - "src/app/api/audio/edit/preview/[jobId]/route.ts"
      affected_reqs: ["JOB-01", "JOB-03", "JOB-04", "API-01", "API-02"]
      severity: critical
    - id: "CRIT-02"
      description: "Worker hardcodes TursoJobStore — bypasses DEPLOY_ENV toggle, breaks local dev"
      affected_files:
        - "worker/index.ts"
      affected_reqs: ["DEPLOY-01", "JOB-01", "JOB-02"]
      severity: critical
  flows:
    - id: "FLOW-01"
      name: "Audio Ingest Flow"
      breaks_at: "Legacy poll route /api/audio/ingest/[jobId] returns 404 (reads in-memory store)"
      affected_reqs: ["API-01", "API-02", "JOB-03"]
    - id: "FLOW-02"
      name: "Audio Edit + Save Flow"
      breaks_at: "Legacy poll route /api/audio/edit/save/[jobId] returns 404 (reads in-memory store)"
      affected_reqs: ["API-01", "API-02", "JOB-03"]
tech_debt:
  - phase: "15-modal-render-dispatch"
    items:
      - "scripts/modal-render-entry.ts uses standalone S3Client instead of StorageAdapter factory for video upload — functionally equivalent but bypasses abstraction pattern"
  - phase: "13-job-state-worker-infra"
    items:
      - "Per-type job timeouts (JOB_TIMEOUTS map) configured but silently ignored by reaper — all types use default 10min"
  - phase: "14-api-worker-processing-pipeline"
    items:
      - "audioStorageKey stored in job.result as workaround (not in metadata) — acknowledged in code comment, worker has fallback"
  - phase: "16-production-deploy-ci-cd"
    items:
      - "GET /api/render lists jobs from legacy in-memory ServerJobStore — render job listing always returns empty results"
      - "DEPLOY_PROD_CHECKLIST.md confirmed present via phase summary but not directly verified in audit"
  - phase: "12-cloud-storage-adapter"
    items:
      - "Duck-typing cast (this.storage as any).resolveKey in AudioAssetService — transitional, documented, non-blocking"
      - "R2 integration and upload progress bar require human verification in live environment"
---

# Milestone v2.0: Cloud Production — Audit Report

**Milestone Goal:** Move the entire pipeline to production cloud infrastructure so the app works from any device with no local machine dependencies.

**Architecture:** Vercel (web/API) + Render.com (CPU worker) + Turso (state) + Cloudflare R2 (storage) + Modal (GPU render)

**Audited:** 2026-02-22
**Status:** GAPS_FOUND
**Phases audited:** 5 (12, 13, 14, 15, 16) — all have VERIFICATION.md, all passed phase-level checks
**Requirements:** 24 total — 18 fully satisfied, 6 partial

---

## Overall Scores

| Dimension | Score | Notes |
|-----------|-------|-------|
| Requirements | 18/24 satisfied | 6 partial due to integration gaps |
| Phase verifications | 5/5 passed | All individual phase verifications passed |
| Cross-phase wiring | 16/24 WIRED | 2 critical wiring gaps found |
| E2E flows | 0/4 clean | All 4 flows have at least one gap |

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | Phase | VERIFICATION.md | REQUIREMENTS.md | Final Status |
|--------|-------------|-------|-----------------|-----------------|--------------|
| STOR-01 | Upload/download via unified adapter (R2 prod / local dev) | 12 | SATISFIED | [x] | **satisfied** |
| STOR-02 | Asset artifacts persist in R2, survive worker restarts | 12 | SATISFIED | [x] | **satisfied** |
| STOR-03 | Rendered videos uploaded to R2 after Modal GPU completion | 12 | SATISFIED | [x] | **satisfied** |
| STOR-04 | Time-limited signed URLs via Cloudflare CDN | 12 | SATISFIED | [x] | **satisfied** |
| JOB-01 | All job metadata persisted in Turso (prod) / SQLite (dev) | 13 | SATISFIED | [x] | **partial** ⚠ |
| JOB-02 | Worker polls Turso for pending jobs at 3-5s intervals | 13 | SATISFIED | [x] | **satisfied** |
| JOB-03 | User can see job progress by polling API | 13 | SATISFIED | [x] | **partial** ⚠ |
| JOB-04 | User can cancel running job; worker stops within one poll cycle | 13 | SATISFIED | [x] | **partial** ⚠ |
| JOB-05 | Stale jobs auto-marked failed after timeout | 13 | SATISFIED | [x] | **partial** ⚠ |
| WORK-01 | Render.com worker: Node.js + ffmpeg + yt-dlp | 13 | SATISFIED | [x] | **satisfied** |
| WORK-02 | Worker ingests from YouTube URLs, direct URLs, file uploads | 14 | SATISFIED | [x] | **satisfied** |
| WORK-03 | Worker executes audio edit previews and save ops | 14 | SATISFIED | [x] | **satisfied** |
| WORK-04 | Worker dispatches GPU render to Modal via R2 signed URL | 15 | SATISFIED | [x] | **satisfied** |
| WORK-05 | Modal calls secure webhook on render completion with R2 key | 15 | SATISFIED | [x] | **satisfied** |
| API-01 | All async API routes return jobId immediately | 14 | SATISFIED | [x] | **satisfied** |
| API-02 | Poll endpoint returns status, progress, result, downloadUrl | 14 | SATISFIED | [x] | **partial** ⚠ |
| API-03 | Asset streaming endpoint serves R2 or local transparently | 14 | SATISFIED | [x] | **satisfied** |
| API-04 | Webhook validates INTERNAL_WEBHOOK_SECRET before processing | 14 | SATISFIED | [x] | **satisfied** |
| DEPLOY-01 | App switches local/production via env vars, no code changes | 16 | SATISFIED | [x] | **partial** ⚠ |
| DEPLOY-02 | .env.example documents all required production env vars | 16 | SATISFIED | [x] | **satisfied** |
| DEPLOY-03 | Deploy checklist covers all 5 cloud services | 16 | SATISFIED | [x] | **satisfied** |
| DEPLOY-04 | GitHub Actions auto-deploys web to Vercel and worker to Render | 16 | SATISFIED | [x] | **satisfied** |
| SEC-01 | Modal webhook requires valid INTERNAL_WEBHOOK_SECRET | 14 | SATISFIED | [x] | **satisfied** |
| SEC-02 | Cloud ingest enforces 100MB / 30-min limits | 14 | SATISFIED | [x] | **satisfied** |

**Note on SUMMARY frontmatter:** SUMMARY.md files in this project do not use the `requirements-completed` YAML field. This is a documentation gap, not an implementation gap — requirements coverage was established via VERIFICATION.md and code analysis.

---

## Critical Integration Gaps

### CRIT-01: Legacy poll routes use in-memory JobManager instead of getJobStore()

**Severity:** Critical (breaks user-facing E2E flows)
**Affected requirements:** JOB-01, JOB-03, JOB-04, API-01, API-02
**Affected files:**
- `src/app/api/audio/ingest/[jobId]/route.ts` — line 2: imports `audioPrepJobs` from `@/lib/audio-prep/JobManager`
- `src/app/api/audio/edit/save/[jobId]/route.ts` — line 2: same
- `src/app/api/audio/edit/preview/[jobId]/route.ts` — line 2: same

**What happens:** POST `/api/audio/ingest` creates the job in `getJobStore()` (SQLite or Turso) and returns a `jobId`. Any client that polls the legacy per-feature path (`/api/audio/ingest/<jobId>`) hits `audioPrepJobs.get(jobId)` which searches the in-memory JobManager Map — a completely separate store. The job is never there. The client gets 404 on every poll.

**The fix:** Each of the three routes should import `getJobStore` from `@/lib/jobs` instead of `audioPrepJobs` from `@/lib/audio-prep/JobManager`.

---

### CRIT-02: Worker hardcodes TursoJobStore — bypasses DEPLOY_ENV, breaks local dev

**Severity:** Critical (violates DEPLOY-01 contract)
**Affected requirements:** DEPLOY-01, JOB-01, JOB-02
**Affected file:** `worker/index.ts` line 55

**What happens:** `worker/index.ts` directly instantiates `new TursoJobStore(dbUrl, authToken)` and calls `process.exit(1)` if `TURSO_DATABASE_URL` is not set. The `getJobStore()` factory that correctly handles `DEPLOY_ENV=production` is not used. A developer running the worker locally without a Turso account cannot use `LocalJobStore` without modifying source code.

**The fix:** Replace the direct `new TursoJobStore(...)` instantiation with `getJobStore()` from `@/lib/jobs`. Remove the manual exit guard (the factory already handles missing config).

---

## Non-Critical Gaps (Tech Debt)

| ID | Title | Phase | Req | Severity |
|----|-------|-------|-----|----------|
| GAP-01 | GET /api/render reads legacy ServerJobStore — render list always empty | 14/15 | JOB-03 | Low |
| GAP-02 | Ingest job completions have no downloadUrl in poll response | 14 | API-02 | Medium |
| GAP-03 | Per-type timeouts configured but only default used by reaper | 13 | JOB-05 | Low |
| GAP-04 | audioStorageKey written to job.result instead of metadata | 15 | JOB-01 | Info |
| GAP-05 | DEPLOY_PROD_CHECKLIST.md not directly read in audit | 16 | DEPLOY-03 | Info |

### GAP-02 Detail (Medium — worth fixing before launch)
Poll endpoint at `src/app/api/audio/jobs/[jobId]/route.ts` lines 65-68 checks `result.videoKey`, `result.previewKey`, `result.preparedKey` for download URL generation. Ingest pipeline (`worker/pipelines/ingest.ts` line ~263) stores `result.assetId`. No downloadUrl is surfaced for completed ingest jobs. Users see a complete job with no way to access the file from the poll response alone.

**The fix:** In the poll route, add a branch that checks `result.assetId` and synthesizes a streaming URL (`/api/audio/assets/${assetId}/stream`) in the `downloadUrl` field.

---

## Cross-Phase Wiring Summary

| From | To | Via | Status |
|------|----|-----|--------|
| Phase 12 `getStorageAdapter()` | All storage reads/writes | env-driven factory | WIRED |
| Phase 13 `getJobStore()` | All API job operations | env-driven factory | WIRED |
| Phase 14 async POST routes | Phase 13 `getJobStore().create()` | direct import | WIRED |
| Phase 14 legacy per-feature GET routes | Phase 13 `getJobStore()` | **MISSING** | **BROKEN** |
| Phase 14 worker pipelines | Phase 12 `getStorageAdapter()` | direct import | WIRED |
| Phase 13 worker | Phase 13 `getJobStore()` factory | **hardcoded TursoJobStore** | **BROKEN** |
| Phase 15 render pipeline | Phase 12 `getStorageAdapter()` | direct import | WIRED |
| Phase 15 modal-render-entry | Phase 14 webhook route | HTTP POST with Bearer | WIRED |
| Phase 16 `DEPLOY_ENV` | Phase 12 storage factory | env var fallback | WIRED |
| Phase 16 `DEPLOY_ENV` | Phase 13 job factory (web) | env var fallback | WIRED |
| Phase 16 `DEPLOY_ENV` | Phase 13 job factory (worker) | **hardcoded** | **BROKEN** |
| Phase 16 GitHub Actions | Vercel + Render | CLI + deploy hook | WIRED |

---

## E2E Flow Summary

| Flow | Status | Breaks At |
|------|--------|-----------|
| Audio Ingest (browser → upload → poll → asset) | BROKEN | Legacy poll route `/api/audio/ingest/[jobId]` returns 404 |
| Audio Edit + Save (recipe → save → poll → prepared audio) | BROKEN | Legacy poll route `/api/audio/edit/save/[jobId]` returns 404 |
| GPU Render (POST → Modal → webhook → poll → video) | CONNECTED (minor gap) | No blocking break; GET /api/render list reads wrong store |
| Environment Toggle (DEPLOY_ENV activates all cloud backends) | BROKEN | Worker bypasses factory; requires `TURSO_DATABASE_URL` locally |

---

## Tech Debt Summary

| Phase | Items |
|-------|-------|
| 12-cloud-storage-adapter | 2 (duck-typing cast, human verification required for R2 + progress bar) |
| 13-job-state-worker-infra | 1 (per-type timeouts silently ignored) |
| 14-api-worker-processing-pipeline | 1 (audioStorageKey in result vs metadata workaround) |
| 15-modal-render-dispatch | 1 (modal-render-entry uses standalone S3Client not factory) |
| 16-production-deploy-ci-cd | 2 (GET /api/render reads wrong store, checklist not directly verified) |

**Total: 7 tech debt items across 5 phases**

---

## Recommended Fix Plan

Two critical fixes required before completing milestone:

### Fix 1: CRIT-01 — Rewire legacy poll routes to getJobStore()
Files to update (3 files, minimal change each):
1. `src/app/api/audio/ingest/[jobId]/route.ts` — replace `audioPrepJobs` import with `getJobStore()`
2. `src/app/api/audio/edit/save/[jobId]/route.ts` — same
3. `src/app/api/audio/edit/preview/[jobId]/route.ts` — same

### Fix 2: CRIT-02 — Make worker use getJobStore() factory
File to update (1 file):
- `worker/index.ts` — replace `new TursoJobStore(dbUrl, authToken)` with `getJobStore()` call

### Recommended: Fix GAP-02 (medium priority)
- `src/app/api/audio/jobs/[jobId]/route.ts` — add `assetId` branch to synthesize streaming URL as `downloadUrl` for completed ingest jobs

---

*Audited: 2026-02-22*
*Auditor: Claude (gsd-audit-milestone)*
*Integration checker: gsd-integration-checker (sonnet)*
