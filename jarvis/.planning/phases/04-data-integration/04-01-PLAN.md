---
phase: 04-data-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/jarvis/notion/NotionClient.ts
  - src/lib/jarvis/notion/schemas.ts
  - scripts/discover-notion-databases.ts
  - .env.local
autonomous: true
user_setup:
  - service: notion
    why: "MCP server needs database IDs from user's Life OS workspace"
    dashboard_config:
      - task: "Verify NOTION_TOKEN is valid integration token"
        location: ".mcp.json or .env.local"
      - task: "User may need to share databases with integration"
        location: "Notion > Database > ... > Connections > Add connection"

must_haves:
  truths:
    - "MCP client can connect to Notion MCP server"
    - "Discovery script finds ALL Life OS database IDs (Tasks, Bills, Projects, Goals, Habits)"
    - "Database IDs are stored in environment config"
    - "Schema types exist for all Life OS databases"
    - "Architecture supports v2 Client OS extension"
  artifacts:
    - path: "src/lib/jarvis/notion/NotionClient.ts"
      provides: "MCP client singleton with tool execution"
      exports: ["ensureMCPRunning", "callMCPTool", "closeMCPClient"]
    - path: "src/lib/jarvis/notion/schemas.ts"
      provides: "Type definitions for ALL Life OS data structures"
      exports: ["TaskProperties", "BillProperties", "ProjectProperties", "GoalProperties", "HabitProperties", "NotionFilter", "LIFE_OS_DATABASES"]
    - path: "scripts/discover-notion-databases.ts"
      provides: "One-time discovery utility for ALL Life OS database IDs"
  key_links:
    - from: "NotionClient.ts"
      to: "Notion MCP Server"
      via: "stdio JSON-RPC"
      pattern: "spawn.*notion-mcp-server"
---

<objective>
Set up the MCP client infrastructure for Notion integration and discover database IDs.

Purpose: Foundation for all Notion read/write operations. The MCP client manages the connection to the Notion MCP server, and the discovery script finds the user's specific database IDs.

Output: Working MCP client singleton, database schema types, and configured database IDs in environment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/04-data-integration/04-RESEARCH.md

# Existing architecture
@src/lib/jarvis/intelligence/tools.ts
@.mcp.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create MCP client</name>
  <files>
    - package.json
    - src/lib/jarvis/notion/NotionClient.ts
  </files>
  <action>
Install required dependencies:
```bash
npm install @modelcontextprotocol/sdk@^1.25.2 zod@^3.25.0
```

Create `src/lib/jarvis/notion/NotionClient.ts` with:

1. MCP client singleton using stdio transport to spawn `npx -y @notionhq/notion-mcp-server`
2. Read NOTION_TOKEN from process.env (move from .mcp.json to .env.local)
3. Functions:
   - `ensureMCPRunning()`: Start MCP process if not running, initialize protocol
   - `sendMCPRequest(method, params)`: Send JSON-RPC request, return promise
   - `callMCPTool(name, args)`: Wrapper for tools/call
   - `closeMCPClient()`: Clean shutdown
4. Use pending requests Map with auto-incrementing request IDs
5. Handle process stdout parsing for JSON-RPC responses
6. Include error handling for process crashes and timeout

Follow the research pattern from 04-RESEARCH.md "Notion MCP Tool Executor" section.

IMPORTANT: Use `child_process.spawn` for Windows compatibility (not shell: true).
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/lib/jarvis/notion/NotionClient.ts
```
  </verify>
  <done>MCP client module exists with singleton pattern and tool calling capability</done>
</task>

<task type="auto">
  <name>Task 2: Create schema types and query builders for ALL Life OS databases</name>
  <files>
    - src/lib/jarvis/notion/schemas.ts
  </files>
  <action>
Create `src/lib/jarvis/notion/schemas.ts` with TypeScript types for FULL Life OS Bundle coverage:

**1. NotionFilter interface** for building Notion API filters

**2. Database property interfaces** (placeholder values, updated after discovery):

TaskProperties:
- Task (title), Status (select: To Do, In Progress, Done), Due Date (date)
- Project (relation), Priority (select: Low, Medium, High)

BillProperties:
- Bill (title), Amount (number), Due Date (date), Paid (checkbox), Category (select)

ProjectProperties:
- Project (title), Status (select), Area (relation to Life Areas)
- Timeline (date range), Priority (select), Needs (relation to Tasks)

GoalProperties:
- Goal (title), Status (select), Target Date (date)
- Progress (number/percent), Area (relation to Life Areas)

HabitProperties:
- Habit (title), Frequency (select: Daily, Weekly), Streak (number)
- Last Completed (date), Area (relation to Life Areas)

**3. Database configuration** - extensible for v2 Client OS:
```typescript
// v1: Life OS Bundle databases
export const LIFE_OS_DATABASES = {
  tasks: process.env.NOTION_TASKS_DATA_SOURCE_ID,
  bills: process.env.NOTION_BILLS_DATA_SOURCE_ID,
  projects: process.env.NOTION_PROJECTS_DATA_SOURCE_ID,
  goals: process.env.NOTION_GOALS_DATA_SOURCE_ID,
  habits: process.env.NOTION_HABITS_DATA_SOURCE_ID,
};

// v2 EXTENSION POINT: Client & Content OS databases
// export const CLIENT_OS_DATABASES = {
//   clients: process.env.NOTION_CLIENTS_DATA_SOURCE_ID,
//   content: process.env.NOTION_CONTENT_DATA_SOURCE_ID,
// };
```

**4. Query builder functions:**
- `buildTaskFilter(options)`: Build filter for today/this_week/overdue
- `buildBillFilter(options)`: Build filter for due bills
- `buildProjectFilter(options)`: Build filter for active/all projects
- `buildGoalFilter(options)`: Build filter for active goals
- `buildHabitFilter(options)`: Build filter for habits

**5. Result formatter functions** (speech-friendly output with IDs):
- `formatTaskResults(result)`, `formatBillResults(result)`
- `formatProjectResults(result)`, `formatGoalResults(result)`
- `formatHabitResults(result)`

NOTE: Property names are case-sensitive. Use placeholder names for now - user updates after running discovery script.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/lib/jarvis/notion/schemas.ts
```
  </verify>
  <done>Schema types and query builders exist for ALL Life OS databases (Tasks, Bills, Projects, Goals, Habits)</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive database discovery script</name>
  <files>
    - scripts/discover-notion-databases.ts
    - .env.local
  </files>
  <action>
Create `scripts/discover-notion-databases.ts` - a one-time utility script to discover ALL Life OS Bundle databases:

**1. Import and use NotionClient**

**2. Search for ALL Life OS databases:**
- Tasks (or "To-Do", "Action Items" - common Life OS names)
- Bills (or "Finances", "Budget")
- Projects
- Goals (or "Objectives")
- Habits (or "Routines", "Trackers")

**3. For each database found:**
- Call `retrieve-a-database` to get data_source_id
- Print the property schema (property names are case-sensitive!)
- Show which properties map to our interfaces

**4. Output complete env vars for user to copy:**
```
# Life OS Bundle Database IDs
NOTION_TASKS_DATA_SOURCE_ID=xxx
NOTION_BILLS_DATA_SOURCE_ID=xxx
NOTION_PROJECTS_DATA_SOURCE_ID=xxx
NOTION_GOALS_DATA_SOURCE_ID=xxx
NOTION_HABITS_DATA_SOURCE_ID=xxx

# v2: Client & Content OS (uncomment when ready)
# NOTION_CLIENTS_DATA_SOURCE_ID=xxx
# NOTION_CONTENT_DATA_SOURCE_ID=xxx
```

**5. Output property mapping for schemas.ts:**
```
// Update these in schemas.ts based on your Life OS setup:
// TASK_PROPS.title = 'Task'  // or 'Name', 'To-Do', etc.
// TASK_PROPS.status = 'Status'
// ...
```

**6. Clean up MCP process when done**

Add to package.json scripts:
```json
"discover-notion": "npx tsx scripts/discover-notion-databases.ts"
```

Move NOTION_TOKEN from .mcp.json to .env.local:
```
NOTION_TOKEN=ntn_xxx (copy from .mcp.json)
```

The script should:
- Handle errors gracefully (database not found, permission issues)
- Show clear instructions for user to share databases with integration
- List databases found vs not found
- Output ready-to-copy env vars
- Include v2 extension placeholders in output
  </action>
  <verify>
Script runs and shows database search results:
```bash
npm run discover-notion
```
  </verify>
  <done>Discovery script finds ALL Life OS database IDs and outputs property mappings</done>
</task>

</tasks>

<verification>
1. `npm install` completes without errors
2. TypeScript compiles: `npx tsc --noEmit`
3. NotionClient.ts exports ensureMCPRunning, callMCPTool, closeMCPClient
4. Discovery script runs (may fail if databases not shared - that's expected)
5. .env.local has NOTION_TOKEN moved from .mcp.json
</verification>

<success_criteria>
- MCP client can spawn and communicate with Notion MCP server
- Schema types provide TypeScript safety for Notion data
- Discovery script helps user find their database IDs
- Ready for Plan 04-02 to implement read operations
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/04-data-integration/04-01-SUMMARY.md`
</output>
