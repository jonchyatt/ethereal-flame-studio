---
phase: 06-advanced-executive-function
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/jarvis/executive/EveningWrapFlow.ts
  - src/lib/jarvis/executive/types.ts
  - src/lib/jarvis/executive/Scheduler.ts
  - src/lib/jarvis/executive/BriefingBuilder.ts
  - src/app/api/jarvis/briefing/route.ts
autonomous: true

must_haves:
  truths:
    - "User receives evening wrap prompt at scheduled time"
    - "Evening wrap covers day review, tomorrow preview, and capture"
    - "User can skip evening wrap or advance through sections"
    - "Evening wrap duration adapts to content volume"
  artifacts:
    - path: "src/lib/jarvis/executive/EveningWrapFlow.ts"
      provides: "Comprehensive evening wrap state machine"
      exports: ["EveningWrapFlow", "createEveningWrapFlow"]
    - path: "src/lib/jarvis/executive/types.ts"
      provides: "Extended types for evening wrap"
      contains: "EveningWrapSection"
  key_links:
    - from: "src/lib/jarvis/executive/Scheduler.ts"
      to: "EveningWrapFlow"
      via: "evening_wrap event type triggers flow"
      pattern: "evening_wrap.*EveningWrapFlow"
    - from: "src/lib/jarvis/executive/EveningWrapFlow.ts"
      to: "/api/jarvis/briefing"
      via: "BriefingClient fetch"
      pattern: "buildEveningWrapData"
---

<objective>
Create the comprehensive Evening Wrap workflow that guides users through end-of-day closure.

Purpose: Per CONTEXT.md, evening wrap provides: day review (factual outline of completed/incomplete tasks), tomorrow preview, week summary, finance check, new task capture, and open-ended closing. Unlike the lightweight evening check-in, this is a full session for daily closure.

Output: EveningWrapFlow class following BriefingFlow pattern, with sections that adapt based on content volume.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/phases/06-advanced-executive-function/06-CONTEXT.md
@jarvis/.planning/phases/06-advanced-executive-function/06-RESEARCH.md

# Existing patterns to follow
@src/lib/jarvis/executive/BriefingFlow.ts
@src/lib/jarvis/executive/CheckInManager.ts
@src/lib/jarvis/executive/types.ts
@src/lib/jarvis/executive/Scheduler.ts
@src/lib/jarvis/executive/BriefingBuilder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and Scheduler for evening wrap</name>
  <files>
    src/lib/jarvis/executive/types.ts
    src/lib/jarvis/executive/Scheduler.ts
  </files>
  <action>
    1. In types.ts, add:
       - EveningWrapSection type: 'outline' | 'dayReview' | 'taskUpdates' | 'newCaptures' | 'tomorrowPreview' | 'weekSummary' | 'financeCheck' | 'closing' | 'complete'
       - EveningWrapData interface extending BriefingData with:
         - dayReview: { completedTasks: TaskSummary[], incompleteTasks: TaskSummary[], completionRate: number }
         - tomorrow: { tasks: TaskSummary[], events: CalendarEvent[] }
         - weekSummary: { busyDays: string[], lightDays: string[], upcomingDeadlines: TaskSummary[] }
       - MissedPromptInfo interface: { type: 'evening_wrap' | 'weekly_review', missedDate: string }

    2. In Scheduler.ts:
       - Extend ScheduledEventType union with 'evening_wrap' (distinct from 'evening_checkin')
       - Add 'evening_wrap' to default schedule at '21:00' (9 PM, user-adjustable)
       - Track missed evening wraps for follow-up next interaction
       - Extend MISSED_EVENT_WINDOW_MINUTES to 180 for evening_wrap (3 hours vs 1 hour)
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && npx tsc --noEmit
    ```
  </verify>
  <done>
    - EveningWrapSection and EveningWrapData types defined
    - Scheduler supports 'evening_wrap' event type with 21:00 default
    - Missed event window extended for evening wrap
  </done>
</task>

<task type="auto">
  <name>Task 2: Add evening wrap data builder</name>
  <files>
    src/lib/jarvis/executive/BriefingBuilder.ts
    src/app/api/jarvis/briefing/route.ts
  </files>
  <action>
    1. In BriefingBuilder.ts, add buildEveningWrapData():
       - Query completed tasks for today (status: 'completed')
       - Query incomplete tasks for today (status: 'pending')
       - Query tomorrow's tasks (filter: 'tomorrow')
       - Calculate completion rate (completed / total)
       - Build week summary:
         - Get next 7 days of tasks
         - Count tasks per day to identify busy days (>5) and light days (<2)
         - Get deadlines within next 7 days
       - Reuse existing bill/habit/goal queries
       - Return EveningWrapData structure

    2. In BriefingBuilder.ts, add helper function buildTomorrowPreview():
       - Query tasks due tomorrow
       - Derive calendar events for tomorrow (same pattern as today)

    3. In BriefingBuilder.ts, add helper function analyzeWeekLoad():
       - Query tasks for next 7 days
       - Group by day, count tasks
       - Return { busyDays: string[], lightDays: string[], upcomingDeadlines: TaskSummary[] }

    4. In route.ts, add 'evening_wrap' type parameter handling:
       - If type=evening_wrap, call buildEveningWrapData()
       - Return extended data structure
  </action>
  <verify>
    Test API route:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && curl -s "http://localhost:3000/api/jarvis/briefing?type=evening_wrap" | head -c 500
    ```
    Should return JSON with dayReview, tomorrow, weekSummary fields.
  </verify>
  <done>
    - buildEveningWrapData() returns comprehensive evening data
    - Tomorrow preview and week load analysis working
    - API route serves evening wrap data
  </done>
</task>

<task type="auto">
  <name>Task 3: Create EveningWrapFlow class</name>
  <files>
    src/lib/jarvis/executive/EveningWrapFlow.ts
    src/lib/jarvis/executive/BriefingClient.ts
  </files>
  <action>
    1. Create EveningWrapFlow.ts following BriefingFlow pattern:
       - SECTION_ORDER: ['outline', 'dayReview', 'taskUpdates', 'newCaptures', 'tomorrowPreview', 'weekSummary', 'financeCheck', 'closing', 'complete']
       - State: currentSection, data, skippedSections, isActive, isWaitingForResponse, capturedItems[]
       - Constructor takes speakFn and callbacks (same pattern as BriefingFlow)

    2. Implement start():
       - Fetch EveningWrapData via BriefingClient
       - Present outline: "Let's wrap up the day. We'll cover what got done, tomorrow's tasks, and capture any loose ends."
       - Set isWaitingForResponse = true

    3. Implement section scripts (per CONTEXT.md - factual, not scorecard):
       - dayReview: "You completed X tasks today: [titles]. Y tasks still pending: [titles]."
         (Skip if no tasks either way)
       - taskUpdates: "Want to update any task statuses? Or say skip."
       - newCaptures: "Anything floating in your head to capture? Say done when finished."
       - tomorrowPreview: "Tomorrow you have X tasks. [brief list]. Anything to adjust?"
         (Per CONTEXT.md: Jarvis speaks up if something important seems neglected)
       - weekSummary: "Looking at the week: [busy days], [light days]. [deadlines]."
       - financeCheck: "X bills due soon, $Y total." (reuse BriefingFlow pattern)
       - closing: "Anything else on your mind?" (open-ended per CONTEXT.md)
       - complete: "All wrapped up. Have a good evening."

    4. Implement handleUserResponse():
       - Skip commands: 'skip', 'next', 'no', 'done', 'that's all'
       - Capture mode: In newCaptures section, accumulate items until 'done'
       - Update mode: In taskUpdates section, acknowledge and continue
       - Stop commands: 'stop', 'cancel', 'end'
       - Default: advance to next section

    5. Implement advanceToNext():
       - Find next non-skipped, non-empty section
       - Empty section = section has no content (e.g., no tasks tomorrow)
       - Call presentSection()

    6. Implement skip/cancel/complete methods (same as BriefingFlow)

    7. In BriefingClient.ts, add:
       - buildEveningWrapData() that fetches from /api/jarvis/briefing?type=evening_wrap

    8. Export createEveningWrapFlow factory function
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && npx tsc --noEmit
    ```
    Class structure matches BriefingFlow pattern.
  </verify>
  <done>
    - EveningWrapFlow follows BriefingFlow pattern
    - All 9 sections implemented with factual, non-judgmental scripts
    - newCaptures section accumulates items
    - Duration adapts: empty sections are skipped automatically
  </done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. Scheduler includes evening_wrap event
3. API returns evening wrap data structure
4. EveningWrapFlow class instantiates and has correct methods
</verification>

<success_criteria>
- EveningWrapFlow.ts exists with complete implementation
- Scheduler schedules evening_wrap at 21:00 by default
- API route serves evening wrap data
- All section scripts follow CONTEXT.md guidance (factual, not scorecard)
- capturedItems array populated during newCaptures phase
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/06-advanced-executive-function/06-01-SUMMARY.md`
</output>
