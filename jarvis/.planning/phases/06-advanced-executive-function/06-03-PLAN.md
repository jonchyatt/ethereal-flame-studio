---
phase: 06-advanced-executive-function
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/lib/jarvis/executive/WeeklyReviewFlow.ts
  - src/lib/jarvis/executive/types.ts
  - src/lib/jarvis/executive/Scheduler.ts
  - src/lib/jarvis/executive/BriefingBuilder.ts
  - src/lib/jarvis/executive/BriefingClient.ts
  - src/app/api/jarvis/briefing/route.ts
autonomous: true

must_haves:
  truths:
    - "User receives weekly review reminder at configured day/time"
    - "Weekly review has brief retrospective then forward planning"
    - "Checkpoints pause for user input at key points"
    - "Life area balance surfaces during weekly review"
  artifacts:
    - path: "src/lib/jarvis/executive/WeeklyReviewFlow.ts"
      provides: "Voice-guided weekly review state machine"
      exports: ["WeeklyReviewFlow", "createWeeklyReviewFlow"]
    - path: "src/lib/jarvis/executive/types.ts"
      provides: "Extended types for weekly review"
      contains: "WeeklyReviewSection"
  key_links:
    - from: "src/lib/jarvis/executive/Scheduler.ts"
      to: "WeeklyReviewFlow"
      via: "weekly_review_reminder event triggers flow"
      pattern: "weekly_review_reminder"
    - from: "src/lib/jarvis/executive/WeeklyReviewFlow.ts"
      to: "LifeAreaTracker"
      via: "getNeglectedAreas for balance section"
      pattern: "getLifeAreaTracker.*getNeglectedAreas"
---

<objective>
Create the voice-guided Weekly Review session with reflection prompts.

Purpose: Per CONTEXT.md, weekly review is "very brief retrospective, then mostly forward planning." Retrospective is factual only (tasks completed, bills paid, project progress) - no scorecard, no judgment, no emotional prompts. Forward planning covers upcoming week plus 2-4 week horizon scan. Checkpoints pause for user input.

Output: WeeklyReviewFlow class with checkpoint pauses, life area balance surfacing, and horizon scan.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/phases/06-advanced-executive-function/06-CONTEXT.md
@jarvis/.planning/phases/06-advanced-executive-function/06-RESEARCH.md

# Depends on Plan 01 and 02
@jarvis/.planning/phases/06-advanced-executive-function/06-01-PLAN.md
@jarvis/.planning/phases/06-advanced-executive-function/06-02-PLAN.md

# Existing patterns
@src/lib/jarvis/executive/BriefingFlow.ts
@src/lib/jarvis/executive/EveningWrapFlow.ts
@src/lib/jarvis/executive/LifeAreaTracker.ts
@src/lib/jarvis/executive/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types and Scheduler for weekly review</name>
  <files>
    src/lib/jarvis/executive/types.ts
    src/lib/jarvis/executive/Scheduler.ts
  </files>
  <action>
    1. In types.ts, add:
       ```typescript
       type WeeklyReviewSection =
         | 'intro'
         | 'retrospective'
         | 'checkpoint1'      // "Anything to add about this week?"
         | 'upcomingWeek'
         | 'checkpoint2'      // "Anything to adjust?"
         | 'horizonScan'
         | 'checkpoint3'      // "Anything to add?"
         | 'lifeAreas'
         | 'closing'
         | 'complete';

       interface WeeklyReviewData {
         retrospective: {
           tasksCompleted: number;
           billsPaid: number;
           projectsProgressed: string[];  // Project names that had activity
         };
         upcomingWeek: {
           taskCount: number;
           tasks: TaskSummary[];
           events: CalendarEvent[];
           busyDays: string[];
           lightDays: string[];
         };
         horizon: {
           deadlines: TaskSummary[];       // Due in 2-4 weeks
           upcomingBills: BillSummary[];   // Due in 2-4 weeks
           projectMilestones: string[];    // Notable upcoming items
         };
         lifeAreas: LifeAreaInsights;
       }

       interface WeeklyReviewConfig {
         dayOfWeek: number;  // 0=Sunday, 6=Saturday (user-configurable)
         time: string;       // HH:mm format
       }
       ```

    2. In Scheduler.ts:
       - Add 'weekly_review_reminder' to ScheduledEventType
       - Extend ScheduledEvent interface with optional dayOfWeek: number
       - Add weekly_review_reminder to default schedule:
         - No default day (user configures via settings)
         - Default time: '10:00' (morning, user-adjustable)
         - enabled: false by default (user opts in)
       - In check(), handle dayOfWeek matching for weekly events:
         ```typescript
         if (event.dayOfWeek !== undefined) {
           const today = new Date().getDay();
           if (today !== event.dayOfWeek) continue;
         }
         ```
       - Add updateWeeklyReviewDay(day: number) method
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && npx tsc --noEmit
    ```
  </verify>
  <done>
    - WeeklyReviewSection and WeeklyReviewData types defined
    - Scheduler supports weekly_review_reminder with dayOfWeek
    - Weekly review disabled by default, user opts in
  </done>
</task>

<task type="auto">
  <name>Task 2: Add weekly review data builder</name>
  <files>
    src/lib/jarvis/executive/BriefingBuilder.ts
    src/lib/jarvis/executive/BriefingClient.ts
    src/app/api/jarvis/briefing/route.ts
  </files>
  <action>
    1. In BriefingBuilder.ts, add buildWeeklyReviewData():
       - Retrospective (past 7 days):
         - Query completed tasks with completion date in last 7 days
         - Query bills marked paid in last 7 days
         - Query projects that had task completions
       - Upcoming week (next 7 days):
         - Query tasks due in next 7 days
         - Derive calendar events
         - Analyze busy/light days (reuse analyzeWeekLoad)
       - Horizon scan (14-28 days out):
         - Query tasks due in 14-28 days with high priority or deadline
         - Query bills due in 14-28 days
         - Identify project milestones if available
       - Get life area insights from LifeAreaTracker
       - Return WeeklyReviewData structure

    2. In BriefingClient.ts, add:
       - buildWeeklyReviewData() that fetches from /api/jarvis/briefing?type=weekly_review

    3. In route.ts, handle type=weekly_review:
       - Call buildWeeklyReviewData()
       - Return WeeklyReviewData structure
  </action>
  <verify>
    Test API route:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && curl -s "http://localhost:3000/api/jarvis/briefing?type=weekly_review" | head -c 500
    ```
    Should return JSON with retrospective, upcomingWeek, horizon, lifeAreas fields.
  </verify>
  <done>
    - buildWeeklyReviewData() returns comprehensive review data
    - Retrospective covers past 7 days factually
    - Horizon scan looks 2-4 weeks ahead
    - API route serves weekly review data
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WeeklyReviewFlow class</name>
  <files>
    src/lib/jarvis/executive/WeeklyReviewFlow.ts
  </files>
  <action>
    1. Create WeeklyReviewFlow.ts following BriefingFlow/EveningWrapFlow pattern:
       - SECTION_ORDER: ['intro', 'retrospective', 'checkpoint1', 'upcomingWeek', 'checkpoint2', 'horizonScan', 'checkpoint3', 'lifeAreas', 'closing', 'complete']
       - State: currentSection, data, skippedSections, isActive, isWaitingForResponse
       - CHECKPOINT_TIMEOUT = 15000 (15 seconds auto-advance)
       - Constructor takes speakFn and callbacks

    2. Implement start():
       - Fetch WeeklyReviewData via BriefingClient
       - Present intro: "Let's do our weekly review. Ready?"
       - Set isWaitingForResponse = true

    3. Implement section scripts (per CONTEXT.md - factual, brief retrospective):
       - intro: "Let's do our weekly review. We'll look at what happened this week, then plan ahead. Ready?"
       - retrospective: "This week: {tasksCompleted} tasks completed, {billsPaid} bills paid.
         [If projects: You made progress on {projects}.]"
         (Factual only - no scorecard, no judgment)
       - checkpoint1: "Anything to add about this week?" (15s timeout -> auto-advance)
       - upcomingWeek: "Next week: {taskCount} tasks. [busyDays] look busy, [lightDays] are lighter.
         Notable: [top 3 tasks]"
       - checkpoint2: "Anything to adjust?" (15s timeout)
       - horizonScan: "Looking 2-4 weeks out: [deadlines], [bills], [milestones]."
         (Skip if horizon is empty)
       - checkpoint3: "Anything to add?" (15s timeout)
       - lifeAreas: "Life area balance: [top neglected area message]. [second if exists]."
         (Skip if no neglected areas)
       - closing: "Weekly review complete. Anything else?"
       - complete: "All set. Have a good week!"

    4. Implement checkpoint logic:
       - presentCheckpoint(section, message): speak message, start timeout timer
       - On timeout (15s), auto-advance to next section
       - User response clears timer and either adds content or advances

    5. Implement handleUserResponse():
       - Skip commands: 'skip', 'next', 'no', 'nothing', 'move on'
       - Add content: Any substantive response -> acknowledge and stay for more
       - Done commands: 'done', 'that's all', 'that's it' -> advance
       - Stop commands: 'stop', 'cancel', 'end review' -> complete

    6. Implement advanceToNext():
       - Find next non-empty section
       - For checkpoints, always present (they're for user input)
       - Skip sections with no data (empty horizon, no neglected areas)

    7. Export createWeeklyReviewFlow factory function
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    cd C:\Users\jonch\Projects\ethereal-flame-studio && npx tsc --noEmit
    ```
  </verify>
  <done>
    - WeeklyReviewFlow follows established flow pattern
    - Retrospective is factual only (no judgment, no scorecard)
    - Forward planning is primary focus
    - Checkpoints have 15s timeout for auto-advance
    - Life area balance surfaced in dedicated section
  </done>
</task>

</tasks>

<verification>
1. Types compile: `npx tsc --noEmit` passes
2. Scheduler supports weekly_review_reminder with dayOfWeek
3. API returns weekly review data structure
4. WeeklyReviewFlow class instantiates with correct methods
5. Checkpoints timeout and auto-advance after 15s
6. Retrospective script is factual, not emotional
</verification>

<success_criteria>
- WeeklyReviewFlow.ts exists with complete implementation
- Scheduler supports configurable day-of-week for weekly review
- Weekly review disabled by default (opt-in)
- Retrospective is brief and factual per CONTEXT.md
- Forward planning (upcoming week + horizon) is primary content
- Checkpoint pauses allow user input with 15s timeout
- Life area balance surfaced during review
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/06-advanced-executive-function/06-03-SUMMARY.md`
</output>
