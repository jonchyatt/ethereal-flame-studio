---
phase: 09-memory-writing
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/jarvis/intelligence/memoryTools.ts
  - src/lib/jarvis/intelligence/tools.ts
  - src/lib/jarvis/memory/toolExecutor.ts
  - src/app/api/jarvis/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "User can say 'Remember I have therapy Thursdays' and fact persists"
    - "User can say 'Forget what I said about therapy' and get confirmation before delete"
    - "User can ask 'What do you know about me?' and get categorized list"
    - "User can say 'Delete all memories' and all data is cleared after confirmation"
  artifacts:
    - path: "src/lib/jarvis/intelligence/memoryTools.ts"
      provides: "Claude tool definitions for memory operations"
      exports: ["memoryTools"]
    - path: "src/lib/jarvis/memory/toolExecutor.ts"
      provides: "Memory tool execution functions"
      exports: ["executeMemoryTool"]
  key_links:
    - from: "chat/route.ts"
      to: "memoryTools.ts"
      via: "imports memoryTools and passes to Claude"
      pattern: "memoryTools"
    - from: "chat/route.ts"
      to: "toolExecutor.ts"
      via: "calls executeMemoryTool for memory tool names"
      pattern: "executeMemoryTool"
---

<objective>
Add Claude tools for memory CRUD operations (remember, forget, list, delete all).

Purpose: Enable voice-driven memory management (MEM-02, MEM-03, MEM-04, MEM-05) by giving Claude tools to call when users express memory intent.

Output: Tool definitions, tool executor, and chat API integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/phases/09-memory-writing/09-CONTEXT.md
@jarvis/.planning/phases/09-memory-writing/09-RESEARCH.md

# Prior phase for patterns
@jarvis/.planning/phases/08-memory-loading-integration/08-02-SUMMARY.md

# Existing tool patterns
@src/lib/jarvis/intelligence/tools.ts
@src/lib/jarvis/notion/toolExecutor.ts
@src/app/api/jarvis/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create memory tool definitions</name>
  <files>src/lib/jarvis/intelligence/memoryTools.ts</files>
  <action>
Create a new file `src/lib/jarvis/intelligence/memoryTools.ts` with Claude tool definitions.

Follow the existing pattern from tools.ts (ToolDefinition interface).

Define these tools:

1. **remember_fact**
   - description: "Store a fact that the user wants Jarvis to remember. Use when user says 'remember', 'don't forget', or states a persistent fact about themselves ('I always...', 'Every Thursday I...')."
   - input_schema:
     - content (string, required): "The fact to remember, normalized and concise"
     - category (string, required): enum ['schedule', 'preference', 'person', 'work', 'health', 'other']
     - source (string): enum ['user_explicit', 'jarvis_inferred'], default 'user_explicit'

2. **forget_fact**
   - description: "Find and soft-delete stored memories. Use when user says 'forget', 'don't remember', or wants to remove stored info. ALWAYS confirm matches with user before deleting."
   - input_schema:
     - query (string, required): "Natural language description of what to forget"
     - confirm_ids (array of numbers): "If confirming a previous forget request, the specific IDs to delete"
     - category (string): "Optional category filter" enum ['schedule', 'preference', 'person', 'work', 'health', 'other']

3. **list_memories**
   - description: "List what Jarvis remembers about the user. Use when user asks 'what do you know', 'what do you remember', or wants to see stored info."
   - input_schema:
     - category (string): enum ['schedule', 'preference', 'person', 'work', 'health', 'other', 'all']
     - include_deleted (boolean): "Include recently deleted (for undo)"

4. **delete_all_memories**
   - description: "PERMANENTLY delete ALL stored memories. Use ONLY when user explicitly requests full memory wipe AND has confirmed. This is destructive."
   - input_schema:
     - confirm (boolean, required): "Must be true to execute"

5. **restore_memory**
   - description: "Restore a recently deleted memory. Use when user says 'undo', 'restore', or wants back a deleted item."
   - input_schema:
     - id (number, required): "The memory ID to restore"

Export as `memoryTools: ToolDefinition[]`.

```typescript
import type { ToolDefinition } from './tools';

export const memoryTools: ToolDefinition[] = [
  // ... tool definitions
];
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>memoryTools.ts exists with 5 tool definitions following existing pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create memory tool executor</name>
  <files>src/lib/jarvis/memory/toolExecutor.ts</files>
  <action>
Create `src/lib/jarvis/memory/toolExecutor.ts` that executes memory tools.

Follow the pattern from `src/lib/jarvis/notion/toolExecutor.ts`.

```typescript
import {
  MemoryService,
  storeMemoryEntry,
  getMemoryEntries,
  getDeletedMemories,
  softDeleteMemoryEntry,
  restoreMemoryEntry,
  findMemoriesMatching,
  type MemoryEntry,
} from './index';
import { db, memoryEntries } from './db';

export type MemoryToolName =
  | 'remember_fact'
  | 'forget_fact'
  | 'list_memories'
  | 'delete_all_memories'
  | 'restore_memory';

export async function executeMemoryTool(
  toolName: string,
  input: Record<string, unknown>
): Promise<string> {
  switch (toolName) {
    case 'remember_fact':
      return handleRememberFact(input);
    case 'forget_fact':
      return handleForgetFact(input);
    case 'list_memories':
      return handleListMemories(input);
    case 'delete_all_memories':
      return handleDeleteAll(input);
    case 'restore_memory':
      return handleRestore(input);
    default:
      return JSON.stringify({ error: `Unknown memory tool: ${toolName}` });
  }
}
```

Implement handlers:

**handleRememberFact:**
- Extract content, category, source from input
- Call storeMemoryEntry(content, category, source)
- Return JSON with stored entry and confirmation message

**handleForgetFact:**
- If confirm_ids provided: soft-delete those specific IDs, return confirmation
- Otherwise: call findMemoriesMatching(query), return list of candidates for user confirmation
- Include ID, content, category in response so Claude can confirm with user

**handleListMemories:**
- Get entries, optionally filtered by category
- If include_deleted, also get getDeletedMemories
- Group by category
- Return JSON with categorized list and counts

**handleDeleteAll:**
- If confirm !== true, return error requiring confirmation
- Hard delete all entries: `await db.delete(memoryEntries)`
- Return confirmation with count deleted

**handleRestore:**
- Call restoreMemoryEntry(id)
- Return restored entry or error if not found
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>toolExecutor.ts exists with executeMemoryTool function handling all 5 tools</done>
</task>

<task type="auto">
  <name>Task 3: Integrate memory tools into chat API</name>
  <files>src/app/api/jarvis/chat/route.ts, src/lib/jarvis/intelligence/tools.ts</files>
  <action>
Update the chat route to use memory tools alongside Notion tools.

1. In `src/lib/jarvis/intelligence/tools.ts`, add re-export:
```typescript
// At the end of file
export { memoryTools } from './memoryTools';
```

2. In `src/app/api/jarvis/chat/route.ts`:

Import memory tools and executor:
```typescript
import { memoryTools } from '@/lib/jarvis/intelligence/memoryTools';
import { executeMemoryTool } from '@/lib/jarvis/memory/toolExecutor';
```

Combine tools for Claude:
```typescript
const allTools = [...notionTools, ...memoryTools];

// In the anthropic.messages.create call:
tools: allTools,
```

In the tool execution section, route memory tools:
```typescript
// After the Notion tool check
const memoryToolNames = ['remember_fact', 'forget_fact', 'list_memories', 'delete_all_memories', 'restore_memory'];

if (memoryToolNames.includes(toolUse.name)) {
  result = await executeMemoryTool(toolUse.name, toolUse.input as Record<string, unknown>);
} else {
  result = await executeNotionTool(toolUse.name, toolUse.input as Record<string, unknown>);
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```

Check that tools are combined:
```bash
grep -n "memoryTools" src/app/api/jarvis/chat/route.ts
grep -n "executeMemoryTool" src/app/api/jarvis/chat/route.ts
```
  </verify>
  <done>Chat API uses both notionTools and memoryTools; routes to correct executor</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Memory tools defined:
```bash
grep -E "name: '(remember|forget|list|delete_all|restore)" src/lib/jarvis/intelligence/memoryTools.ts
```

2. Tool executor exists:
```bash
grep "export async function executeMemoryTool" src/lib/jarvis/memory/toolExecutor.ts
```

3. Chat route integrates both:
```bash
grep -E "(memoryTools|executeMemoryTool)" src/app/api/jarvis/chat/route.ts
```

4. TypeScript compiles:
```bash
npx tsc --noEmit -p .
```
</verification>

<success_criteria>
1. memoryTools.ts defines remember_fact, forget_fact, list_memories, delete_all_memories, restore_memory
2. toolExecutor.ts implements executeMemoryTool with handlers for all tools
3. chat/route.ts combines notionTools and memoryTools
4. chat/route.ts routes memory tool calls to executeMemoryTool
5. forget_fact returns candidates for confirmation before deleting
6. delete_all_memories requires confirm: true
7. All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-memory-writing/09-02-SUMMARY.md`
</output>
