---
phase: 05-executive-function-core
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/jarvis/executive/NudgeManager.ts
  - src/lib/jarvis/executive/CheckInManager.ts
  - src/components/jarvis/NudgeOverlay.tsx
  - src/lib/jarvis/stores/jarvisStore.ts
  - src/app/jarvis/page.tsx
  - public/sounds/gentle-chime.mp3
autonomous: true

must_haves:
  truths:
    - "User receives gentle time nudges for calendar transitions and deadlines"
    - "Nudges are sound + visual, voice only if user engages"
    - "User gets midday pulse check asking about progress"
    - "User gets end-of-work check-in prompting status updates"
    - "Check-ins are easily skippable"
    - "Multimodal: voice OR tap/text acknowledgment"
  artifacts:
    - path: "src/lib/jarvis/executive/NudgeManager.ts"
      provides: "Manages nudge triggers and delivery"
      exports: ["NudgeManager"]
    - path: "src/lib/jarvis/executive/CheckInManager.ts"
      provides: "Manages midday and evening check-in flows"
      exports: ["CheckInManager"]
    - path: "src/components/jarvis/NudgeOverlay.tsx"
      provides: "Visual nudge indicator"
      exports: ["NudgeOverlay"]
  key_links:
    - from: "NudgeManager.ts"
      to: "jarvisStore"
      via: "setActiveNudge"
      pattern: "setActiveNudge.*message"
    - from: "CheckInManager.ts"
      to: "VoicePipeline"
      via: "speak method"
      pattern: "speak.*progress|complete"
    - from: "NudgeOverlay.tsx"
      to: "jarvisStore"
      via: "useJarvisStore"
      pattern: "activeNudge"
---

<objective>
Implement time awareness nudges and scheduled check-ins.

Purpose: Jarvis becomes proactive - gently nudging about upcoming commitments and prompting for status updates at scheduled times. Nudges are subtle (sound + visual), not intrusive modals.

Output: NudgeManager triggers deadline-based nudges, CheckInManager handles midday/evening check-ins, NudgeOverlay shows visual indicator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/05-executive-function-core/05-CONTEXT.md
@jarvis/.planning/phases/05-executive-function-core/05-RESEARCH.md

# Prior plan output
@jarvis/.planning/phases/05-executive-function-core/05-01-SUMMARY.md

# Existing architecture
@src/lib/jarvis/executive/Scheduler.ts
@src/lib/jarvis/executive/BriefingBuilder.ts
@src/lib/jarvis/voice/VoicePipeline.ts
@src/lib/jarvis/stores/jarvisStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NudgeManager with sound and visual delivery</name>
  <files>
    - src/lib/jarvis/executive/NudgeManager.ts
    - public/sounds/gentle-chime.mp3
    - src/lib/jarvis/stores/jarvisStore.ts
  </files>
  <action>
**Add notification sound:**

Download a gentle chime sound (royalty-free) and save to `public/sounds/gentle-chime.mp3`. Use a soft, pleasant tone - NOT a jarring alert.

Option: Generate a simple tone with Web Audio API as fallback if no file exists.

**Update jarvisStore.ts with nudge state:**

```typescript
// Add to state
activeNudge: null as NudgeState | null,

// Add to actions
setActiveNudge: (nudge: NudgeState | null) => set({ activeNudge: nudge }),
acknowledgeNudge: () => set({ activeNudge: null }),
```

Where NudgeState:
```typescript
interface NudgeState {
  id: string;
  message: string;
  type: 'calendar' | 'deadline' | 'bill' | 'business';
  timestamp: number;
  acknowledged: boolean;
}
```

**Create `src/lib/jarvis/executive/NudgeManager.ts`:**

1. **NudgeManager class:**
   - Manages Web Audio context for notification sounds
   - Tracks pending nudges (from deadlines, calendar events)
   - Delivers nudges at appropriate lead times

2. **Sound delivery:**
```typescript
private audioContext: AudioContext | null = null;
private notificationSound: AudioBuffer | null = null;

async playNudgeSound(): Promise<void> {
  if (!this.audioContext) {
    this.audioContext = new AudioContext();
    const response = await fetch('/sounds/gentle-chime.mp3');
    const arrayBuffer = await response.arrayBuffer();
    this.notificationSound = await this.audioContext.decodeAudioData(arrayBuffer);
  }

  if (this.audioContext.state === 'suspended') {
    await this.audioContext.resume();
  }

  const source = this.audioContext.createBufferSource();
  source.buffer = this.notificationSound;
  source.connect(this.audioContext.destination);
  source.start(0);
}
```

3. **Visual delivery:**
```typescript
showVisualNudge(nudge: NudgeState): void {
  useJarvisStore.getState().setActiveNudge(nudge);
}
```

4. **Voice delivery (only when user engages):**
```typescript
async speakNudge(message: string, voicePipeline: VoicePipeline): Promise<void> {
  await voicePipeline.speak(message);
}
```

5. **Nudge triggering logic:**
   - Per CONTEXT.md, nudges trigger for: calendar transitions, task deadlines, bill due dates, business deadlines
   - NOT for: fixed intervals, break suggestions
   - Lead time: Claude's discretion (configurable per event type)

6. **checkForNudges(briefingData: BriefingData):**
   - Called periodically (every 5-15 minutes)
   - Check tasks with due dates approaching (within 1 hour)
   - Check bills due today
   - Check calendar events starting soon
   - Trigger nudge if conditions met and not already nudged

7. **Singleton pattern:**
```typescript
let instance: NudgeManager | null = null;
export function getNudgeManager(): NudgeManager {
  if (!instance) {
    instance = new NudgeManager();
  }
  return instance;
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit src/lib/jarvis/executive/NudgeManager.ts
```
Sound file exists:
```bash
ls public/sounds/gentle-chime.mp3
```
  </verify>
  <done>NudgeManager can play sounds, show visual indicator, and check for pending nudges</done>
</task>

<task type="auto">
  <name>Task 2: Create CheckInManager for midday and evening check-ins</name>
  <files>
    - src/lib/jarvis/executive/CheckInManager.ts
  </files>
  <action>
Create `src/lib/jarvis/executive/CheckInManager.ts`:

1. **CheckInManager class:**
   - Handles midday and evening check-in conversations
   - Uses VoicePipeline for speech
   - Tracks check-in state

2. **startMiddayCheckIn(voicePipeline, briefingData):**
   Per CONTEXT.md, midday check-in covers:
   - Progress review: "You've completed {N}/{M} tasks so far."
   - Reprioritization: "What's the priority for the afternoon?"
   - New captures: "Anything come up to add?"

   Flow:
   ```typescript
   async startMiddayCheckIn(pipeline: VoicePipeline, data: BriefingData): Promise<void> {
     const completed = data.tasks.today.filter(t => t.status === 'completed').length;
     const total = data.tasks.today.length;

     await pipeline.speak(
       `It's midday. You've completed ${completed} of ${total} tasks. ` +
       `What's the priority for the afternoon?`
     );
     // Wait for response and handle accordingly
   }
   ```

3. **startEveningCheckIn(voicePipeline, briefingData):**
   Per CONTEXT.md, evening check-in covers:
   - Day completion: "You completed {N} tasks today. {M} still pending."
   - Loose end capture: "Anything floating in your head to capture?"
   - Tomorrow preview: "Tomorrow you have..."
   - Goal/project review (if due per cadence)
   - Reprioritization

   Note: Per CONTEXT.md, review cadence system - items have review frequency property. For v1, check all items; v2 can respect cadence.

4. **handleCheckInResponse(response: string):**
   - Parse user intent
   - "Skip" / "Not now" -> end check-in
   - Task names -> update status
   - "Add X" -> create task
   - Questions -> respond

5. **Skip functionality:**
   Check-ins must be easily skippable (per CONTEXT.md). After initial prompt, listen for:
   - "Skip" / "Not now" / "Later"
   - Tap to dismiss
   - No response for 10 seconds -> auto-dismiss

6. **Integration with Scheduler:**
   The Scheduler triggers check-ins; CheckInManager handles the conversation flow.
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit src/lib/jarvis/executive/CheckInManager.ts
```
  </verify>
  <done>CheckInManager handles midday and evening check-in conversations</done>
</task>

<task type="auto">
  <name>Task 3: Create NudgeOverlay and wire everything to page</name>
  <files>
    - src/components/jarvis/NudgeOverlay.tsx
    - src/app/jarvis/page.tsx
  </files>
  <action>
**Create `src/components/jarvis/NudgeOverlay.tsx`:**

Visual nudge indicator - subtle overlay, NOT a modal (per CONTEXT.md pitfall).

```typescript
'use client';

import { useJarvisStore } from '@/lib/jarvis/stores/jarvisStore';

export function NudgeOverlay() {
  const { activeNudge, acknowledgeNudge } = useJarvisStore();

  if (!activeNudge) return null;

  return (
    <div
      className="fixed bottom-24 left-1/2 -translate-x-1/2
                 bg-black/70 backdrop-blur-md rounded-xl
                 px-6 py-4 border border-white/20
                 animate-fade-in-up pointer-events-auto z-30"
      onClick={acknowledgeNudge}
      role="alert"
      aria-live="polite"
    >
      <div className="flex items-center gap-3">
        {/* Pulse indicator */}
        <span className="h-2 w-2 rounded-full bg-amber-400 animate-pulse" />

        {/* Message */}
        <p className="text-white/90 text-sm">{activeNudge.message}</p>

        {/* Tap to respond hint */}
        <span className="text-white/50 text-xs">Tap orb to respond</span>
      </div>
    </div>
  );
}
```

Animation (add to globals.css if not exists):
```css
@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.animate-fade-in-up {
  animation: fade-in-up 0.3s ease-out;
}
```

**Update `src/app/jarvis/page.tsx`:**

1. Import and render NudgeOverlay:
```typescript
import { NudgeOverlay } from '@/components/jarvis/NudgeOverlay';
import { getNudgeManager } from '@/lib/jarvis/executive/NudgeManager';
import { CheckInManager } from '@/lib/jarvis/executive/CheckInManager';
```

2. Handle scheduled events for midday/evening:
```typescript
function handleScheduledEvent(event: ScheduledEvent) {
  switch (event.type) {
    case 'morning_briefing':
      startMorningBriefing();
      break;
    case 'midday_checkin':
      startMiddayCheckIn();
      break;
    case 'evening_checkin':
      startEveningCheckIn();
      break;
    case 'nudge':
      // Nudges are triggered by NudgeManager, not scheduler
      break;
  }
}
```

3. Set up periodic nudge checking (every 5 minutes):
```typescript
useEffect(() => {
  const nudgeInterval = setInterval(async () => {
    const data = await buildMorningBriefing();
    getNudgeManager().checkForNudges(data);
  }, 5 * 60 * 1000); // 5 minutes

  return () => clearInterval(nudgeInterval);
}, []);
```

4. Handle nudge acknowledgment -> voice engagement:
```typescript
// When user taps orb while nudge is active
function handleOrbTap() {
  const { activeNudge } = useJarvisStore.getState();

  if (activeNudge) {
    // User is engaging with nudge - speak the full message
    getNudgeManager().speakNudge(
      activeNudge.message,
      voicePipelineRef.current!
    );
    useJarvisStore.getState().acknowledgeNudge();
  } else {
    // Normal PTT behavior
    voicePipelineRef.current?.startListening();
  }
}
```

5. Render NudgeOverlay in the page:
```typescript
return (
  <div className="...">
    {/* Orb */}
    <JarvisOrb ... />

    {/* Nudge overlay */}
    <NudgeOverlay />

    {/* Other UI */}
  </div>
);
```

**Multimodal acknowledgment:**
Per CONTEXT.md, acknowledgment can be voice OR tap/text.
- Tap on overlay -> dismiss
- Tap on orb -> engage with voice
- Voice "okay" / "got it" -> dismiss (handled by VoicePipeline intent detection)
  </action>
  <verify>
1. `npm run dev`
2. Navigate to /jarvis
3. Trigger a test nudge: add `getNudgeManager().showVisualNudge({...})` in dev tools
4. Nudge overlay appears at bottom of screen
5. Tap overlay -> dismisses
6. Tap orb while nudge active -> Jarvis speaks the nudge
7. Check-ins can be triggered and skipped
  </verify>
  <done>NudgeOverlay shows visual indicator, check-ins work via scheduled triggers</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Nudge overlay appears when triggered
4. Gentle chime plays with nudge
5. Tap overlay dismisses it
6. Tap orb while nudge active speaks full message
7. Midday check-in asks about progress
8. Evening check-in prompts for status updates
9. "Skip" or silence dismisses check-ins
</verification>

<success_criteria>
- NudgeManager plays gentle sound + shows visual indicator
- Nudges only trigger for calendar, deadlines, bills (NOT breaks)
- Check-ins follow CONTEXT.md structure (progress, reprioritization, capture)
- Check-ins are easily skippable
- User can acknowledge via voice OR tap
- Visual nudge is subtle overlay, not blocking modal
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/05-executive-function-core/05-02-SUMMARY.md`
</output>
