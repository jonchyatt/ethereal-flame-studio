---
phase: 10-guardrails-safety
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/lib/jarvis/memory/memoryTools.ts
  - src/lib/jarvis/memory/toolExecutor.ts
  - src/lib/jarvis/memory/queries/dailyLogs.ts
  - src/lib/jarvis/intelligence/tools.ts
autonomous: true

must_haves:
  truths:
    - "User can ask 'what did you do?' and get recent action history"
    - "Audit log query returns human-readable action descriptions"
    - "Response includes timestamp and success/failure status"
  artifacts:
    - path: "src/lib/jarvis/memory/memoryTools.ts"
      provides: "query_audit_log tool definition"
      contains: "query_audit_log"
    - path: "src/lib/jarvis/memory/toolExecutor.ts"
      provides: "handleQueryAuditLog function"
      contains: "handleQueryAuditLog"
    - path: "src/lib/jarvis/memory/queries/dailyLogs.ts"
      provides: "getRecentToolInvocations query"
      exports: ["getRecentToolInvocations"]
  key_links:
    - from: "toolExecutor.ts"
      to: "dailyLogs.ts"
      via: "getRecentToolInvocations call"
      pattern: "getRecentToolInvocations"
---

<objective>
Add query_audit_log tool so users can ask "what did you do?" and get action history.

Purpose: Per CONTEXT.md, user can ask about recent actions and Jarvis explains from the log. This completes GUARD-02 by making audit logs queryable.

Output: New tool that returns recent tool invocations in human-readable format.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/10-guardrails-safety/10-CONTEXT.md
@jarvis/.planning/phases/10-guardrails-safety/10-RESEARCH.md

# Prior plan output
@jarvis/.planning/phases/10-guardrails-safety/10-01-SUMMARY.md

# Current implementation
@src/lib/jarvis/memory/memoryTools.ts
@src/lib/jarvis/memory/toolExecutor.ts
@src/lib/jarvis/memory/queries/dailyLogs.ts
@src/lib/jarvis/intelligence/tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getRecentToolInvocations query</name>
  <files>src/lib/jarvis/memory/queries/dailyLogs.ts</files>
  <action>
Add a query function to retrieve recent tool invocations:

```typescript
/**
 * Get recent tool invocations for "what did you do?" queries.
 *
 * @param limit - Maximum entries to return (default 10)
 * @param sessionId - Optional filter to specific session
 * @returns Array of tool invocations with parsed data
 */
export async function getRecentToolInvocations(
  limit = 10,
  sessionId?: number
): Promise<Array<{
  toolName: string;
  success: boolean;
  context?: string;
  error?: string;
  timestamp: string;
}>> {
  const query = db
    .select()
    .from(dailyLogs)
    .where(eq(dailyLogs.eventType, 'tool_invocation'))
    .orderBy(desc(dailyLogs.timestamp))
    .limit(limit);

  // Add session filter if provided
  const results = sessionId
    ? await db
        .select()
        .from(dailyLogs)
        .where(
          and(
            eq(dailyLogs.eventType, 'tool_invocation'),
            eq(dailyLogs.sessionId, sessionId)
          )
        )
        .orderBy(desc(dailyLogs.timestamp))
        .limit(limit)
    : await query;

  return results.map(log => {
    const data = parseEventData<ToolInvocationData>(log.eventData);
    return {
      toolName: data?.toolName || 'unknown',
      success: data?.success ?? false,
      context: data?.context,
      error: data?.error,
      timestamp: log.timestamp,
    };
  });
}
```

Also export the new function from the module.
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>getRecentToolInvocations function available in dailyLogs.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add query_audit_log tool definition</name>
  <files>src/lib/jarvis/memory/memoryTools.ts</files>
  <action>
Add the tool definition to the memoryTools array:

```typescript
{
  name: 'query_audit_log',
  description: 'Retrieve recent actions Jarvis has taken. Use when user asks "what did you do?", "what have you been doing?", or similar. Returns a list of recent tool invocations with timestamps.',
  input_schema: {
    type: 'object',
    properties: {
      limit: {
        type: 'number',
        description: 'Maximum number of actions to return (default: 10, max: 50)',
      },
    },
    required: [],
  },
},
```

Note: This goes in the memoryTools array, NOT as a separate tool definition file.
  </action>
  <verify>
Check that tools export includes the new tool:
```bash
grep -A5 "query_audit_log" src/lib/jarvis/memory/memoryTools.ts
```
  </verify>
  <done>query_audit_log tool definition added to memoryTools</done>
</task>

<task type="auto">
  <name>Task 3: Add handler in tool executor</name>
  <files>src/lib/jarvis/memory/toolExecutor.ts</files>
  <action>
1. Update MemoryToolName type to include the new tool:
```typescript
export type MemoryToolName =
  | 'remember_fact'
  | 'forget_fact'
  | 'list_memories'
  | 'delete_all_memories'
  | 'restore_memory'
  | 'observe_pattern'
  | 'query_audit_log';  // Add this
```

2. Import the query function:
```typescript
import { getRecentToolInvocations } from './queries/dailyLogs';
```

3. Add case in the switch statement:
```typescript
case 'query_audit_log':
  return handleQueryAuditLog(input);
```

4. Add the handler function:
```typescript
/**
 * Handle query_audit_log tool - return recent actions
 */
async function handleQueryAuditLog(
  input: Record<string, unknown>
): Promise<string> {
  const limit = Math.min(
    Math.max(1, (input.limit as number) || 10),
    50  // Cap at 50
  );

  const invocations = await getRecentToolInvocations(limit);

  if (invocations.length === 0) {
    return JSON.stringify({
      success: true,
      message: "I haven't taken any actions yet this session.",
      actions: [],
    });
  }

  // Format for natural speech
  const actionList = invocations.map(inv => {
    const status = inv.success ? 'succeeded' : 'failed';
    const time = new Date(inv.timestamp).toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
    });
    const detail = inv.context || inv.error || inv.toolName;
    return `${time}: ${detail} (${status})`;
  });

  return JSON.stringify({
    success: true,
    message: `Here are my recent ${invocations.length} action(s).`,
    actions: actionList,
    raw: invocations,  // Include raw data for detailed queries
  });
}
```

5. Update the memoryToolNames array in chat/route.ts to include 'query_audit_log'.
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>query_audit_log tool fully implemented and routed</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Start app and ask Jarvis "what did you do?"
3. Verify Claude calls query_audit_log tool and explains recent actions
4. Check that response is human-readable, not raw JSON
</verification>

<success_criteria>
- query_audit_log tool registered and callable
- Tool returns human-readable action history
- Timestamps formatted for speech ("10:30 AM: ...")
- Both successful and failed actions included
- Claude uses this tool when asked about recent activity
</success_criteria>

<output>
After completion, create `.planning/phases/10-guardrails-safety/10-02-SUMMARY.md`
</output>
