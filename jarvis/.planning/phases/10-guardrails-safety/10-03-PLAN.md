---
phase: 10-guardrails-safety
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/jarvis/executive/CheckInManager.ts
  - src/lib/jarvis/executive/BriefingBuilder.ts
autonomous: true

must_haves:
  truths:
    - "Items captured during check-ins are created as tasks in Notion"
    - "Evening check-in tomorrow preview shows real task data"
    - "Midday check-in captures also reach Notion inbox"
  artifacts:
    - path: "src/lib/jarvis/executive/CheckInManager.ts"
      provides: "Notion task creation for captured items"
      contains: "executeNotionTool.*create_task"
    - path: "src/lib/jarvis/executive/CheckInManager.ts"
      provides: "Real tomorrow data in evening preview"
      contains: "this.state.data.tomorrow"
    - path: "src/lib/jarvis/executive/BriefingBuilder.ts"
      provides: "Tomorrow task data in check-in data"
      contains: "queryNotionRaw.*tomorrow"
  key_links:
    - from: "CheckInManager.complete()"
      to: "executeNotionTool"
      via: "loop over capturedItems"
      pattern: "for.*capturedItems.*create_task"
    - from: "buildCheckInData('evening')"
      to: "tomorrow tasks"
      via: "queries tomorrow's tasks"
      pattern: "filter.*tomorrow"
---

<objective>
Fix two known bugs: captured items not reaching Notion inbox (FIX-01) and tomorrow preview showing placeholder data (FIX-02).

Purpose: These bugs were discovered during v1 and deferred to Phase 10. Check-in capture is useless if items don't persist, and tomorrow preview is misleading with placeholder data.

Output: Captured items create Notion tasks, and evening check-in shows real tomorrow data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/10-guardrails-safety/10-CONTEXT.md
@jarvis/.planning/phases/10-guardrails-safety/10-RESEARCH.md

# Bug locations (from RESEARCH.md)
@src/lib/jarvis/executive/CheckInManager.ts
@src/lib/jarvis/executive/BriefingBuilder.ts
@src/lib/jarvis/executive/EveningWrapFlow.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix FIX-01 - Send captured items to Notion</name>
  <files>src/lib/jarvis/executive/CheckInManager.ts</files>
  <action>
Replace the TODO comment in complete() with actual Notion task creation.

1. Import executeNotionTool at top of file:
```typescript
import { executeNotionTool } from '../notion/toolExecutor';
```

2. In the complete() method (around line 486), replace:
```typescript
// Log captured items
if (this.state.capturedItems.length > 0) {
  console.log('[CheckInManager] Captured items:', this.state.capturedItems);
  // Future: Send to Notion inbox
}
```

With:
```typescript
// Send captured items to Notion inbox
if (this.state.capturedItems.length > 0) {
  console.log('[CheckInManager] Sending captured items to Notion:', this.state.capturedItems);

  // Create tasks in parallel for efficiency
  const createPromises = this.state.capturedItems.map(async (item) => {
    try {
      const result = await executeNotionTool('create_task', { title: item });
      console.log(`[CheckInManager] Created task: "${item}"`, result);
      return { success: true, item };
    } catch (error) {
      console.error(`[CheckInManager] Failed to create task: "${item}"`, error);
      return { success: false, item, error };
    }
  });

  // Wait for all creates (don't block on failures)
  const results = await Promise.allSettled(createPromises);
  const succeeded = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
  console.log(`[CheckInManager] Created ${succeeded}/${this.state.capturedItems.length} tasks`);
}
```

3. Make the complete() method async since it now awaits:
```typescript
private async complete(): Promise<void> {
```

4. Update any callers of complete() to handle async (should already be in async context).
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>Captured items create tasks in Notion when check-in completes</done>
</task>

<task type="auto">
  <name>Task 2: Add tomorrow data to check-in builder</name>
  <files>src/lib/jarvis/executive/BriefingBuilder.ts</files>
  <action>
Update buildCheckInData to fetch tomorrow's tasks for evening check-ins.

1. Modify buildCheckInData function to optionally fetch tomorrow data:

```typescript
export async function buildCheckInData(type: CheckInType): Promise<{
  briefing: BriefingData;
  progress: CheckInProgress;
  tomorrow?: { tasks: TaskSummary[] };  // Add this
}> {
  console.log(`[BriefingBuilder] Building ${type} check-in data...`);

  // Get full briefing data
  const briefing = await buildMorningBriefing();

  // Calculate progress
  const [allTodayTasks, completedTodayTasks] = await Promise.all([
    queryNotionRaw('tasks', { filter: 'today', status: 'all' }),
    queryNotionRaw('tasks', { filter: 'today', status: 'completed' }),
  ]);

  const totalTasks = parseTaskResults(allTodayTasks);
  const completedTasks = parseTaskResults(completedTodayTasks);

  const progress: CheckInProgress = {
    tasksCompletedToday: completedTasks.length,
    totalTasksToday: totalTasks.length,
    overdueCount: briefing.tasks.overdue.length,
    newCaptures: [],
  };

  // For evening check-ins, also fetch tomorrow's tasks
  if (type === 'evening') {
    const tomorrowTasksResult = await queryNotionRaw('tasks', {
      filter: 'tomorrow',
      status: 'pending',
    });
    const tomorrowTasks = parseTaskResults(tomorrowTasksResult);

    return {
      briefing,
      progress,
      tomorrow: { tasks: tomorrowTasks },
    };
  }

  return { briefing, progress };
}
```

2. Ensure the types.ts file includes tomorrow in the return type (check if needed).
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>Evening check-in data includes tomorrow's tasks</done>
</task>

<task type="auto">
  <name>Task 3: Fix FIX-02 - Use real tomorrow data in CheckInManager</name>
  <files>src/lib/jarvis/executive/CheckInManager.ts</files>
  <action>
Update CheckInManager to use the real tomorrow data from buildCheckInData.

1. Update the CheckInState interface to include tomorrow data:
```typescript
interface CheckInState {
  type: CheckInType;
  phase: CheckInPhase;
  data: BriefingData | null;
  progress: CheckInProgress | null;
  tomorrow?: { tasks: TaskSummary[] };  // Add this
  isActive: boolean;
  isWaitingForResponse: boolean;
  capturedItems: string[];
}
```

2. In startEveningCheckIn, store the tomorrow data:
```typescript
// Fetch current data
const { briefing, progress, tomorrow } = await buildCheckInData('evening');
this.state.data = briefing;
this.state.progress = progress;
this.state.tomorrow = tomorrow;  // Add this
this.state.isActive = true;
```

3. Update getInitialState to include tomorrow:
```typescript
private getInitialState(type: CheckInType): CheckInState {
  return {
    type,
    phase: 'intro',
    data: null,
    progress: null,
    tomorrow: undefined,  // Add this
    isActive: false,
    isWaitingForResponse: false,
    capturedItems: [],
  };
}
```

4. Replace the buildTomorrowScript method with real data (around line 397):
```typescript
private buildTomorrowScript(): string {
  // Use real tomorrow data from evening check-in
  if (!this.state.tomorrow || this.state.tomorrow.tasks.length === 0) {
    return "Tomorrow's clear. No tasks scheduled. Anything to adjust?";
  }

  const tasks = this.state.tomorrow.tasks;
  const parts: string[] = [];

  // Task count and brief list (match EveningWrapFlow style)
  const titles = tasks.slice(0, 3).map(t => t.title).join(', ');
  parts.push(`Tomorrow you have ${tasks.length} task${tasks.length > 1 ? 's' : ''}: ${titles}.`);

  if (tasks.length > 3) {
    parts.push(`Plus ${tasks.length - 3} more.`);
  }

  // Check for high priority tasks
  const highPriority = tasks.filter(t => t.priority === 'High');
  if (highPriority.length > 0) {
    parts.push(`Note: ${highPriority[0].title} is high priority.`);
  }

  parts.push('Anything to adjust? Or say skip.');
  return parts.join(' ');
}
```

5. Import TaskSummary type if not already imported:
```typescript
import type { ..., TaskSummary } from './types';
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit -p . 2>&1 | head -20
```
  </verify>
  <done>Evening check-in tomorrow preview shows real task data</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Start evening check-in, say items to capture, complete the flow
3. Check Notion inbox for the captured tasks
4. Verify tomorrow preview mentions real tasks (or says "clear" if none)
</verification>

<success_criteria>
- Captured items appear as tasks in Notion after check-in completion
- Evening check-in tomorrow preview shows real task titles
- Both midday and evening captures work
- No regression in existing check-in functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-guardrails-safety/10-03-SUMMARY.md`
</output>
