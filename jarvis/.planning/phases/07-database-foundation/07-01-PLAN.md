---
phase: 07-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - drizzle.config.ts
  - .env.local
  - .env.example
autonomous: true
user_setup:
  - service: turso
    why: "Local development database server"
    env_vars: []
    dashboard_config:
      - task: "Install Turso CLI"
        location: "https://turso.tech/download (Windows) or brew install tursodatabase/tap/turso (macOS)"

must_haves:
  truths:
    - "Drizzle ORM and libsql client are installed"
    - "Drizzle Kit is available for schema management"
    - "Environment configuration distinguishes dev from production"
  artifacts:
    - path: "package.json"
      provides: "drizzle-orm, @libsql/client dependencies"
      contains: "drizzle-orm"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      exports: ["default"]
    - path: ".env.local"
      provides: "Local database URL"
      contains: "DATABASE_URL"
    - path: ".env.example"
      provides: "Environment template for production setup"
      contains: "DATABASE_URL"
  key_links:
    - from: "drizzle.config.ts"
      to: "process.env.DATABASE_URL"
      via: "dbCredentials.url"
      pattern: "process\\.env\\.DATABASE_URL"
---

<objective>
Install Drizzle ORM + @libsql/client and configure for both local development (turso dev) and production (Turso cloud).

Purpose: Establish the database tooling foundation that all subsequent memory system plans depend on.
Output: Working drizzle-kit commands, environment configuration for dev/prod.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/07-database-foundation/07-CONTEXT.md
@jarvis/.planning/phases/07-database-foundation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Drizzle ORM and libsql client</name>
  <files>package.json</files>
  <action>
    Install required packages:
    ```bash
    npm install drizzle-orm @libsql/client
    npm install -D drizzle-kit
    ```

    IMPORTANT: Remove better-sqlite3 if present - it does NOT work on Vercel serverless.
    If better-sqlite3 exists in dependencies, remove it:
    ```bash
    npm uninstall better-sqlite3 @types/better-sqlite3
    ```

    The @libsql/client replaces better-sqlite3 with an HTTP-based client that works in serverless.
  </action>
  <verify>
    Run: `npm ls drizzle-orm @libsql/client drizzle-kit`
    All three packages should appear in the dependency tree.

    Run: `npm ls better-sqlite3`
    Should return "empty" or not found (removed).
  </verify>
  <done>drizzle-orm, @libsql/client in dependencies; drizzle-kit in devDependencies; better-sqlite3 removed</done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle Kit configuration and environment files</name>
  <files>drizzle.config.ts, .env.local, .env.example, package.json</files>
  <action>
    Create drizzle.config.ts at project root:
    ```typescript
    import 'dotenv/config';
    import { defineConfig } from 'drizzle-kit';

    export default defineConfig({
      out: './drizzle',
      schema: './src/lib/jarvis/memory/schema.ts',
      dialect: 'turso',
      dbCredentials: {
        url: process.env.DATABASE_URL!,
        authToken: process.env.DATABASE_AUTH_TOKEN,
      },
    });
    ```

    Note: Using dialect: 'turso' (not 'sqlite' + driver: 'turso') per latest Drizzle docs.

    Create/update .env.local with:
    ```
    # Database - Local development (turso dev)
    DATABASE_URL=http://127.0.0.1:8080
    # No DATABASE_AUTH_TOKEN needed for local
    ```

    Create .env.example as template:
    ```
    # Database
    # Local: http://127.0.0.1:8080 (via turso dev)
    # Production: libsql://jarvis-[account].turso.io
    DATABASE_URL=
    DATABASE_AUTH_TOKEN=
    ```

    Add npm scripts to package.json:
    ```json
    "db:generate": "drizzle-kit generate",
    "db:push": "drizzle-kit push",
    "db:migrate": "drizzle-kit migrate",
    "db:studio": "drizzle-kit studio",
    "turso:dev": "turso dev --db-file ./jarvis.db"
    ```
  </action>
  <verify>
    Run: `cat drizzle.config.ts`
    Should show defineConfig with dialect: 'turso' and schema path.

    Run: `npm run db:generate --help 2>&1 || echo "Script exists"`
    Script should be recognized (may error due to missing schema, that's OK).
  </verify>
  <done>drizzle.config.ts exists with correct dialect; .env.local has DATABASE_URL; .env.example documented; npm scripts added</done>
</task>

<task type="auto">
  <name>Task 3: Verify local database connectivity</name>
  <files>None (verification only)</files>
  <action>
    Test that the turso dev server can start:

    1. If Turso CLI not installed, skip this task with note for user
    2. If installed, run: `turso dev --db-file ./jarvis.db` (in background)
    3. Verify server responds on http://127.0.0.1:8080
    4. Kill the server after verification

    If Turso CLI not available, document that user needs to install it:
    - Windows: Download from https://turso.tech/download
    - macOS: brew install tursodatabase/tap/turso

    This task succeeds even if Turso CLI is not installed - just note it in summary.
  </action>
  <verify>
    Check if turso CLI is available: `turso --version`
    If available: Confirm server starts on port 8080
    If not available: Note in summary that user should install Turso CLI
  </verify>
  <done>Either turso dev works OR documented that CLI needs installation</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm ls drizzle-orm @libsql/client` shows both packages
2. `drizzle.config.ts` exists at project root
3. `.env.local` contains DATABASE_URL=http://127.0.0.1:8080
4. `npm run db:push` is a valid command (may fail due to missing schema - OK)
</verification>

<success_criteria>
- Drizzle ORM v0.45+ and @libsql/client v0.17+ installed
- better-sqlite3 removed from dependencies
- drizzle.config.ts configured for turso dialect
- Environment files distinguish local dev from production
- npm scripts for database management added
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/07-database-foundation/07-01-SUMMARY.md`
</output>
