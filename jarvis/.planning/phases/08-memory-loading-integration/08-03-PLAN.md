---
phase: 08-memory-loading-integration
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/lib/jarvis/memory/retrieval.ts
  - src/lib/jarvis/intelligence/systemPrompt.ts
  - src/app/api/jarvis/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "Jarvis proactively surfaces relevant memories in context"
    - "Pending tasks/follow-ups mentioned at session start"
    - "Relevant memories surfaced when topic comes up mid-conversation"
    - "No emotional check-ins or unsolicited advice (per CONTEXT.md)"
  artifacts:
    - path: "src/lib/jarvis/memory/retrieval.ts"
      provides: "Enhanced retrieval with proactive surfacing logic"
      exports: ["getProactiveSurfacing", "ProactiveSurfacing"]
    - path: "src/lib/jarvis/intelligence/systemPrompt.ts"
      provides: "System prompt with proactive surfacing guidance"
      contains: "PROACTIVE SURFACING"
  key_links:
    - from: "src/app/api/jarvis/chat/route.ts"
      to: "src/lib/jarvis/memory/retrieval.ts"
      via: "getProactiveSurfacing call"
      pattern: "getProactiveSurfacing"
---

<objective>
Add proactive memory surfacing so Jarvis mentions relevant context at conversation start and during relevant topics.

Purpose: Satisfy MEM-11 (proactively surface relevant memories in context). Users experience an assistant that remembers what matters without being asked.

Output: Enhanced retrieval with proactive surfacing detection, updated system prompt guidance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/phases/08-memory-loading-integration/08-CONTEXT.md
@jarvis/.planning/phases/08-memory-loading-integration/08-02-SUMMARY.md
@src/lib/jarvis/memory/retrieval.ts
@src/lib/jarvis/intelligence/systemPrompt.ts
@src/app/api/jarvis/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add proactive surfacing detection to retrieval</name>
  <files>src/lib/jarvis/memory/retrieval.ts</files>
  <action>
Add proactive surfacing logic to `src/lib/jarvis/memory/retrieval.ts`:

1. **Add types:**
```typescript
export interface ProactiveSurfacing {
  /** Pending tasks/follow-ups to mention at session start */
  pendingItems: ScoredMemory[];
  /** Facts likely relevant to current context */
  contextualFacts: ScoredMemory[];
}
```

2. **Add surfacing detection function:**
```typescript
/**
 * Identify memories that should be proactively surfaced.
 *
 * Per CONTEXT.md decisions:
 * - YES: Task follow-ups (things user committed to do)
 * - YES: Work/factual context (projects, people, blockers)
 * - NO: Emotional check-ins ("How did the scary thing go?")
 * - NO: Unsolicited lifestyle advice ("You should exercise")
 *
 * @param memories - All retrieved memories
 * @param currentTime - For time-aware surfacing
 * @returns Categorized memories for proactive surfacing
 */
export function getProactiveSurfacing(
  memories: ScoredMemory[],
  currentTime: Date = new Date()
): ProactiveSurfacing {
  // Pending items: recently accessed "fact" category items with action-oriented content
  const pendingItems = memories.filter(m => {
    const content = m.content.toLowerCase();
    // Look for action-oriented content
    const hasActionIntent = (
      content.includes('follow up') ||
      content.includes('remind') ||
      content.includes('pending') ||
      content.includes('waiting') ||
      content.includes('need to') ||
      content.includes('should') ||
      content.includes('want to') ||
      content.includes('deadline')
    );
    // Recent (accessed within last 3 days)
    const isRecent = m.age === 'today' || m.age === 'yesterday' || m.age.includes('2 days') || m.age.includes('3 days');
    return hasActionIntent && isRecent;
  });

  // Contextual facts: high-score memories that aren't pending items
  const contextualFacts = memories
    .filter(m => !pendingItems.includes(m))
    .filter(m => m.score >= 50) // Only high-relevance items
    .slice(0, 3); // Max 3 contextual facts

  return {
    pendingItems: pendingItems.slice(0, 5), // Max 5 pending items
    contextualFacts,
  };
}
```

3. **Add format function for proactive surfacing:**
```typescript
/**
 * Format proactive surfacing for system prompt injection.
 *
 * @param surfacing - Categorized memories
 * @returns Formatted string for system prompt, or empty if nothing to surface
 */
export function formatProactiveSurfacing(surfacing: ProactiveSurfacing): string {
  const sections: string[] = [];

  if (surfacing.pendingItems.length > 0) {
    sections.push('Pending follow-ups (mention at session start):');
    for (const item of surfacing.pendingItems) {
      sections.push(`- ${item.content} (${item.age})`);
    }
  }

  if (surfacing.contextualFacts.length > 0) {
    sections.push('\nRelevant context (surface when topic comes up):');
    for (const item of surfacing.contextualFacts) {
      sections.push(`- ${item.content}`);
    }
  }

  return sections.join('\n');
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
`getProactiveSurfacing()` categorizes memories into pending items and contextual facts for proactive mention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add proactive surfacing guidance to system prompt</name>
  <files>src/lib/jarvis/intelligence/systemPrompt.ts</files>
  <action>
Enhance `src/lib/jarvis/intelligence/systemPrompt.ts` to include proactive surfacing guidance:

1. Update `SystemPromptContext` interface:
```typescript
export interface SystemPromptContext {
  currentTime: Date;
  userName?: string;
  keyFacts?: string[];
  memoryContext?: string;
  /** Proactive surfacing guidance (Phase 8) */
  proactiveSurfacing?: string;
}
```

2. Add proactive surfacing section in `buildSystemPrompt()`:

After the MEMORY CONTEXT section (if it exists), add:
```typescript
// Add proactive surfacing guidance if provided
if (context.proactiveSurfacing) {
  sections.push(`PROACTIVE SURFACING:
When conversation begins or topic shifts, naturally mention relevant context:

${context.proactiveSurfacing}

Guidelines:
- At session start: Briefly mention 1-2 pending items ("Quick reminder: you wanted to follow up on that invoice")
- When relevant topic comes up: Surface related context ("When you talked to Sarah last week, you were waiting on her approval")
- Batch multiple items: "Quick hits: invoice follow-up, and Sarah's waiting on that doc"
- DO NOT ask emotional check-ins: "How did the presentation go?"
- DO NOT give unsolicited advice: "You should exercise more"
- Be brief and task-focused, not intrusive`);
}
```

This adds concrete guidance on WHAT to surface and HOW to surface it, per CONTEXT.md decisions.
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
System prompt includes proactive surfacing guidance with specific items to mention and behavior guidelines.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate proactive surfacing into chat API</name>
  <files>src/app/api/jarvis/chat/route.ts</files>
  <action>
Modify `src/app/api/jarvis/chat/route.ts` to include proactive surfacing:

1. Add imports:
```typescript
import {
  retrieveMemories,
  formatMemoriesForPrompt,
  getProactiveSurfacing,
  formatProactiveSurfacing,
} from '@/lib/jarvis/memory';
```

2. After loading memories, generate proactive surfacing:
```typescript
// Load memory context if enabled
let memoryContext = '';
let proactiveSurfacing = '';
const config = getJarvisConfig();

if (config.enableMemoryLoading) {
  try {
    const memories = await retrieveMemories({
      maxTokens: config.memoryTokenBudget,
      maxEntries: config.maxMemories,
    });
    memoryContext = formatMemoriesForPrompt(memories);

    // Generate proactive surfacing guidance
    const surfacing = getProactiveSurfacing(memories.entries);
    proactiveSurfacing = formatProactiveSurfacing(surfacing);

    console.log(`[Chat] Loaded ${memories.entries.length} memories, ${surfacing.pendingItems.length} pending items`);
  } catch (error) {
    console.error('[Chat] Memory loading failed, continuing without:', error);
  }
}
```

3. Include proactive surfacing in the system prompt:
```typescript
// Combine system prompt with memory context and proactive surfacing
let effectiveSystemPrompt = systemPrompt;
if (memoryContext) {
  effectiveSystemPrompt += `\n\n${memoryContext}`;
}
if (proactiveSurfacing) {
  effectiveSystemPrompt += `\n\n${proactiveSurfacing}`;
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
Chat API generates proactive surfacing guidance and includes it in system prompt alongside memory context.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Proactive surfacing works: With JARVIS_ENABLE_MEMORY=true, console shows pending items count
3. No emotional check-ins: System prompt guidance explicitly prohibits them
4. Session start surfacing: First message after enabling memory shows relevant follow-ups
</verification>

<success_criteria>
- `getProactiveSurfacing()` identifies pending items and contextual facts
- Pending items detected by action-oriented keywords (follow up, remind, pending, etc.)
- System prompt includes specific guidance on WHAT to surface and WHEN
- No emotional check-ins or unsolicited advice (per CONTEXT.md core philosophy)
- Batch format for multiple items ("Quick hits: X, and Y")
- Graceful degradation if no memories to surface
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/08-memory-loading-integration/08-03-SUMMARY.md`
</output>
