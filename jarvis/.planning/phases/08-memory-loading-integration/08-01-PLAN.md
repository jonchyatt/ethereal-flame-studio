---
phase: 08-memory-loading-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/jarvis/memory/retrieval.ts
  - src/lib/jarvis/memory/index.ts
autonomous: true

must_haves:
  truths:
    - "Memory entries can be retrieved with relevance scoring"
    - "Retrieval respects token budget (~1000 tokens max)"
    - "Time-aware selection prioritizes recent and important memories"
  artifacts:
    - path: "src/lib/jarvis/memory/retrieval.ts"
      provides: "Memory retrieval with scoring and token budgeting"
      exports: ["retrieveMemories", "formatMemoriesForPrompt", "MemoryContext"]
  key_links:
    - from: "src/lib/jarvis/memory/retrieval.ts"
      to: "src/lib/jarvis/memory/queries/memoryEntries.ts"
      via: "getMemoryEntries import"
      pattern: "import.*getMemoryEntries"
---

<objective>
Create a memory retrieval service that fetches relevant memories from the database with time-aware scoring and token budgeting.

Purpose: Enable Jarvis to selectively load relevant context at session start without overflowing the context window. This provides the foundation for MEM-06 (load memory context at session start).

Output: `src/lib/jarvis/memory/retrieval.ts` with functions for fetching, scoring, and formatting memories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@jarvis/.planning/PROJECT.md
@jarvis/.planning/ROADMAP.md
@jarvis/.planning/STATE.md
@jarvis/.planning/phases/08-memory-loading-integration/08-CONTEXT.md
@jarvis/.planning/phases/07-database-foundation/07-03-SUMMARY.md
@src/lib/jarvis/memory/index.ts
@src/lib/jarvis/memory/queries/memoryEntries.ts
@src/lib/jarvis/memory/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create memory retrieval module with scoring and token budgeting</name>
  <files>src/lib/jarvis/memory/retrieval.ts</files>
  <action>
Create `src/lib/jarvis/memory/retrieval.ts` with:

1. **Types:**
   ```typescript
   export interface MemoryContext {
     entries: ScoredMemory[];
     totalTokens: number;
     truncated: boolean;
   }

   interface ScoredMemory {
     id: number;
     content: string;
     category: string;
     source: string;
     score: number;
     age: string; // "today", "yesterday", "2 days ago", "1 week ago", etc.
   }
   ```

2. **Scoring function `scoreMemory(entry, currentTime)`:**
   - Recency score (0-50 points): Higher for recently accessed/created memories
     - Today: 50 points
     - Yesterday: 40 points
     - This week: 30 points
     - This month: 15 points
     - Older: 5 points
   - Category score (0-30 points):
     - "preference": 30 points (user explicitly told Jarvis)
     - "fact": 20 points (important facts)
     - "pattern": 10 points (inferred patterns)
   - Source score (0-20 points):
     - "user_explicit": 20 points
     - "jarvis_inferred": 10 points

3. **Age formatting function `formatAge(date, now)`:**
   - Returns human-readable age: "today", "yesterday", "3 days ago", "1 week ago", "2 weeks ago", "1 month ago", etc.

4. **Token estimation `estimateTokens(text)`:**
   - Simple heuristic: ~4 characters per token (conservative estimate)
   - Returns Math.ceil(text.length / 4)

5. **Main retrieval function `retrieveMemories(options)`:**
   ```typescript
   export async function retrieveMemories(options?: {
     maxTokens?: number;  // Default: 1000
     maxEntries?: number; // Default: 10
     currentTime?: Date;  // Default: new Date()
   }): Promise<MemoryContext>
   ```
   - Fetch all memory entries using `getMemoryEntries()`
   - Score each entry
   - Sort by score descending
   - Take top entries until token budget exhausted
   - Return MemoryContext with scored entries and metadata

6. **Format function `formatMemoriesForPrompt(context)`:**
   - Returns formatted string for injection into system prompt
   - Format per CONTEXT.md decisions:
     ```
     User context:
     - Schedule: Therapy Thursdays 3pm with Dr. Chen (2 weeks ago, you told me)
     - Preference: Brief responses (inferred, 3 days ago)
     ```
   - Include age and source (user_explicit = "you told me", jarvis_inferred = "inferred")
   - Returns empty string if no memories
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
`retrieval.ts` exports `retrieveMemories`, `formatMemoriesForPrompt`, `MemoryContext` type. Scoring prioritizes recent user-explicit preferences.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export retrieval functions from memory module</name>
  <files>src/lib/jarvis/memory/index.ts</files>
  <action>
Update `src/lib/jarvis/memory/index.ts` to re-export the new retrieval module:

Add after the existing exports:
```typescript
// Re-export retrieval functions
export * from './retrieval';
```

This makes retrieval available via:
```typescript
import { retrieveMemories, formatMemoriesForPrompt } from '@/lib/jarvis/memory';
```
  </action>
  <verify>
TypeScript compiles and retrieval functions are accessible:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
Memory retrieval functions exported from main memory module index.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for retrieval scoring</name>
  <files>src/lib/jarvis/memory/__tests__/retrieval.test.ts</files>
  <action>
Create `src/lib/jarvis/memory/__tests__/retrieval.test.ts` with tests for:

1. **Score calculation:**
   - Test recency scoring for different ages
   - Test category scoring for preference/fact/pattern
   - Test source scoring for user_explicit/jarvis_inferred
   - Combined scoring produces expected rankings

2. **Age formatting:**
   - "today" for same day
   - "yesterday" for 1 day ago
   - "3 days ago" for 3 days
   - "1 week ago" for 7 days
   - "2 weeks ago" for 14 days
   - "1 month ago" for 30 days

3. **Token budgeting:**
   - Respects maxTokens limit
   - Truncates when necessary
   - truncated flag set correctly

4. **Format for prompt:**
   - Empty array returns empty string
   - Entries formatted with age and source
   - Source mapped correctly ("you told me" vs "inferred")

Use mock data, no actual database calls needed for pure function tests.
  </action>
  <verify>
Tests pass:
```bash
npm test -- --testPathPattern=retrieval
```
  </verify>
  <done>
Unit tests verify scoring algorithm, age formatting, token budgeting, and prompt formatting work correctly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Tests pass: `npm test -- --testPathPattern=retrieval`
3. Exports work: Import { retrieveMemories } from '@/lib/jarvis/memory' resolves
</verification>

<success_criteria>
- `retrieveMemories()` fetches and scores memories with configurable token budget
- `formatMemoriesForPrompt()` outputs human-readable context matching CONTEXT.md format
- Scoring prioritizes: recent > old, user_explicit > inferred, preference > fact > pattern
- Token budget of 1000 respected by default
- Unit tests verify core logic
</success_criteria>

<output>
After completion, create `jarvis/.planning/phases/08-memory-loading-integration/08-01-SUMMARY.md`
</output>
