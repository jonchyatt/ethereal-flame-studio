# =============================================================================
# Redis Configuration for Ethereal Flame Studio
# =============================================================================
# Production-optimized configuration for BullMQ job queue
# =============================================================================

# -----------------------------------------------------------------------------
# NETWORK
# -----------------------------------------------------------------------------
# Bind to all interfaces (container network)
bind 0.0.0.0

# Default port
port 6379

# TCP keepalive (detect dead connections)
tcp-keepalive 300

# Timeout for idle connections (0 = no timeout)
timeout 0

# -----------------------------------------------------------------------------
# MEMORY MANAGEMENT
# -----------------------------------------------------------------------------
# CRITICAL: BullMQ requires noeviction policy
# If eviction is enabled, job data can be lost causing queue corruption
maxmemory-policy noeviction

# Maximum memory (adjust based on expected queue size)
# 256MB is sufficient for most workloads
# Increase if you have many concurrent jobs or large job payloads
maxmemory 256mb

# -----------------------------------------------------------------------------
# PERSISTENCE - RDB (Snapshotting)
# -----------------------------------------------------------------------------
# Save snapshot to disk periodically
# Format: save <seconds> <changes>
# Save after 900 seconds if at least 1 key changed
save 900 1
# Save after 300 seconds if at least 10 keys changed
save 300 10
# Save after 60 seconds if at least 10000 keys changed
save 60 10000

# Stop accepting writes if RDB save fails
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum for integrity
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# -----------------------------------------------------------------------------
# PERSISTENCE - AOF (Append Only File)
# -----------------------------------------------------------------------------
# Enable AOF for better durability
# AOF logs every write operation
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Sync strategy:
# - always: Most durable, slowest (every write synced)
# - everysec: Good balance (sync every second) [RECOMMENDED]
# - no: Fastest, relies on OS (data loss possible)
appendfsync everysec

# Disable fsync during background rewrites
# This improves performance but slightly reduces durability
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows too large
# Rewrite when AOF is 100% larger than last rewrite
auto-aof-rewrite-percentage 100
# Minimum size to trigger rewrite (avoid tiny AOF rewrites)
auto-aof-rewrite-min-size 64mb

# Load truncated AOF on startup (yes = start anyway, no = refuse)
aof-load-truncated yes

# Enable RDB preamble in AOF for faster loading
aof-use-rdb-preamble yes

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (Docker logs)
logfile ""

# -----------------------------------------------------------------------------
# SLOW LOG
# -----------------------------------------------------------------------------
# Log queries slower than 10000 microseconds (10ms)
slowlog-log-slower-than 10000

# Keep 128 slow log entries
slowlog-max-len 128

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------
# Disable dangerous commands in production
# These can cause data loss or security issues
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_a1b2c3d4"

# Password protection (set via environment variable or here)
# Uncomment and set if not using REDIS_PASSWORD env var:
# requirepass your_redis_password_here

# -----------------------------------------------------------------------------
# CLIENTS
# -----------------------------------------------------------------------------
# Maximum number of connected clients
maxclients 100

# -----------------------------------------------------------------------------
# MEMORY OPTIMIZATION
# -----------------------------------------------------------------------------
# Use memory-efficient encoding for small data structures
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Active defragmentation (helps with memory fragmentation)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100

# -----------------------------------------------------------------------------
# LAZY FREEING
# -----------------------------------------------------------------------------
# Use lazy freeing to avoid blocking on large key deletions
lazyfree-lazy-eviction no
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
